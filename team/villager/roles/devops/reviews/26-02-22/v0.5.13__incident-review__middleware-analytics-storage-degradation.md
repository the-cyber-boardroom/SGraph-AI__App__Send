# v0.5.13 — Incident Review: Middleware__Analytics Storage Degradation

**Role:** Villager DevOps
**Date:** 2026-02-22
**Severity:** High
**Status:** Mitigated — redesign required before re-enabling

---

## Summary

`Middleware__Analytics` (a FastAPI `BaseHTTPMiddleware`) created a full temporal cache entry for every HTTP request. Each entry produced 5 files in the `analytics` namespace. Under normal traffic this caused **65,400+ files** to accumulate, degrading all storage operations across both lambdas. Admin UI page load regressed from ~224ms to multi-second response times.

## Root Cause

The middleware calls `send_cache_client.analytics__record_event(event_data)` on every request. The cache client's write path creates a full temporal cache entry per call:

- `{event_id}.json` — event payload
- `{event_id}.json.config` — cache configuration
- `{event_id}.metadata` — metadata envelope
- Plus index/listing files

This is the correct pattern for infrequent, high-value data (transfer records), but completely wrong for high-frequency analytics events. The result is **O(5N)** file operations where N = total HTTP requests.

**Affected files:**
- `sgraph_ai_app_send/lambda__admin/service/Middleware__Analytics.py` (the middleware)
- `sgraph_ai_app_send/lambda__admin/fast_api/Fast_API__SGraph__App__Send__Admin.py` (admin registration)
- `sgraph_ai_app_send/lambda__user/fast_api/Fast_API__SGraph__App__Send__User.py` (user registration)

## Mitigation Applied (v0.5.13)

1. **Middleware disabled** — commented out `add_middleware(Middleware__Analytics, ...)` on both admin and user lambdas
2. **Data preserved** — 2,251 objects (955.6 KB) moved from analytics namespace to separate S3 bucket for later analysis
3. **Result** — Admin UI loads in 224ms, storage operations back to normal

## Risk Register

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Middleware re-enabled without redesign | Medium | High — same degradation recurs within hours | Bug-1 filed in Issues FS, code comments explain the problem |
| Analytics data gap while middleware is disabled | Certain | Low — CloudWatch metrics and access logs still active | Acceptable trade-off until redesign is complete |
| Accumulated analytics data in separate bucket not analysed | Low | Low — data is preserved and available when needed | Schedule analysis as Explorer task |

## Redesign Requirements (Explorer Team)

Before analytics middleware can be re-enabled, the Explorer team must redesign the recording strategy. Options:

1. **Append-to-file** — single JSONL file per time window, append one line per event
2. **Batched writes** — buffer N events in memory, flush as single cache entry
3. **Aggregation** — compute counters/histograms in memory, write summary periodically
4. **External sink** — write to CloudWatch Logs or a dedicated analytics service

The key constraint: **never create multiple cache files per HTTP request**.

## Issues FS Reference

- **Bug-1:** `.issues/issues/Project-1/issues/Phase-1/issues/Feature-5/issues/Bug-1/issue.json`
- **Feature-5:** Status & Analytics (parent feature)

## Timeline

| When | What |
|------|------|
| Pre-v0.5.13 | Middleware active, silently accumulating files |
| 2026-02-22 | Root cause identified — 65k files in analytics namespace |
| 2026-02-22 | Data moved to separate S3 bucket, middleware disabled |
| 2026-02-22 | Admin UI confirmed at 224ms page load |
| TBD | Explorer redesigns analytics recording pattern |
| TBD | Villager re-enables middleware after Explorer delivers new version |
