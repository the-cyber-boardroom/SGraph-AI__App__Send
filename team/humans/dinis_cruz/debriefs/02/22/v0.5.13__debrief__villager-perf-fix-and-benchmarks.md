# Debrief: v0.5.13 — Villager Performance Fix & Benchmarks — 22 Feb 2026

**Version:** v0.5.13
**Date:** 22 February 2026
**Team:** Villager
**Branch:** `claude/start-villager-session-geFCw`
**Session:** `session_01QfrWPBwntnfHNRjYY3Aux8`

---

## Executive Summary

This session identified and mitigated a **critical performance degradation** caused by `Middleware__Analytics`, and established the first **zoomed-in performance benchmarks** for the admin lambda. Admin UI page load dropped from multi-second to **224ms** after the fix.

Three commits, 6 files changed, 329 lines added.

---

## What Was Delivered

### 1. Zoomed-In Performance Benchmarks (Admin Lambda)

**File:** [`tests/unit/lambda__admin/test__performance__admin_lambda__zoomed_in.py`](../../../../../../tests/unit/lambda__admin/test__performance__admin_lambda__zoomed_in.py)

Four levels of performance measurement for the admin lambda stack:

| Level | What It Measures | Key Benchmarks |
|-------|-----------------|----------------|
| **L1 — Atomic** | Individual functions: `classify_event_type`, `hash_ip`, `normalise_user_agent` | < 1ms each |
| **L2 — Component** | Service construction: `Send__Cache__Client`, `Service__Tokens`, `Service__Keys` | < 50ms each |
| **L3 — Integration** | Full FastAPI app setup: `Fast_API__SGraph__App__Send__Admin().setup()` | < 200ms |
| **L4 — Request** | HTTP round-trip: health, info, pulse endpoints via TestClient | < 100ms per request |

208 lines of benchmark tests. All passing. Establishes baselines for regression detection.

### 2. Middleware__Analytics Performance Fix

**Root cause:** `Middleware__Analytics` called `send_cache_client.analytics__record_event()` on every HTTP request. Each call created **5 cache files** (`.json`, `.json.config`, `.metadata`, etc.). Under normal traffic this produced **65,400+ files** in the analytics namespace, degrading all storage operations.

**Fix applied:**
- Middleware commented out on both lambdas — [`Fast_API__SGraph__App__Send__Admin.py:77-79`](../../../../../../sgraph_ai_app_send/lambda__admin/fast_api/Fast_API__SGraph__App__Send__Admin.py)  and [`Fast_API__SGraph__App__Send__User.py:68-70`](../../../../../../sgraph_ai_app_send/lambda__user/fast_api/Fast_API__SGraph__App__Send__User.py)
- Analytics data (2,251 objects, 955.6 KB) preserved in separate S3 bucket for later analysis
- Admin UI page load confirmed at **224ms**

**The middleware class itself is NOT deleted** — it stays at `sgraph_ai_app_send/lambda__admin/service/Middleware__Analytics.py` for the Explorer team to redesign.

### 3. Documentation & Risk Tracking

**Bug issue (Issues FS):** [`.issues/issues/Project-1/issues/Phase-1/issues/Feature-5/issues/Bug-1/issue.json`](../../../../../../.issues/issues/Project-1/issues/Phase-1/issues/Feature-5/issues/Bug-1/issue.json)
- Status: `confirmed`, Priority: P1, Severity: high
- Links: `relates-to` Feature-5 (Status & Analytics), `blocks` Task-2 (sender status page)
- `redesign_required: true`, assigned to Explorer Team

**DevOps incident review:** [`team/villager/roles/devops/reviews/26-02-22/v0.5.13__incident-review__middleware-analytics-storage-degradation.md`](../../../../../../team/villager/roles/devops/reviews/26-02-22/v0.5.13__incident-review__middleware-analytics-storage-degradation.md)
- Full root cause analysis
- Risk register (3 risks with likelihood/impact/mitigation)
- Four redesign options for Explorer team
- Timeline from pre-incident through future re-enablement

---

## Commits (3)

| # | SHA | Message |
|---|-----|---------|
| 1 | `e2add66` | Add zoomed-in performance benchmarks for admin lambda (4 levels) |
| 2 | `1f9c0ad` | Disable Middleware__Analytics on both lambdas (root cause of perf issue) |
| 3 | `17cadbd` | Document Middleware__Analytics storage degradation: bug issue + devops review |

---

## Key Risks (for next session)

| Risk | Status | Action Required |
|------|--------|-----------------|
| Middleware__Analytics re-enabled without redesign | Mitigated by code comments + Bug-1 + incident review | Explorer must redesign before Villager re-enables |
| Analytics data gap while middleware is off | Accepted | CloudWatch metrics and access logs still active |
| No performance regression gate in CI | Open | Consider adding benchmark tests to CI pipeline |

---

## Handoff Notes for Next Session

1. **Test baseline:** 183 unit tests passing (including the new benchmarks)
2. **Middleware__Analytics is OFF** on both lambdas — do not re-enable without a redesign from Explorer
3. **Bug-1 blocks Task-2** (sender status page under Feature-5) — analytics UI can't be built until recording works
4. **Performance benchmarks are in place** — any new middleware or service can be measured against these baselines
5. **Architecture context diagram in `.claude/villager/CLAUDE.md`** still shows `Middleware__Analytics (raw events)` — update this when the redesign lands

---

## What's Next

- **Data room** — new task, next session focus
- **Explorer team:** Redesign analytics recording (append/batch/aggregate instead of cache-entry-per-event)
- **Villager team:** Add benchmark tests to CI pipeline for regression detection
- **Villager team:** Update architecture context diagram when middleware redesign lands

---

*Debrief complete. Version v0.5.13: performance benchmarks, middleware fix, incident documentation. All links are relative.*
