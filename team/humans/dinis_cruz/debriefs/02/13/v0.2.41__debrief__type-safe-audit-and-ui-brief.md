# Debrief: Type_Safe Audit & UI Token Integration Brief

**Version:** v0.2.41
**Date:** 2026-02-13
**Session:** Type_Safe/FastAPI review, domain primitive migration, UI architecture planning

---

## Executive Summary

This session completed a full audit and fix of Type_Safe usage across the entire codebase (12 files, 90+ issues), set the default token `usage_limit` to 50, and produced a comprehensive Dev brief for the next major milestone: UI token integration via the OSBot-Fast-API Service Registry.

---

## What Was Delivered

### 1. Type_Safe/FastAPI Fixes (commit `71ceb0d`)

**12 files changed, 91 tests passing:**

| Category | Change | Files |
|----------|--------|-------|
| Default usage_limit | `0` → `50` | `Schema__Token__Create__Request`, `Schema__Token__Metadata` |
| Identifiers | `str` → `Safe_Str__Id` | All schemas with token_name, transfer_id, status, event_id, action |
| IP hashes | `str` → `Safe_Str__Cache_Hash` | Event, Transparency, Analytics schemas |
| URL paths | `str` → `Safe_Str__File__Path` | Transfer, Analytics schemas |
| MIME types | `str` → `Safe_Str__Http__Content_Type` | `Schema__Transfer__Create` |
| User agents | `str` → `Safe_Str__Http__User_Agent` | `Schema__Transfer__Event` |
| Sizes | `int` → `Safe_UInt__FileSize` | All schemas with file_size_bytes |
| Counters | `int` → `Safe_UInt` | Analytics, Token, Transfer schemas |
| Route params | `str` → `Safe_Str__Id` | `Routes__Transfers` (4 endpoints) |
| Query params | `int` → `Safe_UInt` | `Routes__Analytics`, Admin FastAPI setup |
| Service class | plain class → extends `Type_Safe` | `Service__Tokens` |

### 2. UI Dev Brief (commit `575f9ce`)

Full implementation plan at:
- [`team/roles/dev/briefs/v0.2.41__dev-brief__ui-token-integration-and-service-registry.md`](../../../roles/dev/briefs/v0.2.41__dev-brief__ui-token-integration-and-service-registry.md)

---

## Lessons Learned

### 1. Safe_Str types have aggressive sanitization — know your character sets

The biggest gotcha was discovering that `Safe_Str__Id` strips `/`, `:`, `+` and other special characters. This matters because:

| Data type | Contains | Wrong type | Right type |
|-----------|----------|------------|------------|
| MIME types | `/` | `Safe_Str__Id` | `Safe_Str__Http__Content_Type` |
| URL paths | `/` | `Safe_Str__Id` | `Safe_Str__File__Path` |
| ISO timestamps | `:`, `+` | Any Safe_Str | `str` (no Safe type yet) |
| SHA-256 hashes | hex only | `Safe_Str__Id` (works but wrong semantics) | `Safe_Str__Cache_Hash` |
| User agents | `/`, `()`, `;` | `Safe_Str__Id` | `Safe_Str__Http__User_Agent` |

**Takeaway:** Always test the Safe type with real data before using it. The primitives reference doc (`library/dependencies/osbot-utils/type_safe/v3.28.0__for_llms__osbot-utils-safe-primitives.md`) is essential reading.

### 2. Domain-specific types are better than generic ones

Using `Safe_UInt__FileSize` instead of `Safe_UInt` for file sizes gives you `.to_kb()`, `.to_mb()`, `.to_gb()` methods for free. Using `Safe_Str__Cache_Hash` instead of `Safe_Str__Id` for IP hashes communicates that the field holds a cryptographic hash (10-96 hex chars) rather than a general identifier.

**Takeaway:** Pick the most specific type available. It serves as documentation and provides domain-specific validation.

### 3. ISO timestamp strings need a new Safe type

No existing Safe_Str type preserves `:` and `+` characters (needed for ISO 8601 format like `2026-02-13T10:30:00+00:00`). `Timestamp_Now` stores milliseconds as int, which is different from the ISO string representation. Fields storing ISO timestamp strings currently remain as `str`.

**Takeaway:** A `Safe_Str__Iso_Timestamp` type would be a useful addition to osbot-utils.

### 4. Service Registry pattern is the right architecture for inter-Lambda communication

The OSBot-Fast-API Service Registry (`v0.34.0__debrief__unified-service-client-architecture.md`) provides:
- **Stateless clients** — facades that look up config from the registry at request time
- **In-memory composition** — wire up multiple services for testing with 2 lines of code
- **Zero code awareness** — the application code has no idea if it's talking to a live Lambda or an in-memory app

This is exactly what we need for the user Lambda to call the admin Lambda.

### 5. Default values in Type_Safe schemas appear in Swagger

When `usage_limit` defaulted to `0`, the Swagger UI showed `0` as the default, which led to creating tokens with unlimited uses (and negative remaining counts). Changing to `50` makes the API self-documenting and prevents accidental misuse.

---

## Architecture Decisions Made

| Decision | Rationale | Confirmed by |
|----------|-----------|-------------|
| Service Registry for user→admin | Code-agnostic to deployment mode; testable in-memory | Dinis |
| Token in URL path: `/t/{token}/{transfer_id}#key` | Creates audit trail; enables per-link access control | Dinis |
| Env vars: `SGRAPH_SEND__ADMIN__API_KEY_NAME/VALUE` | Standard pattern for inter-service auth | Dinis |
| In-memory admin for unit tests | Full stack tests with no mocks; same code path as production | Dinis |

---

## What's Next

A separate Dev session is being launched to implement the UI brief:

1. **Admin Service Client** — `Admin__Service__Client`, `register_admin_service.py`
2. **Token-aware routes** — `GET /t/{token_name}/{transfer_id}` on user Lambda
3. **UI updates** — upload generates share URL with token, download validates token
4. **Tests** — full flow with in-memory admin service via Service Registry

---

## Files Changed This Session

```
sgraph_ai_app_send/lambda__admin/fast_api/Fast_API__SGraph__App__Send__Admin.py
sgraph_ai_app_send/lambda__admin/fast_api/routes/Routes__Analytics.py
sgraph_ai_app_send/lambda__admin/schemas/Schema__Analytics__Pulse.py
sgraph_ai_app_send/lambda__admin/schemas/Schema__Analytics__Raw_Event.py
sgraph_ai_app_send/lambda__admin/schemas/Schema__Token__Create__Request.py
sgraph_ai_app_send/lambda__admin/schemas/Schema__Token__Metadata.py
sgraph_ai_app_send/lambda__admin/schemas/Schema__Token__Usage_Event.py
sgraph_ai_app_send/lambda__admin/service/Service__Tokens.py
sgraph_ai_app_send/lambda__user/fast_api/routes/Routes__Transfers.py
sgraph_ai_app_send/lambda__user/schemas/Schema__Transfer.py
sgraph_ai_app_send/lambda__user/schemas/Schema__Transfer__Event.py
sgraph_ai_app_send/lambda__user/schemas/Schema__Transfer__Transparency.py
team/roles/dev/briefs/v0.2.41__dev-brief__ui-token-integration-and-service-registry.md
```
