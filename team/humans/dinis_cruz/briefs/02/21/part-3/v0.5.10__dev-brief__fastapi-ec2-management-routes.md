# Developer Brief: FastAPI EC2 Management Routes

**version** v0.5.10  
**date** 21 Feb 2026  
**from** Human (project lead)  
**to** Developer (lead), DevOps, GRC, AppSec  
**type** Developer brief — API-first infrastructure management  

---

## Guiding Principle

**No bash scripts. No Terraform. No CloudFormation. No DevOps black magic.**

All EC2 instance management is exposed as FastAPI routes. The UI is a convenience layer on top of the API. Every operation is a programmatic, fluent method call — auditable, testable, composable.

The human has already built wrappers for all of this in `osbot_utils` (specifically `osbot_aws.ec2`). The task is to expose these as FastAPI endpoints, not to rewrite them.

---

## Security Model

### Accepted Risk

These routes are admin-only. Only the admin (with the admin API key) can invoke them. This is a powerful capability — creating and managing EC2 instances from an API.

**GRC and AppSec**: document this as an accepted risk for the current phase. Specifically:

| Risk | Description | Mitigation |
|---|---|---|
| Admin compromise | A compromised admin key can create, terminate, and SSH into EC2 instances | Budget controls (max instances, max spend), audit logging, alert on instance creation |
| Runaway cost | Unchecked instance creation could generate large AWS bills | Per-day instance budget, instance count cap, auto-terminate idle instances |
| Lateral movement | Admin can SSH into data room instances | The admin cannot access data room content — all content is encrypted with user keys, not admin keys. SSH gives shell access but not data access. This is a strong security property. |
| Privilege escalation | EC2 management routes could be used to launch instances with elevated IAM roles | Instances are created with no IAM role (or minimal). No AWS API access from instances. No egress. |

**AppSec task**: threat model the hostile admin / compromised admin key scenario. Map the blast radius. Identify what additional controls are needed before wider release.

**Every time a new feature is added to these routes, GRC and AppSec must assess**: does this dramatically increase the attack surface? Does it break the trust model?

---

## API Routes

All routes are under `/api/ec2/` and require admin authentication.

### Instance Lifecycle

| Route | Method | Purpose | Parameters |
|---|---|---|---|
| `POST /api/ec2/instances` | POST | Create a new EC2 instance | `instance_type` (default: t3.micro), `data_room_id` (optional — links to a data room) |
| `GET /api/ec2/instances` | GET | List all managed instances | Optional filters: `status`, `data_room_id` |
| `GET /api/ec2/instances/{id}` | GET | Get instance details | Returns: instance_id, status, IP, uptime, data_room_id, launch_time |
| `POST /api/ec2/instances/{id}/start` | POST | Start a stopped instance | |
| `POST /api/ec2/instances/{id}/stop` | POST | Stop a running instance | |
| `DELETE /api/ec2/instances/{id}` | DELETE | Terminate an instance | Requires confirmation parameter |

### Instance Configuration

| Route | Method | Purpose | Parameters |
|---|---|---|---|
| `POST /api/ec2/instances/{id}/push-config` | POST | Push configuration files to the instance | `config_source` (S3 path or inline JSON) |
| `POST /api/ec2/instances/{id}/push-files` | POST | Upload files to the instance | File payload |
| `GET /api/ec2/instances/{id}/health` | GET | Health check — is the FastAPI server responding? | |

### SSH Operations

| Route | Method | Purpose | Parameters |
|---|---|---|---|
| `POST /api/ec2/instances/{id}/exec` | POST | Execute a command via SSH | `command` (string) |
| `POST /api/ec2/instances/{id}/exec-batch` | POST | Execute a sequence of commands | `commands` (array of strings) |
| `GET /api/ec2/instances/{id}/files/{path}` | GET | Download a file from the instance via SCP | `path` |
| `POST /api/ec2/instances/{id}/files` | POST | Upload a file to the instance via SCP | File payload + `destination_path` |

### AMI Management

| Route | Method | Purpose | Parameters |
|---|---|---|---|
| `GET /api/ec2/amis` | GET | List available AMIs | |
| `POST /api/ec2/amis` | POST | Create an AMI from a running instance | `instance_id`, `ami_name` |

### Key Pairs (AWS EC2 Key Pairs)

| Route | Method | Purpose | Parameters |
|---|---|---|---|
| `GET /api/ec2/keypairs` | GET | List EC2 key pairs | |
| `POST /api/ec2/keypairs` | POST | Create a new EC2 key pair | `name` |
| `DELETE /api/ec2/keypairs/{name}` | DELETE | Delete a key pair | |

The SSH private key for accessing EC2 instances is stored in the **secrets manager** (see `v0.5.10__brief__secrets-manager-dogfooding.md`). Not in environment variables. Not in GitHub secrets. In our own encrypted storage.

---

## Implementation: Wrapping osbot_utils

The FastAPI routes are thin wrappers around existing `osbot_aws` code:

```python
# Example: create instance route
from fastapi import APIRouter, Depends
from osbot_aws.aws.ec2.EC2_Instance import EC2_Instance

router = APIRouter(prefix="/api/ec2", tags=["ec2"])

@router.post("/instances")
async def create_instance(
    instance_type: str = "t3.micro",
    data_room_id: str = None,
    admin=Depends(require_admin)
):
    ec2 = EC2_Instance()
    instance = ec2.create(instance_type=instance_type)
    
    # Wait for running state
    instance.wait_until_running()
    
    # Log to audit trail
    audit_log.record("EC2_CREATE", {
        "instance_id": instance.instance_id,
        "instance_type": instance_type,
        "data_room_id": data_room_id,
        "admin": admin.identity
    })
    
    return {
        "instance_id": instance.instance_id,
        "status": "running",
        "public_ip": instance.public_ip,
        "data_room_id": data_room_id
    }
```

```python
# Example: SSH exec route
@router.post("/instances/{instance_id}/exec")
async def exec_command(
    instance_id: str,
    command: str,
    admin=Depends(require_admin)
):
    # Retrieve SSH key from secrets manager
    ssh_key = await get_secret(instance_id, "SSH_PRIVATE_KEY")
    
    ec2 = EC2_Instance(instance_id=instance_id)
    result = ec2.ssh_exec(command=command, key=ssh_key)
    
    audit_log.record("EC2_SSH_EXEC", {
        "instance_id": instance_id,
        "command": command,
        "admin": admin.identity
    })
    
    return {
        "stdout": result.stdout,
        "stderr": result.stderr,
        "exit_code": result.exit_code
    }
```

### SSH in Lambda

The SSH operations need an SSH client. Lambda's default runtime doesn't include SSH. Options:

| Approach | Complexity | Recommendation |
|---|---|---|
| **Lambda Layer with paramiko** | Low | `pip install paramiko` — pure Python SSH client. Works in Lambda natively. |
| **Container-based Lambda** | Medium | Lambda container image with SSH installed. More flexibility. |
| **Separate Lambda function** | Medium | Dedicated "EC2 management" Lambda with SSH capabilities, isolated from the main API Lambda. |

**Recommendation**: start with paramiko in the main Lambda. If the EC2 management routes become complex or need isolation, split into a dedicated Lambda function. The human noted this probably deserves a separate Lambda for security isolation — plan for this from the start by keeping the routes in their own FastAPI router that can be easily extracted.

---

## Budget Controls

Every EC2 management operation checks against budget limits before executing:

```python
@router.post("/instances")
async def create_instance(...):
    # Budget check BEFORE creating
    current = await count_running_instances()
    if current >= MAX_INSTANCES:
        raise HTTPException(403, "Instance limit reached")
    
    daily_spend = await get_daily_ec2_spend()
    if daily_spend >= DAILY_BUDGET:
        raise HTTPException(403, "Daily EC2 budget exceeded")
    
    # Proceed with creation...
```

| Budget Control | Default | Configurable |
|---|---|---|
| Max concurrent instances | 5 | Yes (admin setting) |
| Daily EC2 spend cap | $10 | Yes (admin setting) |
| Auto-terminate idle after | 30 minutes | Yes (per data room) |
| Max instance type allowed | t3.medium | Yes (admin setting) |

---

## Audit Trail

Every EC2 operation is logged:

```json
{
  "timestamp": "2026-02-21T10:00:00Z",
  "action": "EC2_CREATE",
  "admin": "admin_key_fingerprint",
  "details": {
    "instance_id": "i-0abc123",
    "instance_type": "t3.micro",
    "data_room_id": "investor-x"
  }
}
```

Logs are stored in the same append-only, hash-chained model as the trust graph audit trail. CloudTrail provides a secondary audit source from the AWS side.

---

## Data Room Boot Integration

The fleet management API (from `v0.5.10__dev-brief__data-room-ux-and-fleet-management.md`) calls these EC2 routes internally:

```
POST /api/fleet/rooms/{id}/start
  └── internally calls: POST /api/ec2/instances (create)
  └── internally calls: POST /api/ec2/instances/{id}/push-config (configure)
  └── internally calls: GET /api/ec2/instances/{id}/health (wait for ready)
  └── updates DNS routing

POST /api/fleet/rooms/{id}/stop
  └── internally calls: POST /api/ec2/instances/{id}/stop
  └── internally calls: DELETE /api/ec2/instances/{id} (terminate)
  └── updates DNS routing
```

The fleet management routes are the high-level orchestration. The EC2 routes are the low-level primitives. Both are API-first.

---

## Acceptance Criteria

| # | Criterion |
|---|---|
| 1 | Can create an EC2 instance via API call |
| 2 | Can list, start, stop, and terminate instances via API |
| 3 | Can execute SSH commands on a running instance via API |
| 4 | Can push files to an instance via API |
| 5 | SSH private key is retrieved from secrets manager, not environment variables |
| 6 | All operations are logged to the audit trail |
| 7 | Budget controls prevent exceeding instance/spend limits |
| 8 | All routes require admin authentication |
| 9 | Instance creation uses osbot_utils wrappers, not raw boto3 |
| 10 | Routes are in a separate FastAPI router (extractable to dedicated Lambda) |

---

This document is released under the Creative Commons Attribution 4.0 International licence (CC BY 4.0). You are free to share and adapt this material for any purpose, including commercially, as long as you give appropriate credit.
