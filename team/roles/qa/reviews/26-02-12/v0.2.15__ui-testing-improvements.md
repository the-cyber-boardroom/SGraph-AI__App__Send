# QA Review — UI Testing Improvements

**Role:** Dev (Frontend) + QA
**Version:** v0.2.15
**Date:** 2026-02-12
**Source:** `team/roles/qa/reviews/26-02-12/v0.2.15__briefing__mvp-review-ui-testing.md`

---

## Summary

Three tasks completed in response to the MVP review briefing:

1. **Critical bug fix** — `crypto.subtle` undefined in non-secure contexts
2. **QA test files** — downloadable test files for repeatable upload testing
3. **Backend tests** — 7 new tests covering crypto checks, test files, and download page

All 50 tests pass (43 existing + 7 new).

---

## TASK-1: Local Crypto Bug Fix (CRITICAL)

### Root Cause

`window.crypto.subtle` is only available in secure contexts (HTTPS or `localhost`). When the local development server binds to `127.0.0.1` instead of `localhost`, `crypto.subtle` is `undefined`. Calling `undefined.generateKey()` produces the reported error:

```
Cannot read properties of undefined (reading 'generateKey')
```

### Fix Applied

**`crypto.js`** — Added two new methods:

| Method | Purpose |
|---|---|
| `isAvailable()` | Returns `boolean` — checks `window.crypto && window.crypto.subtle` |
| `requireSecureContext()` | Throws descriptive error if `crypto.subtle` is unavailable |

Every crypto method (`generateKey`, `exportKey`, `importKey`, `encryptFile`, `decryptFile`) now calls `requireSecureContext()` as a guard at entry. This ensures any crypto operation produces a clear, actionable error message rather than a cryptic `TypeError`.

**`send-upload.js`** — Added an `isAvailable()` check in `startUpload()` before entering the encryption flow. If `crypto.subtle` is unavailable, the component transitions to the `error` state with a user-facing message explaining the secure context requirement.

**`send-download.js`** — Added an identical `isAvailable()` check in `startDownload()` before attempting key import and decryption.

### Error Message

> Web Crypto API is not available. It requires a secure context (HTTPS or localhost). If running locally, use "localhost" instead of "127.0.0.1".

This message is shown both as a thrown exception (from `requireSecureContext()`) and as a user-visible error in the upload and download components.

### Files Modified

| File | Change |
|---|---|
| `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.0/js/crypto.js` | Added `isAvailable()`, `requireSecureContext()`, guards on all methods |
| `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.0/components/send-upload/send-upload.js` | Pre-check before `startUpload()` |
| `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.0/components/send-download/send-download.js` | Pre-check before `startDownload()` |

---

## TASK-2: QA Test Files

### Files Created

| File | Type | Size | Purpose |
|---|---|---|---|
| `test-files/test-text.txt` | Plain text | ~350 bytes | Basic text file for drag-and-drop testing |
| `test-files/test-data.json` | JSON | ~280 bytes | Structured data file for drag-and-drop testing |

### UI Changes

Added a "Test Files" section to `index.html` (the upload page), below the `<send-upload>` component:

- Heading: "Test Files"
- Instructions: "Download a test file, then drag it into the upload zone above."
- Download links for both test files using `<a download>` elements

### QA Workflow

1. Open the upload page
2. Click a test file link — browser downloads it
3. Drag the downloaded file from the browser's download bar into the drop zone
4. Click "Encrypt & Upload"
5. Verify the upload completes and returns a download link + decryption key

This provides a zero-setup, repeatable testing workflow.

---

## TASK-3: Backend Tests

### New Tests (7 total)

All tests are in `tests/unit/lambda__user/fast_api/static__user/test__App_Send__UI__User__static_pages.py`:

| Test | Verifies |
|---|---|
| `test__upload_page__crypto_availability_check` | `crypto.js` is loaded and contains `isAvailable`, `requireSecureContext`, and secure context error text |
| `test__upload_page__send_upload_checks_crypto` | `send-upload.js` calls `SendCrypto.isAvailable()` and includes secure context error message |
| `test__download_page__send_download_checks_crypto` | `send-download.js` calls `SendCrypto.isAvailable()` and includes secure context error message |
| `test__download_page__loads` | `download.html` loads (200), includes `<send-download>` and `crypto.js` |
| `test__test_files__available` | Both test files (`test-text.txt`, `test-data.json`) are served with 200 and expected content |
| `test__upload_page__test_files_section` | Upload page contains "Test Files" section with links to both test files |

### Test Results

```
50 passed, 4 warnings in 2.59s
```

All tests pass. No mocks, no patches — tests use the real in-memory FastAPI stack with `TestClient`.

---

## TASK-4: Multi-Instance Awareness

**No action taken** (per briefing: priority Low, informational only). The current in-memory storage limitation is known and will be resolved by Memory-FS S3 integration. The download component already handles "Transfer not found" errors gracefully.

---

## Recommendations

1. **Local dev server** — Ensure documentation mentions using `localhost` (not `127.0.0.1`) when running locally without HTTPS. Consider adding `--host localhost` to any dev server launch scripts.

2. **Playwright E2E** — When Playwright tests are added, include a test that verifies `SendCrypto.isAvailable()` returns `true` in the test browser context.

3. **Test file variety** — The briefing mentioned a test image and zip file. Only text and JSON files were created (as specified in the task requirements). Additional binary test files can be added later if needed.
