# DevOps Review: CACHE__SERVICE__BUCKET_NAME Environment Variable Fix

**Version:** v0.2.41
**Date:** 2026-02-14
**Role:** DevOps
**Trigger:** Dinis confirmed admin service working after manually adding `CACHE__SERVICE__BUCKET_NAME` env var to Lambda; requested CI/deploy code be updated to match

---

## Context

The admin Lambda service requires the `CACHE__SERVICE__BUCKET_NAME` environment variable to be set so the MGraph-AI Cache Service dependency can locate the S3 bucket for storage operations. This env var was manually added to the Lambda function and as a GitHub Actions secret, but the CI pipeline and deploy code were not wiring it through.

**GitHub Actions Secret added by Dinis:**
- **Name:** `CACHE__SERVICE__BUCKET_NAME`
- **Value:** `745506449035--sgraph-send-transfers--eu-west-2`

---

## Changes Made

### 1. CI Pipeline (`.github/workflows/ci-pipeline.yml`)

**Secret declaration** — Added `CACHE__SERVICE__BUCKET_NAME` to the `workflow_call` secrets section:
```yaml
secrets:
  # ... existing secrets ...
  CACHE__SERVICE__BUCKET_NAME:
    required: false
```

**Admin Lambda deploy job** — Added env var to `aws-deploy-lambda__admin`:
```yaml
CACHE__SERVICE__BUCKET_NAME: ${{ secrets.CACHE__SERVICE__BUCKET_NAME }}
```

**User Lambda deploy job** — Added env var to `aws-deploy-lambda__user`:
```yaml
CACHE__SERVICE__BUCKET_NAME: ${{ secrets.CACHE__SERVICE__BUCKET_NAME }}
```

### 2. Admin Deploy Code (`sgraph_ai_app_send/lambda__admin/lambda_function/deploy/Deploy__Service.py`)

Replaced commented-out placeholder with actual env var wiring:
```python
_.set_env_variable('CACHE__SERVICE__BUCKET_NAME', get_env('CACHE__SERVICE__BUCKET_NAME'))
```

### 3. User Deploy Code (`sgraph_ai_app_send/lambda__user/lambda_function/deploy/Deploy__Service.py`)

Same fix — replaced commented-out placeholder:
```python
_.set_env_variable('CACHE__SERVICE__BUCKET_NAME', get_env('CACHE__SERVICE__BUCKET_NAME'))
```

---

## How It Works (End to End)

1. **GitHub Actions secret** `CACHE__SERVICE__BUCKET_NAME` holds the bucket name
2. **CI pipeline** passes the secret as an environment variable to the deploy action
3. **Deploy action** runs the deploy test which calls `Deploy__Service.deploy_lambda()`
4. **`Deploy__Service.deploy_lambda()`** reads the env var with `get_env()` and sets it on the Lambda function via `set_env_variable()`
5. **Lambda at runtime** — the Cache Service dependency reads `CACHE__SERVICE__BUCKET_NAME` to configure its S3 storage backend

---

## Current GitHub Actions Secrets Inventory

| Secret | Purpose | Used By |
|--------|---------|---------|
| `AWS_ACCESS_KEY_ID` | AWS authentication | Both Lambdas |
| `AWS_SECRET_ACCESS_KEY` | AWS authentication | Both Lambdas |
| `AWS_DEFAULT_REGION` | AWS region | Both Lambdas |
| `AWS_ACCOUNT_ID` | AWS account | Both Lambdas |
| `FAST_API__AUTH__API_KEY__NAME` | FastAPI auth header name | Both Lambdas |
| `FAST_API__AUTH__API_KEY__VALUE` | FastAPI auth header value | Both Lambdas |
| `AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL` | Cache service URL | Both Lambdas |
| `CACHE__SERVICE__BUCKET_NAME` | S3 bucket for cache storage | Both Lambdas |

---

## Files Changed

| File | Change |
|------|--------|
| `.github/workflows/ci-pipeline.yml` | Added secret declaration + env var to both deploy jobs |
| `sgraph_ai_app_send/lambda__admin/lambda_function/deploy/Deploy__Service.py` | Wired `CACHE__SERVICE__BUCKET_NAME` to Lambda env |
| `sgraph_ai_app_send/lambda__user/lambda_function/deploy/Deploy__Service.py` | Wired `CACHE__SERVICE__BUCKET_NAME` to Lambda env |
