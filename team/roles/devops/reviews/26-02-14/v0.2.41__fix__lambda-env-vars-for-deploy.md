# DevOps Review: Lambda Environment Variables for CI Deploy

**Version:** v0.2.41
**Date:** 2026-02-14
**Role:** DevOps
**Trigger:** Dinis confirmed admin service working after manually adding `CACHE__SERVICE__BUCKET_NAME` env var; requested CI/deploy code be updated for both Lambdas

---

## Context

Each Lambda function needs specific environment variables set during deployment. These were previously commented-out placeholders in the `Deploy__Service.py` files and missing from the CI pipeline.

**Admin Lambda** needs `CACHE__SERVICE__BUCKET_NAME` for the embedded MGraph-AI Cache Service to locate its S3 storage backend.

**User Lambda** needs 3 env vars to communicate with the Admin Lambda (for token validation via the Admin Service Client):
- `SGRAPH_SEND__ADMIN__BASE_URL` — Admin Lambda function URL
- `SGRAPH_SEND__ADMIN__API_KEY__NAME` — Auth header name for Admin API
- `SGRAPH_SEND__ADMIN__API_KEY__VALUE` — Auth header value for Admin API

---

## Changes Made

### 1. CI Pipeline (`.github/workflows/ci-pipeline.yml`)

**Secrets declaration** — Added 4 new secrets:
```yaml
CACHE__SERVICE__BUCKET_NAME:
  required: false
SGRAPH_SEND__ADMIN__BASE_URL:
  required: false
SGRAPH_SEND__ADMIN__API_KEY__NAME:
  required: false
SGRAPH_SEND__ADMIN__API_KEY__VALUE:
  required: false
```

**Admin Lambda deploy job** — Added:
```yaml
CACHE__SERVICE__BUCKET_NAME: ${{ secrets.CACHE__SERVICE__BUCKET_NAME }}
```

**User Lambda deploy job** — Added (replacing `CACHE__SERVICE__BUCKET_NAME` which doesn't apply to user):
```yaml
SGRAPH_SEND__ADMIN__BASE_URL:      ${{ secrets.SGRAPH_SEND__ADMIN__BASE_URL }}
SGRAPH_SEND__ADMIN__API_KEY__NAME: ${{ secrets.SGRAPH_SEND__ADMIN__API_KEY__NAME }}
SGRAPH_SEND__ADMIN__API_KEY__VALUE:${{ secrets.SGRAPH_SEND__ADMIN__API_KEY__VALUE }}
```

### 2. Admin Deploy Code (`sgraph_ai_app_send/lambda__admin/lambda_function/deploy/Deploy__Service.py`)

Wired `CACHE__SERVICE__BUCKET_NAME` to Lambda:
```python
_.set_env_variable('CACHE__SERVICE__BUCKET_NAME', get_env('CACHE__SERVICE__BUCKET_NAME'))
```

### 3. User Deploy Code (`sgraph_ai_app_send/lambda__user/lambda_function/deploy/Deploy__Service.py`)

Wired the 3 admin connection env vars using constants from `user__config.py`:
```python
_.set_env_variable(ENV_VAR__SGRAPH_SEND__ADMIN__BASE_URL      , get_env(ENV_VAR__SGRAPH_SEND__ADMIN__BASE_URL      ))
_.set_env_variable(ENV_VAR__SGRAPH_SEND__ADMIN__API_KEY__NAME , get_env(ENV_VAR__SGRAPH_SEND__ADMIN__API_KEY__NAME  ))
_.set_env_variable(ENV_VAR__SGRAPH_SEND__ADMIN__API_KEY__VALUE, get_env(ENV_VAR__SGRAPH_SEND__ADMIN__API_KEY__VALUE ))
```

---

## GitHub Actions Secrets — Required for Deployment

| Secret | Purpose | Used By |
|--------|---------|---------|
| `AWS_ACCESS_KEY_ID` | AWS authentication | Both Lambdas |
| `AWS_SECRET_ACCESS_KEY` | AWS authentication | Both Lambdas |
| `AWS_DEFAULT_REGION` | AWS region | Both Lambdas |
| `AWS_ACCOUNT_ID` | AWS account | Both Lambdas |
| `FAST_API__AUTH__API_KEY__NAME` | FastAPI auth header name | Both Lambdas |
| `FAST_API__AUTH__API_KEY__VALUE` | FastAPI auth header value | Both Lambdas |
| `AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL` | Cache service URL (CI env) | Both Lambdas |
| `CACHE__SERVICE__BUCKET_NAME` | S3 bucket for cache storage | Admin Lambda only |
| `SGRAPH_SEND__ADMIN__BASE_URL` | Admin Lambda function URL | User Lambda only |
| `SGRAPH_SEND__ADMIN__API_KEY__NAME` | Admin API auth key name | User Lambda only |
| `SGRAPH_SEND__ADMIN__API_KEY__VALUE` | Admin API auth key value | User Lambda only |

**Action needed:** Add these 3 new GitHub Actions secrets:
- `SGRAPH_SEND__ADMIN__BASE_URL` — the Admin Lambda function URL
- `SGRAPH_SEND__ADMIN__API_KEY__NAME` — same value as `FAST_API__AUTH__API_KEY__NAME`
- `SGRAPH_SEND__ADMIN__API_KEY__VALUE` — same value as `FAST_API__AUTH__API_KEY__VALUE`

---

## Files Changed

| File | Change |
|------|--------|
| `.github/workflows/ci-pipeline.yml` | Added 4 secret declarations; admin gets `CACHE__SERVICE__BUCKET_NAME`, user gets 3 admin connection env vars |
| `sgraph_ai_app_send/lambda__admin/lambda_function/deploy/Deploy__Service.py` | Wired `CACHE__SERVICE__BUCKET_NAME` to Lambda env |
| `sgraph_ai_app_send/lambda__user/lambda_function/deploy/Deploy__Service.py` | Wired 3 admin connection env vars to Lambda env |
