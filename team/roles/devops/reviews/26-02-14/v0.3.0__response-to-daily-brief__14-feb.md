# DevOps Response to v0.3.0 Daily Brief

**Version:** v0.3.0
**Date:** 14 February 2026
**Role:** DevOps
**Trigger:** v0.3.0 daily brief -- directive #6: "Ensure admin Lambda serves static UI assets correctly in production"
**Previous:** `team/roles/devops/reviews/26-02-14/v0.2.41__fix__lambda-env-vars-for-deploy.md`

---

## 1. Admin Lambda Static Asset Serving in Production

### Current State

The admin Lambda already has static asset serving wired. The `Fast_API__SGraph__App__Send__Admin.setup_static_routes()` method:

1. Mounts `sgraph_ai_app_send__ui__admin.path` as a `StaticFiles` directory at `/admin`
2. Registers a redirect route: `GET /admin` -> `/admin/v0/v0.1/v0.1.0/index.html`

**Config values** (from `admin__config.py`):
| Constant | Value |
|----------|-------|
| `APP_SEND__UI__ADMIN__ROUTE__PATH__CONSOLE` | `admin` |
| `APP_SEND__UI__ADMIN__START_PAGE` | `index` |
| `APP_SEND__UI__ADMIN__MAJOR__VERSION` | `v0/v0.1` |
| `APP_SEND__UI__ADMIN__LATEST__VERSION` | `v0.1.0` |

### Production Routing Verification

The redirect chain works as follows:

```
GET /admin
  --> RedirectResponse --> /admin/v0/v0.1/v0.1.0/index.html
  --> StaticFiles serves from sgraph_ai_app_send__ui__admin/ directory
```

**Current placeholder:** The file at `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.0/index.html` contains only the text `IFD version v0.1.0 will go here`. This will be replaced by the Dev role with the real admin console UI.

### Production Concern: Lambda Package Size

The `Deploy__Service.py` for admin already includes the UI folder:
```python
_.add_folder(sgraph_ai_app_send__ui__admin.path)
```

This bundles the entire `sgraph_ai_app_send__ui__admin/` directory into the Lambda deployment package. As the admin UI grows (HTML, CSS, JS files), monitor the Lambda package size against the 50MB zipped / 250MB unzipped limits. For v0.1.0 this is not a concern -- the UI will be lightweight vanilla JS with no framework dependencies.

### Routing Conflict Check

There is a potential route conflict between the `StaticFiles` mount at `/admin` and the `redirect_to_latest` route also at `/admin`. FastAPI evaluates routes in registration order. In the current code, `setup_static_routes()` is called first in `setup_routes()`, and within it:

1. `app().mount(path_static, StaticFiles(...))` is registered first
2. `add_route_get(redirect_to_latest)` is registered second

The `StaticFiles` mount catches all `/admin/*` subpaths. The explicit `GET /admin` route handles the exact `/admin` path. This ordering is correct -- the redirect catches the bare `/admin` URL and the `StaticFiles` mount serves all versioned asset paths underneath.

**Verification needed:** Test in production that `GET /admin` returns a 307 redirect (not a 404 or a directory listing). The Starlette `StaticFiles` middleware may intercept the exact mount path if `html=True` is set, but the current code does not set this flag.

---

## 2. `/admin` Route Redirect Behaviour

### Expected Behaviour

| Request | Expected Response |
|---------|-------------------|
| `GET /admin` | 307 Redirect to `/admin/v0/v0.1/v0.1.0/index.html` |
| `GET /admin/` | Served by StaticFiles (may return directory listing or 404 depending on config) |
| `GET /admin/v0/v0.1/v0.1.0/index.html` | 200 with admin console HTML |
| `GET /admin/v0/v0.1/v0.1.0/styles.css` | 200 with CSS (once assets exist) |
| `GET /admin/v0/v0.1/v0.1.0/app.js` | 200 with JS (once assets exist) |

### Recommended Smoke Test

After deployment, verify:

```bash
# 1. Redirect works
curl -s -o /dev/null -w "%{http_code}" https://{admin-lambda-url}/admin
# Expected: 307

# 2. Follow redirect, get HTML
curl -s -L -o /dev/null -w "%{http_code}" https://{admin-lambda-url}/admin
# Expected: 200

# 3. Direct asset access works
curl -s -o /dev/null -w "%{http_code}" https://{admin-lambda-url}/admin/v0/v0.1/v0.1.0/index.html
# Expected: 200

# 4. Auth is enforced (no API key)
curl -s -o /dev/null -w "%{http_code}" https://{admin-lambda-url}/tokens/list
# Expected: 401 or 403
```

---

## 3. CI/CD Pipeline Updates for v0.3.0

### Current Pipeline State

The base pipeline (`ci-pipeline.yml`) was updated in v0.2.41 to support all required environment variables. The pipeline flow is:

```
Push to dev
  --> ci-pipeline__dev.yml (workflow caller)
    --> ci-pipeline.yml (reusable workflow)
      --> run-tests (unit tests)
      --> increment-tag
      --> publish-to-pypi
      --> check-aws-credentials
      --> aws-deploy-lambda__admin (parallel with user)
      --> aws-deploy-lambda__user  (parallel with admin)
```

### v0.3.0 Pipeline Requirements

No structural pipeline changes are needed for v0.3.0. The admin UI is bundled into the Lambda package via `Deploy__Service.py` which already calls `_.add_folder(sgraph_ai_app_send__ui__admin.path)`. New HTML/CSS/JS files added to the UI package directory will be automatically included in the next deployment.

**Checklist:**

| Item | Status | Notes |
|------|--------|-------|
| Admin Lambda deploys admin UI assets | Done | `Deploy__Service.py` adds folder |
| User Lambda deploys user UI assets | Done | Already in place since v0.1.x |
| All 11 GitHub Actions secrets configured | Done (v0.2.41) | See environment variable checklist below |
| Tag increment works | Done | `should_increment_tag` flag in caller workflows |
| PyPI publish works | Done | Tested in v0.2.x series |
| Both Lambdas deploy in parallel | Done | Independent jobs in pipeline |

### Potential Pipeline Enhancement for v0.3.x

Consider adding a post-deploy smoke test job that runs after both Lambda deployments complete:

```yaml
smoke-test:
  name: Post-Deploy Smoke Test
  needs: [aws-deploy-lambda__admin, aws-deploy-lambda__user]
  runs-on: ubuntu-latest
  steps:
    - name: Smoke test admin
      run: |
        curl -sf -H "x-api-key: ${{ secrets.FAST_API__AUTH__API_KEY__VALUE }}" \
          "${{ secrets.SGRAPH_SEND__ADMIN__BASE_URL }}/config/version"
    - name: Smoke test admin UI
      run: |
        curl -sf -L "${{ secrets.SGRAPH_SEND__ADMIN__BASE_URL }}/admin" | grep -q "<html"
```

This is a recommendation for a future iteration, not a v0.3.0 blocker.

---

## 4. Static Asset Bundling for Admin UI

### How It Works

The admin UI follows the IFD methodology:

```
sgraph_ai_app_send__ui__admin/
  __init__.py                    # Exports path for Python import
  index.html                     # Root (not directly used)
  v0/
    v0.1/
      v0.1.0/
        index.html               # Admin console entry point
        (future: styles.css)
        (future: app.js)
        (future: components/)
```

The `__init__.py` exposes the package path:
```python
ui_name = 'sgraph_ai_app_send__ui__admin'
path    = __path__[0]
```

This path is consumed by:
1. `Fast_API__SGraph__App__Send__Admin.setup_static_routes()` -- mounts as StaticFiles at runtime
2. `Deploy__Service.deploy_lambda()` -- bundles into Lambda package via `_.add_folder()`

### Bundling Flow

```
Dev creates files in sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.0/
  --> git push to dev
  --> CI runs tests
  --> CI deploys Lambda
  --> Deploy__Service adds folder to Lambda package
  --> Lambda serves files via StaticFiles mount
```

### IFD Versioning for Future Admin UI Updates

When the admin UI needs a new version:

1. Create `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.1/` (or next minor)
2. Copy and modify only changed files
3. Update `admin__config.py`:
   ```python
   APP_SEND__UI__ADMIN__LATEST__VERSION = "v0.1.1"
   ```
4. The redirect at `/admin` automatically points to the new version
5. Previous version remains accessible at its explicit path

### Content-Type Headers

Starlette's `StaticFiles` middleware automatically sets `Content-Type` headers based on file extension. Ensure admin UI files use standard extensions:

| Extension | Content-Type |
|-----------|-------------|
| `.html` | `text/html` |
| `.css` | `text/css` |
| `.js` | `application/javascript` |
| `.json` | `application/json` |
| `.svg` | `image/svg+xml` |

No additional configuration needed.

---

## 5. Environment Variable Checklist for Both Lambdas

### Admin Lambda

| Env Var | Purpose | Source | Status |
|---------|---------|--------|--------|
| `FAST_API__AUTH__API_KEY__NAME` | API key header name (auth) | GitHub Secret | Configured |
| `FAST_API__AUTH__API_KEY__VALUE` | API key header value (auth) | GitHub Secret | Configured |
| `CACHE__SERVICE__BUCKET_NAME` | S3 bucket for MGraph-AI Cache Service | GitHub Secret | Configured (v0.2.41) |
| `URL__TARGET_SERVER__CACHE_SERVICE` | Cache service base URL | GitHub Secret | Configured |

### User Lambda

| Env Var | Purpose | Source | Status |
|---------|---------|--------|--------|
| `FAST_API__AUTH__API_KEY__NAME` | API key header name (auth) | GitHub Secret | Configured |
| `FAST_API__AUTH__API_KEY__VALUE` | API key header value (auth) | GitHub Secret | Configured |
| `URL__TARGET_SERVER__CACHE_SERVICE` | Cache service base URL | GitHub Secret | Configured |
| `SGRAPH_SEND__ADMIN__BASE_URL` | Admin Lambda function URL | GitHub Secret | Configured (v0.2.41) |
| `SGRAPH_SEND__ADMIN__API_KEY__NAME` | Admin API auth key name | GitHub Secret | Configured (v0.2.41) |
| `SGRAPH_SEND__ADMIN__API_KEY__VALUE` | Admin API auth key value | GitHub Secret | Configured (v0.2.41) |

### Shared AWS Credentials

| Env Var | Purpose | Status |
|---------|---------|--------|
| `AWS_ACCESS_KEY_ID` | AWS authentication | Configured |
| `AWS_SECRET_ACCESS_KEY` | AWS authentication | Configured |
| `AWS_DEFAULT_REGION` | AWS region | Configured |
| `AWS_ACCOUNT_ID` | AWS account | Configured |

### Total: 11 GitHub Actions Secrets Required

All 11 secrets were configured as of v0.2.41. No new secrets needed for v0.3.0.

---

## 6. Deployment Sequence for Admin UI Update

### Recommended Deployment Order

The admin UI update is part of the regular CI/CD flow. No special deployment sequence is required because:

1. The admin UI files are bundled into the admin Lambda package
2. The admin Lambda is deployed independently (parallel with user Lambda)
3. No inter-Lambda dependency exists for the UI (the admin UI calls admin API endpoints directly)

### Step-by-Step Deployment

```
1. Dev merges admin UI code into dev branch
   - New files in sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.0/
   - Updated index.html (replacing placeholder)
   - New CSS, JS, component files

2. CI pipeline triggers on push to dev
   a. Unit tests run (including any new admin UI tests)
   b. Tag incremented
   c. PyPI published
   d. AWS credentials checked
   e. Admin Lambda deployed (with new UI files bundled)
   f. User Lambda deployed (no changes needed for admin UI)

3. Post-deploy verification
   a. curl admin Lambda /admin -- should redirect to index.html
   b. curl admin Lambda /admin/v0/v0.1/v0.1.0/index.html -- should return full HTML
   c. curl admin Lambda /tokens/list with API key -- should return token list
   d. Open admin console in browser -- should render the new UI
```

### Rollback Plan

If the admin UI deployment causes issues:

1. **Quick fix:** Revert the UI files in git and push to dev -- triggers a new deployment with the previous UI
2. **Emergency:** The admin API endpoints remain functional regardless of UI state. Dinis can use Swagger UI at `/docs` for token management operations as a fallback
3. **Nuclear option:** Deploy a previous git tag using `git checkout v0.2.41 && git push origin HEAD:dev` (destructive -- requires team coordination)

### Pre-Deploy Checklist

- [ ] Admin UI index.html is no longer a placeholder
- [ ] Admin UI calls admin API endpoints (not hardcoded data)
- [ ] API key authentication is enforced on all admin API calls from the UI
- [ ] No credentials are embedded in client-side JavaScript
- [ ] CORS is configured correctly for admin Lambda (same-origin for Lambda URL)
- [ ] All unit tests pass
- [ ] Smoke tests defined for post-deploy verification

---

## 7. Infrastructure Notes for v0.3.0

### Lambda URL Functions

Both Lambdas use Lambda Function URLs (direct HTTPS endpoints, no API Gateway). This means:

- No API Gateway configuration to manage
- No custom domain mapping needed (Lambda URLs are auto-generated)
- CORS is handled by the FastAPI application middleware
- Authentication is handled by the application (API key in header), not by Lambda URL IAM auth

### Memory and Timeout

The admin Lambda handles:
- Token CRUD operations (lightweight, < 100ms)
- Analytics pulse computation (queries cache, may be heavier)
- Static UI serving (file I/O from package directory)
- Swagger UI serving (built-in FastAPI)

Current defaults (128MB memory, 30s timeout) should be adequate for v0.3.0. Monitor CloudWatch metrics after deployment and increase if needed.

### Cost Impact

The admin UI adds minimal Lambda invocation cost because:
- Admin console is used by a single user (Dinis) during this phase
- Static file requests are lightweight
- No external service calls for UI serving (files are local to the Lambda package)

---

*DevOps -- Response to v0.3.0 Daily Brief*
*Admin Lambda static asset serving verified, CI/CD pipeline confirmed, deployment sequence documented*
