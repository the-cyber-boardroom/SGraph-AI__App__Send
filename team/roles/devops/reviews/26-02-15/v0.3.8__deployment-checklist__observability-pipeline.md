# v0.3.8 — Deployment Checklist: Observability Pipeline

**Date:** 2026-02-15
**Scope:** Enable `/metrics/*` endpoints on the admin Lambda
**Status:** Pending deployment

---

## 1. IAM — Admin Lambda Execution Role

Add this policy statement to the **admin Lambda execution role**:

```json
{
    "Sid": "CloudWatchMetricsReadOnly",
    "Effect": "Allow",
    "Action": [
        "cloudwatch:GetMetricData",
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:ListMetrics"
    ],
    "Resource": "*"
}
```

**Why `Resource: *`?** CloudWatch metrics actions do not support resource-level permissions — AWS requires `*`.

### Optional: CloudFront Real-Time Logs (if using CF logs collector)

If the `CloudFront__Logs__Collector` will read logs from the Kinesis Firehose delivery bucket:

```json
{
    "Sid": "CloudFrontLogsRead",
    "Effect": "Allow",
    "Action": [
        "s3:GetObject",
        "s3:ListBucket"
    ],
    "Resource": [
        "arn:aws:s3:::FIREHOSE_DELIVERY_BUCKET_NAME",
        "arn:aws:s3:::FIREHOSE_DELIVERY_BUCKET_NAME/*"
    ]
}
```

---

## 2. Environment Variables — Admin Lambda

Set these environment variables on the admin Lambda function. **All 5 required values must be set** — if any are missing, the metrics pipeline gracefully disables itself and the `/metrics/*` routes are not registered.

| Env Var | Required | Example Value | Description |
|---------|----------|---------------|-------------|
| `SGRAPH_SEND__CLOUDFRONT_DISTRIBUTION_ID` | Yes | `E1ABC2DEFGHIJ` | CloudFront distribution ID |
| `SGRAPH_SEND__LAMBDA_USER_NAME` | Yes | `sgraph-send-user-prod` | User Lambda function name |
| `SGRAPH_SEND__LAMBDA_ADMIN_NAME` | Yes | `sgraph-send-admin-prod` | Admin Lambda function name |
| `SGRAPH_SEND__S3_TRANSFERS_BUCKET` | Yes | `sgraph-send-prod-transfers` | Transfers S3 bucket |
| `SGRAPH_SEND__S3_CACHE_BUCKET` | Yes | `sgraph-send-prod-cache` | Cache S3 bucket |
| `SGRAPH_SEND__S3_FILTER_ID` | No | `all-requests` | S3 request metrics filter ID (default: `all-requests`) |
| `SGRAPH_SEND__AWS_REGION` | No | `eu-west-2` | AWS region (default: `eu-west-2`) |

### How it works

`admin__config.py` reads these at import time. `METRICS__ENABLED` is `True` only when all 5 required values are non-empty. The factory function `create_metrics_cache()` returns `None` when disabled, so the FastAPI app starts normally without metrics routes.

---

## 3. GitHub Actions Secrets

Add these secrets to the repository for CI/CD deployment:

| Secret Name | Maps To |
|-------------|---------|
| `SGRAPH_SEND__CLOUDFRONT_DISTRIBUTION_ID` | Lambda env var |
| `SGRAPH_SEND__LAMBDA_USER_NAME` | Lambda env var |
| `SGRAPH_SEND__LAMBDA_ADMIN_NAME` | Lambda env var |
| `SGRAPH_SEND__S3_TRANSFERS_BUCKET` | Lambda env var |
| `SGRAPH_SEND__S3_CACHE_BUCKET` | Lambda env var |

---

## 4. Verification

After deployment, verify:

1. **Routes registered:** `GET /info/status` should show the `/metrics/*` paths in the route list
2. **Cached snapshot:** `GET /metrics/snapshot` should return a full snapshot (first call collects from CloudWatch, subsequent calls return cached)
3. **Force refresh:** `GET /metrics/snapshot/refresh` should collect fresh data
4. **Cache status:** `GET /metrics/cache-status` should show TTL and age
5. **Health only:** `GET /metrics/health` should return health status for all 5 components
6. **Admin UI:** Navigate to `/admin` — the sidebar should show "Metrics" under Monitoring

### Smoke test curl commands

```bash
# Check metrics snapshot (will be slow first time — CloudWatch API calls)
curl -s -H "Cookie: api_key=YOUR_KEY" https://admin.send.sgraph.ai/metrics/snapshot | python -m json.tool

# Check health only
curl -s -H "Cookie: api_key=YOUR_KEY" https://admin.send.sgraph.ai/metrics/health | python -m json.tool

# Force fresh collection
curl -s -H "Cookie: api_key=YOUR_KEY" https://admin.send.sgraph.ai/metrics/snapshot/refresh | python -m json.tool
```

---

## 5. Graceful Degradation

If env vars are **not** set:
- `METRICS__ENABLED = False`
- `create_metrics_cache()` returns `None`
- `metrics_cache` stays `None` on the FastAPI app
- `setup_routes()` skips `Routes__Metrics` registration
- All existing endpoints (tokens, analytics, health pulse) work normally
- Admin UI "Metrics" nav item will show an error when clicked (expected — no backend)

**No code changes needed to disable** — just don't set the env vars.

---

## 6. Architecture Note — CloudFront us-east-1

The `CloudWatch__Client` creates **two** boto3 clients:
- Primary: configured region (e.g., `eu-west-2`) for Lambda and S3 metrics
- Secondary: `us-east-1` for CloudFront metrics (AWS publishes CF metrics only to us-east-1)

The IAM permissions above cover both regions — CloudWatch IAM is global.
