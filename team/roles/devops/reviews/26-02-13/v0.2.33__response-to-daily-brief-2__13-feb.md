# v0.2.33 -- DevOps Response to Daily Brief #2 (13 Feb 2026)

**Version:** v0.2.33
**Date:** 2026-02-13
**Role:** DevOps
**Context:** Response to `team/humans/dinis_cruz/briefs/02/13/v0.2.32__daily-brief__2__sgraph-send-13-feb-2026.md`
**Follows:** `team/roles/devops/reviews/26-02-13/v0.2.24__response-to-daily-brief__13-feb.md` (Brief #1 response)

---

## Executive Summary

Daily Brief #2 changes the role of CloudFront logs from "observability data" to "primary analytics data source" -- they are now the replacement for Google Analytics. This elevates the priority and expands the scope. The collector pipeline must now flow through the **cache service** (not a standalone S3 data lake), and IP masking is a hard prerequisite before any logging is enabled.

This document covers five deliverables:

1. CloudFront logging plan with IP masking approach
2. AWS cost data collection architecture
3. Updated collector pipeline design integrating the cache service
4. Cost estimates for the expanded logging scope
5. Coordination matrix (DPO, Architect, Dev)

---

## 1. CloudFront Logging with IP Masking

### 1.1 The Problem

CloudFront access logs contain the full client IP address in the `c-ip` field. Under the no-cookie, zero-tracking policy established in Brief #2, we cannot store raw IP addresses. The DPO confirmed in their post-launch review (v0.2.24) that hashed IPs are still personal data under GDPR recital 26, but are acceptable for security/abuse prevention with documented legitimate interest.

The application already uses SHA-256 with a daily rotating salt for IP hashing (confirmed in DPO review). The CloudFront logging pipeline must apply the same hashing before any log record is persisted to the cache service.

### 1.2 IP Masking Options Assessment

| Option | Where It Runs | Latency Impact | Cost | Complexity | Verdict |
|--------|--------------|----------------|------|------------|---------|
| **A. Lambda@Edge** | At CloudFront edge, modifies log records | Adds latency to every request | ~$0.60/million requests | High -- triggered on every request, operates on request/response events, cannot directly modify log files | **REJECT** -- Lambda@Edge intercepts requests, not log files. It cannot mask IPs in CloudFront log output. |
| **B. CloudFront Function** | At CloudFront edge, JS runtime | Sub-millisecond | ~$0.10/million invocations | Low -- but same problem as Lambda@Edge: operates on request flow, not on log data | **REJECT** -- same limitation. CloudFront functions modify requests/responses, not log file content. |
| **C. S3 Event + Post-Processing Lambda** | S3 triggers Lambda when CloudFront writes a log file | No request latency impact | Lambda: ~$0.20/million invocations. S3 events: free. | Medium | **RECOMMENDED** |
| **D. Scheduled Batch Processing** | Lambda on schedule (every 5-15 min) | No request latency. Processing delay = schedule interval | Lambda: minimal (runs periodically) | Low | **ACCEPTABLE FALLBACK** |

### 1.3 Recommended Approach: Post-Processing Pipeline (Option C)

CloudFront writes raw log files to a staging prefix in S3. An S3 event notification triggers a Lambda function that reads the raw log, hashes the IP address, writes the masked version to the cache service, and deletes the raw file.

```
                         RAW LOGS (temporary)
                              |
CloudFront ──> S3 Bucket ─────┤ s3://sgraph-send-logs-{env}/
               (staging)      │     cloudfront-raw/
                              │         {distribution-id}.YYYY-MM-DD-HH.{unique}.gz
                              │
                              ▼
                    S3 Event Notification
                              │
                              ▼
                   ┌──────────────────────┐
                   │  IP Masking Lambda   │
                   │                      │
                   │  1. Read raw log     │
                   │  2. Decompress (.gz) │
                   │  3. Parse W3C fields │
                   │  4. Hash c-ip field: │
                   │     SHA-256(ip+salt) │
                   │  5. Hash c-client-ip │
                   │     (same treatment) │
                   │  6. Write to cache   │
                   │     service via      │
                   │     temporal path    │
                   │  7. Delete raw file  │
                   │     from staging     │
                   └──────────┬───────────┘
                              │
                              ▼
                    Cache Service (Memory-FS)
                         │
                         ├── /cloudfront-logs/
                         │     {cache-id}/
                         │       year/month/day/hour/
                         │         masked-log-{timestamp}.json
                         │       latest/
                         │         current-hour.json
                         │
                         └── (feeds LETS aggregation pipeline)
```

### 1.4 IP Masking Implementation Detail

The masking Lambda applies the same algorithm already used by the application:

```
Input:   c-ip = "203.0.113.42"
Salt:    daily_salt = SHA-256(date + secret_key)  # rotates at midnight UTC
Output:  ip_hash = SHA-256("203.0.113.42" + daily_salt) = "a7f3b2..."

Stored:  ip_hash (hex string, 64 chars)
Deleted: original c-ip value -- never persisted
```

**Fields masked in each CloudFront log record:**

| CloudFront Field | Action |
|-----------------|--------|
| `c-ip` | Replace with `SHA-256(value + daily_salt)` |
| `x-forwarded-for` | Replace with `SHA-256(value + daily_salt)` -- if present |
| All other fields | Retain as-is (path, status, user-agent, timing, bytes, etc.) |

**Output format:** JSON (not W3C text). Each log entry becomes a JSON object stored in the cache service temporal path. JSON is easier to aggregate in the LETS pipeline than tab-separated W3C format.

### 1.5 Raw Log Retention and Deletion

Raw logs (with unmasked IPs) must be deleted immediately after processing. The staging prefix must have:

- **S3 Lifecycle Rule:** Auto-delete objects older than 1 hour (safety net if Lambda fails)
- **Lambda deletes after processing:** Each raw file is deleted immediately after the masked version is written
- **No human access to staging prefix:** IAM policy restricts the staging prefix to the masking Lambda only

This means raw IPs exist for seconds (Lambda processing time) to at most 1 hour (lifecycle safety net). The DPO must confirm this retention window is acceptable.

### 1.6 CloudFront Log Fields We Need for Analytics

These are the fields that replace Google Analytics capabilities:

| CloudFront Field | Analytics Use | GA Equivalent |
|-----------------|---------------|---------------|
| `date` + `time` | Temporal analysis | Session timestamp |
| `cs-uri-stem` | Page views, file downloads | Page path |
| `sc-status` | Error rates, success rates | -- |
| `cs(User-Agent)` | Browser/OS breakdown | Browser, OS |
| `cs(Referer)` | Traffic sources | Referrer |
| `sc-bytes` | Bandwidth tracking | -- |
| `time-taken` | Performance monitoring | Page load time |
| `ip_hash` (derived) | Unique visitor approximation (daily) | Users (daily) |
| `x-edge-result-type` | Cache hit/miss ratio | -- |
| `x-edge-response-result-type` | CDN performance | -- |
| `cs-protocol` | HTTP vs HTTPS | -- |

**What we gain over GA:** True server-side data (not client-reported), zero cookies, no consent required, no third-party data sharing, no JavaScript dependency, accurate bot detection via `cs(User-Agent)`.

**What we lose vs GA:** Cross-session user identity (GA's `_ga` cookie tracked users across sessions -- we intentionally do not do this), real-time page interaction events (scroll, click). These are acceptable tradeoffs for a zero-cookie privacy product.

---

## 2. AWS Cost Data Collection Architecture

### 2.1 Data Source: AWS Cost Explorer API

AWS Cost Explorer provides programmatic access to cost and usage data. We access it via `osbot-aws` (never boto3 directly).

```
                    AWS Cost Explorer API
                           │
                           │  (via osbot-aws)
                           │
                           ▼
                ┌─────────────────────┐
                │  Cost Collector     │
                │  Lambda (scheduled) │
                │                     │
                │  1. Load high-water │
                │     mark (last      │
                │     collected date) │
                │  2. Query Cost      │
                │     Explorer:       │
                │     - GetCostAndUsage│
                │     - Granularity:  │
                │       DAILY         │
                │     - Group by:     │
                │       SERVICE,      │
                │       USAGE_TYPE    │
                │  3. Save to cache   │
                │     service via     │
                │     temporal path   │
                │  4. Update high-    │
                │     water mark      │
                └──────────┬──────────┘
                           │
                           ▼
                  Cache Service (Memory-FS)
                       │
                       ├── /aws-costs/
                       │     {cache-id}/
                       │       year/month/day/
                       │         daily-cost-{date}.json
                       │       latest/
                       │         current-day.json
                       │
                       └── (feeds LETS aggregation pipeline)
```

### 2.2 Cost Data Schema (for Architect to Confirm)

Each daily cost record stored in the cache service:

```json
{
  "date": "2026-02-13",
  "collected_at": "2026-02-13T14:30:00Z",
  "total_usd": 0.47,
  "by_service": {
    "AWS Lambda": {
      "amount_usd": 0.02,
      "usage_quantity": 1523,
      "usage_unit": "Requests"
    },
    "Amazon S3": {
      "amount_usd": 0.08,
      "usage_quantity": 0.12,
      "usage_unit": "GB"
    },
    "Amazon CloudFront": {
      "amount_usd": 0.15,
      "usage_quantity": 2.3,
      "usage_unit": "GB-Out"
    },
    "Amazon CloudWatch": {
      "amount_usd": 0.03,
      "usage_quantity": 5,
      "usage_unit": "Metrics"
    },
    "AWS CloudTrail": {
      "amount_usd": 0.00,
      "usage_quantity": 1,
      "usage_unit": "Trail"
    }
  },
  "by_usage_type": {
    "Lambda-Requests": 0.01,
    "Lambda-Duration": 0.01,
    "S3-Requests-Tier1": 0.02,
    "S3-TimedStorage-ByteHrs": 0.06,
    "CloudFront-DataTransfer-Out": 0.15
  }
}
```

### 2.3 LETS Aggregation Cascade for Cost Data

```
DAILY COST (raw from Cost Explorer, saved per day)
    │
    ▼
WEEKLY AGGREGATION (sum of 7 daily records)
    │  - Total spend
    │  - Spend by service
    │  - Week-over-week delta (%)
    │
    ▼
MONTHLY AGGREGATION (sum of daily records for the month)
    │  - Total spend
    │  - Spend by service
    │  - Projected monthly run-rate (daily average x days in month)
    │  - Month-over-month delta (%)
    │
    ▼
UNIT ECONOMICS (correlate with traffic data)
    │  - Cost per request = total_cost / total_requests
    │  - Cost per transfer = total_cost / completed_transfers
    │  - Cost per active user = total_cost / unique_ip_hashes
    │  - Storage cost per GB = s3_cost / total_stored_gb
    │
    ▼
BUDGET ALERTS (compare against thresholds)
    - Alert if daily cost > $5
    - Alert if weekly cost > $25
    - Alert if monthly projected > $100
```

### 2.4 Unit Economics Correlation

The cost collector output is joined with the CloudFront log aggregations to produce unit economics:

| Metric | Formula | Source Data |
|--------|---------|-------------|
| Cost per request | `daily_total_usd / daily_cloudfront_requests` | Cost Explorer + CloudFront logs |
| Cost per file transfer | `daily_total_usd / daily_completed_transfers` | Cost Explorer + App events |
| Cost per active user | `daily_total_usd / daily_unique_ip_hashes` | Cost Explorer + CloudFront logs |
| Storage cost per GB | `daily_s3_cost / total_s3_stored_gb` | Cost Explorer + S3 metrics |
| CDN cost per GB served | `daily_cloudfront_cost / daily_cloudfront_bytes_out` | Cost Explorer + CloudFront logs |

These metrics are calculated as part of the LETS daily aggregation and stored in the cache service for the analytics UI to read.

### 2.5 Cost Explorer API Constraints

| Constraint | Detail | Mitigation |
|-----------|--------|------------|
| API cost | $0.01 per GetCostAndUsage request | Collect once daily (max $0.31/month) |
| Data delay | Cost data available ~24 hours after usage | Collector runs for previous day's data |
| Granularity | DAILY is the finest granularity | Sufficient for our needs |
| Lookback | 12 months of data available | Initial backfill: collect all available history on first run |

---

## 3. Updated Collector Pipeline -- Cache Service Integration

### 3.1 Architecture Change from Brief #1

Brief #1 designed the collector pipeline with a standalone S3 data lake as the storage target. Brief #2 replaces this with the cache service (built on Memory-FS).

**Before (Brief #1):**
```
Data Sources --> Collectors --> S3 Data Lake --> Visualisation
                                (standalone bucket)
```

**After (Brief #2):**
```
Data Sources --> Collectors --> Cache Service (Memory-FS) --> LETS --> Analytics UI
                                (cache IDs, temporal paths,
                                 high-water marks, aggregations)
```

The S3 bucket still exists as the backing store for Memory-FS in production, but the application interacts only with the cache service abstraction. The collector never writes directly to S3.

### 3.2 Complete Pipeline Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│                        DATA SOURCES                              │
├────────────┬──────────────┬────────────────┬─────────────────────┤
│ CloudFront │  Lambda      │  Application   │  AWS Cost           │
│ Access     │  CloudWatch  │  Events        │  Explorer           │
│ Logs       │  Logs        │                │                     │
│ (S3)       │  (CloudWatch)│  (in-app)      │  (API)              │
└─────┬──────┴──────┬───────┴───────┬────────┴─────────┬───────────┘
      │             │               │                  │
      ▼             ▼               ▼                  ▼
┌──────────────────────────────────────────────────────────────────┐
│                      COLLECTORS (Lambda functions)               │
│                                                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────────┐│
│  │ CloudFront  │ │ CloudWatch  │ │ App Event   │ │ Cost       ││
│  │ Log         │ │ Log         │ │ Collector   │ │ Collector  ││
│  │ Collector   │ │ Collector   │ │             │ │            ││
│  │             │ │             │ │             │ │            ││
│  │ + IP Mask   │ │ (no PII)   │ │ (in-app     │ │ (scheduled ││
│  │ + W3C->JSON │ │             │ │  already)   │ │  daily)    ││
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └─────┬──────┘│
│         │               │               │              │        │
│         └───────────┬───┘               │              │        │
│                     │                   │              │        │
│         LOAD ───────┤ Read high-water mark from cache service   │
│         EXTRACT ────┤ Fetch new data since high-water mark      │
│         TRANSFORM ──┤ Normalise format, mask PII                │
│         SAVE ───────┤ Write to cache service temporal path      │
│                     │ Update high-water mark                    │
└─────────────────────┴───────────────────┴──────────────┴────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────────┐
│                    CACHE SERVICE (Memory-FS)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Source Cache Entries (one cache ID per data source)       │   │
│  │                                                          │   │
│  │  cloudfront-logs/{cache-id}/                             │   │
│  │    year/month/day/hour/  (temporal -- immutable)         │   │
│  │    latest/               (current hour -- overwritten)   │   │
│  │    _metadata/high-water-mark.json                        │   │
│  │                                                          │   │
│  │  cloudwatch-logs/{cache-id}/                             │   │
│  │    year/month/day/hour/                                  │   │
│  │    latest/                                               │   │
│  │    _metadata/high-water-mark.json                        │   │
│  │                                                          │   │
│  │  app-events/{cache-id}/                                  │   │
│  │    year/month/day/hour/                                  │   │
│  │    latest/                                               │   │
│  │    _metadata/high-water-mark.json                        │   │
│  │                                                          │   │
│  │  aws-costs/{cache-id}/                                   │   │
│  │    year/month/day/                                       │   │
│  │    latest/                                               │   │
│  │    _metadata/high-water-mark.json                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ LETS Aggregation Entries (computed, cached)              │   │
│  │                                                          │   │
│  │  aggregations/30min/{cache-id}/                          │   │
│  │    year/month/day/hour/  (30-min windows)                │   │
│  │    latest/                                               │   │
│  │                                                          │   │
│  │  aggregations/hourly/{cache-id}/                         │   │
│  │    year/month/day/                                       │   │
│  │    latest/                                               │   │
│  │                                                          │   │
│  │  aggregations/daily/{cache-id}/                          │   │
│  │    year/month/                                           │   │
│  │    latest/                                               │   │
│  │                                                          │   │
│  │  aggregations/monthly/{cache-id}/                        │   │
│  │    year/                                                 │   │
│  │    latest/                                               │   │
│  │                                                          │   │
│  │  unit-economics/{cache-id}/                              │   │
│  │    year/month/day/                                       │   │
│  │    latest/                                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────┬───────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                    ANALYTICS UI (Admin)                           │
│                                                                  │
│  Reads from cache service:                                       │
│  - aggregations/*/latest/  for real-time dashboards              │
│  - aggregations/daily/     for historical views                  │
│  - unit-economics/latest/  for cost tracking                     │
└──────────────────────────────────────────────────────────────────┘
```

### 3.3 High-Water Mark Pattern (Updated for Cache Service)

Each collector stores its high-water mark inside its own cache entry under `_metadata/`:

```json
{
  "source": "cloudfront-logs",
  "last_processed_file": "E1234ABCDE.2026-02-13-14.a1b2c3d4.gz",
  "last_processed_timestamp": "2026-02-13T14:32:00Z",
  "files_processed_total": 1847,
  "last_run_at": "2026-02-13T14:35:12Z",
  "last_run_duration_ms": 342,
  "last_run_records_processed": 23
}
```

```json
{
  "source": "aws-costs",
  "last_collected_date": "2026-02-12",
  "last_run_at": "2026-02-13T06:00:00Z",
  "last_run_duration_ms": 1200,
  "days_collected_total": 14
}
```

The high-water mark prevents re-processing. Each collector run is idempotent -- running it twice for the same period produces the same output. This is a core property of the LETS pattern: safe to re-run, never duplicates data.

### 3.4 Collector Scheduling

| Collector | Trigger | Frequency | Rationale |
|-----------|---------|-----------|-----------|
| CloudFront Log Collector | S3 Event (PutObject) | On every new log file (~every 5-10 min when traffic exists) | Near-real-time. CloudFront writes logs to S3 periodically. |
| CloudWatch Log Collector | EventBridge Schedule | Every 15 minutes | Batch collection. CloudWatch logs accumulate continuously. |
| App Event Collector | In-application (synchronous) | On every event | Events are written to cache service as they happen. No separate collector needed. |
| Cost Collector | EventBridge Schedule | Once daily at 06:00 UTC | Cost data updates daily with ~24h delay. |

### 3.5 Google Analytics Collector -- REMOVED

Brief #2 removes Google Analytics. The GA collector from the Brief #1 response (`google-analytics/YYYY/MM/DD/report.json`) is no longer needed. Any existing GA data in the S3 data lake should be retained as historical record but no new collection is required.

---

## 4. Cost Estimates for Expanded Logging Scope

### 4.1 Beta Traffic Assumptions

| Parameter | Value | Source |
|-----------|-------|--------|
| Requests/day | ~500-1000 | Post-launch estimate (friendlies + waiting list) |
| File transfers/day | ~20-50 | Subset of requests that are actual transfers |
| Average file size | ~5 MB | Assumption for cost modelling |
| CloudFront log file size | ~1 KB per 100 requests | Standard CloudFront log density |
| Active days/month | ~25 | Weekday-heavy during beta |

### 4.2 Monthly Cost Breakdown

| Component | What It Costs | Monthly Estimate | Notes |
|-----------|--------------|-----------------|-------|
| **CloudFront Access Logs** | S3 storage + PutObject | $0.01 | ~750 log files/month at ~1KB each |
| **IP Masking Lambda** | Invocations + duration | $0.02 | ~750 invocations, <100ms each. Free tier covers this. |
| **S3 Event Notifications** | Free | $0.00 | No charge for S3 event notifications |
| **Observability S3 Bucket** | Storage + requests | $0.05 | Masked logs + aggregations. Tiny at beta scale. |
| **Cost Explorer API** | $0.01/request | $0.31 | One request per day |
| **CloudWatch Log Collector Lambda** | Invocations + duration | $0.05 | ~2,880 invocations/month (every 15 min). Free tier. |
| **EventBridge Schedules** | Free for first 10 | $0.00 | We need 2 schedules |
| **CloudTrail (management events)** | First trail free | $0.00 | Already recommended in Brief #1 response |
| **S3 Server Access Logs** | S3 storage only | $0.01 | Minimal at beta traffic |
| **Lambda Insights** | $0.01/function/hour | $0.50 | 2 functions, enhanced monitoring |
| | | | |
| **Subtotal: New logging infra** | | **$0.95** | |
| **Existing: Lambda CloudWatch** | Already active | ~$0.50 | Default Lambda logging |
| | | | |
| **TOTAL OBSERVABILITY COST** | | **~$1.45/month** | |

### 4.3 Scaling Projections

| Traffic Level | Requests/month | Estimated Observability Cost | Cost per Request |
|--------------|----------------|------------------------------|-----------------|
| Beta (now) | ~25,000 | ~$1.45 | $0.000058 |
| Early Adopters (100 users) | ~100,000 | ~$3.50 | $0.000035 |
| Growth (1,000 users) | ~1,000,000 | ~$12.00 | $0.000012 |
| Scale (10,000 users) | ~10,000,000 | ~$45.00 | $0.0000045 |

The observability cost per request **decreases** with scale because fixed costs (Lambda Insights, Cost Explorer) are amortized across more requests. At scale, observability adds less than $0.00001 per request.

### 4.4 Cost Comparison: GA vs Server-Side Analytics

| Aspect | Google Analytics (removed) | Server-Side Analytics (new) |
|--------|---------------------------|----------------------------|
| Direct cost | Free (GA4) | ~$1.45/month at beta |
| Hidden cost | Cookie consent infrastructure, GDPR compliance overhead, DPO time | None |
| Privacy cost | Third-party data sharing, user tracking, trust erosion | Zero -- no cookies, no third-party, no consent needed |
| Data quality | Client-reported (can be blocked/spoofed) | Server-side truth (every request logged) |
| Data ownership | Google owns the processing | We own everything |
| **Net assessment** | **More expensive when compliance overhead is counted** | **Cheaper total cost of ownership** |

---

## 5. Coordination Matrix

### 5.1 DPO Coordination (IP Masking Sign-Off)

| # | Coordination Point | DevOps Needs from DPO | Status | Blocks |
|---|-------------------|----------------------|--------|--------|
| C1 | IP masking algorithm approval | Confirm SHA-256 + daily salt is acceptable for CloudFront logs (same as current app-level hashing) | **PENDING** | CloudFront log enablement |
| C2 | Raw log retention window | Confirm that raw IP exposure of seconds-to-1-hour (processing time + lifecycle safety net) is acceptable | **PENDING** | Staging bucket lifecycle config |
| C3 | Masked log retention policy | Define how long masked logs should be retained. Recommendation: 90 days in temporal path, then archive to Glacier. | **PENDING** | Cache service retention config |
| C4 | User-agent as PII assessment | CloudFront logs include full User-Agent strings. In rare cases these can be fingerprinting vectors. Does DPO require any masking? Recommendation: retain as-is (low risk). | **PENDING** | Log schema definition |
| C5 | Cost data classification | AWS cost data contains no PII. Confirm no DPO review needed for cost collection. | **PENDING** | Cost collector deployment |
| C6 | GA removal data impact | Confirm that removing GA eliminates all cookie/consent requirements. DPO should produce formal recommendation per Brief #2. | **PENDING** -- DPO already flagged GA issues in v0.2.24 | GA removal timeline |

**Critical path:** C1 and C2 must be resolved before CloudFront logging can be enabled. DevOps will not enable logging until DPO provides written sign-off on the IP masking approach.

### 5.2 Architect Coordination (Cache Service Schema)

| # | Coordination Point | DevOps Needs from Architect | Status | Blocks |
|---|-------------------|----------------------------|--------|--------|
| A1 | Cache service API for collectors | How do collectors write to the cache service? What is the Python API? (e.g., `cache_service.write_temporal(source, data)`) | **PENDING** | All collector implementation |
| A2 | Cache ID allocation for data sources | Each data source needs a cache ID. How are these allocated? DevOps proposes: one cache ID per source (`cloudfront-logs`, `cloudwatch-logs`, `aws-costs`, `app-events`). | **PENDING** | Cache service structure |
| A3 | Temporal path format | Brief #2 describes `year/month/day/hour`. Confirm exact path format and file naming convention. | **PENDING** | Collector output format |
| A4 | High-water mark storage location | DevOps proposes `_metadata/high-water-mark.json` within each source's cache entry. Architect to confirm this is consistent with cache service design. | **PENDING** | Collector idempotency |
| A5 | Aggregation trigger mechanism | LETS aggregations -- are these triggered on-demand (when UI requests data), on schedule (EventBridge), or on-write (when new data arrives)? DevOps needs to know for scheduling. | **PENDING** | Aggregation pipeline |
| A6 | Cost data schema | DevOps has proposed a schema in Section 2.2. Architect to review and confirm or modify. | **PENDING** | Cost collector implementation |
| A7 | Unit economics join logic | How do cost aggregations join with traffic aggregations? Same cache entry or separate with cross-references? | **PENDING** | Unit economics dashboard |

### 5.3 Dev Coordination

| # | Coordination Point | DevOps Provides to Dev | Status |
|---|-------------------|----------------------|--------|
| D1 | Masked log format | JSON schema for masked CloudFront log records (Section 1.6) | Ready when DPO approves |
| D2 | Cost data format | JSON schema for daily cost records (Section 2.2) | Ready when Architect approves |
| D3 | S3 bucket names and prefixes | Staging bucket, observability bucket, prefix structure | Ready to define |
| D4 | EventBridge schedule definitions | Schedule expressions for CloudWatch and Cost collectors | Ready to define |
| D5 | IAM roles for collector Lambdas | Permissions needed: S3 read/write, CloudWatch read, Cost Explorer read, cache service write | Ready to define |

### 5.4 Coordination Timeline

```
Week 1 (13-14 Feb):
  ├── DPO: Review and sign off on IP masking approach (C1, C2)
  ├── Architect: Confirm cache service API and schema (A1-A4)
  └── DevOps: Prepare S3 bucket, IAM roles, EventBridge schedules

Week 1-2 (14-17 Feb): [Blocked on DPO + Architect]
  ├── DevOps: Enable CloudFront logging to staging prefix
  ├── DevOps: Deploy IP masking Lambda
  ├── DevOps: Deploy Cost collector Lambda
  └── DevOps: Enable S3 server access logs + CloudTrail

Week 2 (17-19 Feb):
  ├── Dev: Implement LETS aggregation pipeline in cache service
  ├── DevOps: Verify end-to-end flow (log → mask → cache → aggregate)
  └── DevOps: Deploy CloudWatch log collector

Week 2-3 (19-21 Feb):
  ├── Dev: Build analytics UI reading from cache service aggregations
  ├── DevOps: Enable unit economics calculations
  └── DPO: Confirm GA can be removed (analytics replacement functional)
```

---

## 6. Action Items

| # | Action | Priority | Owner | Blocks | Depends On |
|---|--------|----------|-------|--------|------------|
| 1 | Create observability S3 bucket (`sgraph-send-logs-{env}`) with staging prefix | P2 | DevOps | All logging | Nothing |
| 2 | Configure S3 lifecycle: auto-delete staging prefix objects > 1 hour | P2 | DevOps | Raw log cleanup | Action 1 |
| 3 | Request DPO sign-off on IP masking approach (SHA-256 + daily salt) | P2 | DevOps/DPO | CloudFront enablement | Nothing |
| 4 | Request Architect confirmation on cache service write API | P2 | DevOps/Architect | All collectors | Nothing |
| 5 | Enable CloudFront access logging to staging prefix | P2 | DevOps | Log data flow | Actions 1, 3 |
| 6 | Deploy IP masking Lambda (S3 event trigger) | P2 | DevOps | Masked log production | Actions 1, 3, 4 |
| 7 | Deploy Cost collector Lambda (EventBridge daily schedule) | P2 | DevOps | Cost data collection | Action 4 |
| 8 | Enable S3 server access logs (per Brief #1, still active) | P2 | DevOps | Storage visibility | Action 1 |
| 9 | Verify CloudTrail is active (per Brief #1, still active) | P2 | DevOps | Audit trail | Nothing |
| 10 | Enable Lambda Insights on both functions | P2 | DevOps | Performance visibility | Nothing |
| 11 | Deploy CloudWatch log collector Lambda | P2 | DevOps | Lambda log aggregation | Action 4 |
| 12 | Remove GA collector from pipeline design (superseded by Brief #2) | -- | DevOps | Cleanup | Nothing |

### Actions Carried Forward from Brief #1 (Still Active)

| Original # | Action | Status |
|-----------|--------|--------|
| Brief #1 #1 | Create logging S3 bucket | Subsumed into Action 1 above |
| Brief #1 #2 | Enable CloudFront access logs | Subsumed into Action 5 above (now with IP masking) |
| Brief #1 #3 | Enable S3 server access logs | Action 8 above |
| Brief #1 #4 | Verify CloudTrail | Action 9 above |
| Brief #1 #5 | Lambda Insights | Action 10 above |
| Brief #1 #6 | CORS header check in smoke tests | Still active, unchanged |
| Brief #1 #9 | Google Analytics API setup | **CANCELLED** -- GA removed per Brief #2 |

---

## 7. Decisions Proposed

| ID | Decision | Rationale | Status |
|----|----------|-----------|--------|
| D-DevOps-001 | Use post-processing Lambda for IP masking (not Lambda@Edge or CloudFront Function) | Lambda@Edge and CloudFront Functions operate on request flow, not log files. Post-processing is the only viable approach for masking IPs in CloudFront access logs. | PROPOSED -- for Architect review |
| D-DevOps-002 | Raw CloudFront logs retained max 1 hour before deletion | Minimise PII exposure window. Lifecycle safety net for Lambda failure. | PROPOSED -- for DPO approval |
| D-DevOps-003 | CloudFront logs converted from W3C to JSON during masking | JSON is easier to aggregate in LETS pipeline and read in the analytics UI. | PROPOSED -- for Architect review |
| D-DevOps-004 | Cost Explorer queried once daily at 06:00 UTC | Cost data updates daily with ~24h delay. One query per day is sufficient and costs $0.01. | PROPOSED |
| D-DevOps-005 | GA collector removed from pipeline design | Brief #2 explicitly removes Google Analytics. No GA data collection needed. | PROPOSED -- aligns with Brief #2 directive |
| D-DevOps-006 | Each data source gets its own cache ID in the cache service | Clean separation of concerns. Each source manages its own high-water mark and temporal path independently. | PROPOSED -- for Architect review |

---

## 8. Risk Register

| Risk | Severity | Likelihood | Mitigation |
|------|----------|------------|------------|
| DPO sign-off delayed -- CloudFront logging blocked | Medium | Medium | DevOps prepares everything except the final enable. Ready to flip the switch within minutes of DPO approval. |
| IP masking Lambda fails -- raw logs accumulate | Medium | Low | S3 lifecycle auto-deletes after 1 hour. CloudWatch alarm on Lambda errors. Dead letter queue for failed processing. |
| Cache service API not ready when collectors are built | Medium | Medium | Collectors can be built against a local Memory-FS mock. Integration tested when cache service API is defined. |
| Cost Explorer API returns incomplete data for new accounts | Low | Medium | Cost Explorer can take up to 24-48 hours for new service usage to appear. Initial data may be incomplete. Accept and document. |
| CloudFront log volume higher than estimated | Low | Low | At 10x estimated traffic, costs would still be under $5/month. Not a financial risk at beta scale. |

---

## 9. Summary

Brief #2 elevates CloudFront logs from "nice-to-have observability" to "primary analytics data source replacing Google Analytics." This changes the pipeline architecture in three ways:

1. **IP masking is now a hard prerequisite** -- not a future improvement. No logging without DPO approval.
2. **Cache service replaces standalone S3 data lake** -- collectors write to cache service temporal paths, not raw S3 prefixes. The LETS aggregation pattern handles all queries.
3. **AWS cost data joins the pipeline** -- same LETS pattern, different data source. Enables unit economics from day one.

The total additional cost is approximately **$1.45/month at beta traffic** -- less than a cup of coffee. The cost decreases per-request as traffic scales. This is materially cheaper than the hidden compliance overhead of Google Analytics.

**Two blockers must be resolved before implementation begins:**
- DPO must sign off on the IP masking approach (C1, C2)
- Architect must confirm the cache service write API (A1-A4)

Everything else is ready to build.

---

*Previous DevOps reviews:*
- `team/roles/devops/reviews/26-02-13/v0.2.24__response-to-daily-brief__13-feb.md` (Brief #1 response)
- `team/roles/devops/reviews/26-02-13/v0.2.24__status-report__post-launch.md`
- `team/roles/devops/reviews/26-02-12/v0.2.15__aws-deployment-documentation.md`
- `team/roles/devops/reviews/26-02-12/v0.2.15__briefing__mvp-review-devops-tasks.md`
- `team/roles/devops/reviews/26-02-10/v0.2.1__response-to-infrastructure-brief.md`
