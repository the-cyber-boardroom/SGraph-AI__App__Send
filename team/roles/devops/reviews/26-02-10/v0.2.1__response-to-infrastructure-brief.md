# v0.2.1 — DevOps Response to MVP Infrastructure Brief

**Version:** v0.2.1
**Date:** 2026-02-10
**Role:** DevOps
**Responding to:** `team/humans/dinis_cruz/briefs/2026-02-10/v0.1.4__briefs__focus-on-mvp-release-infrastructure.md`

---

## 1. Current State Assessment

### What Exists

| Component | Status | Location |
|---|---|---|
| CI pipeline (dev) | Active | `.github/workflows/ci-pipeline__dev.yml` |
| CI pipeline (main) | Active | `.github/workflows/ci-pipeline__main.yml` |
| Base CI workflow | Active | `.github/workflows/ci-pipeline.yml` |
| Unit test runner | Working | `tests/unit/` — 7 tests, all pass |
| PyPI publish | Working | `sgraph-ai-app-send` on PyPI |
| Tag auto-increment | Working | Via `OSBot-GitHub-Actions` |
| Admin Lambda deploy class | Scaffolded | `Deploy__Service.py` |
| Lambda handler (admin) | Working | `lambda_handler__admin.py` |

### What's Missing

| Component | Brief Requirement | Priority |
|---|---|---|
| Lambda deploy action | GitHub Action to deploy to AWS Lambda | P0 — Critical |
| Docker build/push | Dockerfile + GitHub Action | P0 |
| ECS Fargate task def | Task definition + service config | P1 |
| EC2 deploy action | EC2 instance setup + code deploy | P1 |
| AMI bake action | Packer or EC2 image builder | P2 |
| GCP Cloud Run deploy | Cloud Run service config + action | P2 |
| Smoke test action | Post-deploy health + functionality checks | P0 |
| LocalStack integration | S3 integration test in CI | P1 |
| Playwright E2E action | Browser tests against running app | P1 |
| Post-publish smoke | Install from PyPI + validate | P1 |

---

## 2. Deployment Target Implementation Plan

### 2.1 Lambda (P0 — First Target)

The `Deploy__Service` class already exists. What's needed:

```yaml
# New: .github/workflows/deploy__lambda.yml
# Trigger: after tests pass on dev branch
# Steps:
#   1. Package Lambda (using Deploy__Service or osbot-aws deploy)
#   2. Deploy public Lambda function
#   3. Deploy admin Lambda function
#   4. Run smoke tests against Lambda URLs
```

**Configuration needed:**
- GitHub Secrets: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION`
- Lambda names: `sgraph-send-dev-admin`, `sgraph-send-dev-public`
- Lambda URL Function: auto-created when Lambda has `FunctionUrlAuthType: NONE` (public) or `AWS_IAM` (admin)

**Dependency:** The `Deploy__Serverless__Fast_API` base class from `osbot-fast-api-serverless` handles Lambda packaging, layer creation, and deployment. We configure via `Deploy__Service` subclass.

### 2.2 Docker (P0 — Second Target)

```dockerfile
# New: Dockerfile (project root)
FROM python:3.12-slim

WORKDIR /app
COPY pyproject.toml poetry.lock* ./
RUN pip install poetry && poetry install --only main --no-interaction

COPY sgraph_ai_app_send/ sgraph_ai_app_send/
COPY sgraph_ai_app_send__ui__admin/ sgraph_ai_app_send__ui__admin/
COPY sgraph_ai_app_send__ui__user/ sgraph_ai_app_send__ui__user/

# Build arg selects admin or user entry point
ARG SERVICE_TYPE=admin
ENV SERVICE_TYPE=${SERVICE_TYPE}
ENV SGRAPH_SEND_STORAGE_BACKEND=memory

EXPOSE 8080
CMD ["uvicorn", "sgraph_ai_app_send.entrypoints.app:app", "--host", "0.0.0.0", "--port", "8080"]
```

**GitHub Action:** Build → Push to ECR (or GHCR) → Run smoke tests against container.

### 2.3 ECS Fargate (P1)

Reuses the Docker image from 2.2. Infrastructure config:
- ECS Cluster: `sgraph-send-dev`
- Task Definition: CPU 256, Memory 512, container from ECR
- Service: desired count 1, Fargate launch type
- ALB or service connect for HTTPS

**Provisioning:** Terraform or CloudFormation template in `.infrastructure/` folder.

### 2.4 EC2 Instance (P1)

- Launch from Amazon Linux 2023 AMI
- User data script: install Python 3.12, pip install sgraph-ai-app-send from PyPI, start uvicorn via systemd
- Security group: 443 inbound, all outbound

### 2.5 AMI (P2)

- Packer template that bakes EC2 setup into an AMI
- GitHub Action: build AMI → launch test instance → smoke test → terminate

### 2.6 GCP Cloud Run (P2)

Reuses the Docker image from 2.2 (pushed to GCR or Artifact Registry).
- GitHub Secrets: `GCP_SERVICE_ACCOUNT_KEY`, `GCP_PROJECT_ID`
- Cloud Run service: same container, auto-scaling 0-1

---

## 3. CI Pipeline Evolution

### Current Pipeline (Working)

```
Push to dev → Run Unit Tests → Increment Tag
Push to main → Run Unit Tests → Increment Tag → Publish to PyPI
```

### Target Pipeline (Brief Requirements)

```
Push to dev →
  ├── Run Unit Tests (pytest, in-memory)
  ├── Run Integration Tests (LocalStack S3)
  ├── Increment Tag
  ├── Deploy to Lambda (dev)
  │   └── Smoke Test Lambda
  ├── Build Docker Image
  │   └── Smoke Test Container
  ├── Deploy to ECS Fargate (dev)
  │   └── Smoke Test Fargate
  ├── Deploy to EC2 (dev)
  │   └── Smoke Test EC2
  └── Run E2E Tests (Playwright against Lambda dev)

Push to main →
  ├── All of the above +
  ├── Publish to PyPI
  │   └── Post-Publish Smoke Test (clean install)
  ├── Bake AMI
  │   └── Smoke Test AMI
  └── Deploy to GCP Cloud Run
      └── Smoke Test GCP
```

### Recommended Phased Rollout

**Phase A (this sprint):**
1. Add Lambda deploy step to `ci-pipeline__dev.yml`
2. Add post-deploy smoke test
3. Add Dockerfile + container build step

**Phase B (next sprint):**
4. Add LocalStack integration tests to CI
5. Add Playwright E2E step
6. Add ECS Fargate deployment
7. Add post-publish smoke test to main pipeline

**Phase C (following sprint):**
8. Add EC2 deployment
9. Add AMI baking
10. Add GCP Cloud Run deployment

---

## 4. Smoke Test Specification

Every deployment target gets the same smoke test suite:

```bash
# smoke-test.sh <base-url>
curl -f "$BASE_URL/health"                          # Health check
curl -f "$BASE_URL/admin"                           # Admin UI loads (admin only)
curl -f "$BASE_URL/api/info"                        # API info endpoint
# Future: upload test file, download, verify
```

For the admin Lambda smoke test, the test must also:
- Verify auth is enforced (401 without token)
- Verify `/admin` static page loads
- Verify CORS headers are present

**Implementation:** Reusable composite GitHub Action at `.github/actions/smoke-test/action.yml`.

---

## 5. Environment Configuration

### Secrets Required Per Target

| Secret | Lambda | Docker | Fargate | EC2 | GCP |
|---|---|---|---|---|---|
| `AWS_ACCESS_KEY_ID` | Yes | No | Yes | Yes | No |
| `AWS_SECRET_ACCESS_KEY` | Yes | No | Yes | Yes | No |
| `AWS_REGION` | Yes | No | Yes | Yes | No |
| `SGRAPH_SEND_ADMIN_KEY` | Yes | Yes | Yes | Yes | Yes |
| `GCP_PROJECT_ID` | No | No | No | No | Yes |
| `GCP_SERVICE_ACCOUNT_KEY` | No | No | No | No | Yes |
| `ECR_REGISTRY` | No | Yes | Yes | No | No |

### Storage Backend Per Environment

| Environment | Backend | Config |
|---|---|---|
| CI tests | `memory` | Default (no config needed) |
| CI integration | `s3` | LocalStack endpoint |
| Dev Lambda | `s3` | S3 bucket per environment |
| Dev Docker | `disk` or `s3` | Configurable via env var |
| Prod (all targets) | `s3` | S3 bucket per environment |

---

## 6. Operational Concerns

### 6.1 Infrastructure as Code

All deployment configurations should live in `.infrastructure/`:
```
.infrastructure/
  lambda/          # Deploy__Service already handles this
  docker/          # Dockerfile, docker-compose.yml
  fargate/         # Task definition, service config
  ec2/             # User data script, security group
  ami/             # Packer template
  gcp/             # Cloud Run service.yaml
```

### 6.2 Cost Management

For dev environment, all targets should auto-shutdown or scale to zero:
- Lambda: naturally scales to zero
- Fargate: desired count 0 when not testing (CI spins up → test → tear down)
- EC2: spot instance, terminated after smoke test
- GCP: min instances = 0

### 6.3 Logging and Monitoring

Each deployment target needs:
- Structured JSON logs to stdout
- Health check endpoint at `/health`
- Memory-FS file-based observability (works on all targets)

---

## 7. Action Items for DevOps

- [ ] Create Lambda deploy GitHub Action (P0)
- [ ] Create Dockerfile (P0)
- [ ] Create container build/push GitHub Action (P0)
- [ ] Create reusable smoke test action (P0)
- [ ] Add Lambda deploy step to dev pipeline (P0)
- [ ] Create `.infrastructure/` directory structure (P1)
- [ ] Add LocalStack to CI for integration tests (P1)
- [ ] Create ECS Fargate task definition + deploy action (P1)
- [ ] Add Playwright E2E to CI (P1)
- [ ] Create EC2 deploy action (P2)
- [ ] Create AMI bake action (P2)
- [ ] Create GCP Cloud Run deploy action (P2)
- [ ] Add post-publish smoke test to main pipeline (P1)

---

*This review is the DevOps master file for the v0.1.4 infrastructure brief response.*
