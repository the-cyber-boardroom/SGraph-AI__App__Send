# Dev Briefing (Backend) — MVP Review Response

**From:** Conductor (on behalf of Dinis Cruz)
**To:** Dev
**Date:** 12/02/2026
**Version:** v0.2.15
**Source:** `team/humans/dinis_cruz/briefs/02/12/v0.2.10__review-of-user-site-mvp.md`

---

## Context

The MVP is working end-to-end on Lambda. Dinis has reviewed the backend code and identified significant Type_Safe and architectural issues that need to be addressed. This is a substantial body of work with a very specific execution sequence defined by the stakeholder.

**Critical instruction from Dinis:** "Please read in detail all the guidance in `library/dependencies/osbot-utils/type_safe`" — the Type_Safe capabilities are not being leveraged properly.

---

## Mandatory Reading Before Starting

Read these in order:

1. `library/dependencies/osbot-utils/type_safe/v3.63.4__for_llms__type_safe.md` — Core Type_Safe guide
2. `library/dependencies/osbot-utils/type_safe/v3.28.0__for_llms__osbot-utils-safe-primitives.md` — Safe primitives (100+ types)
3. `library/dependencies/osbot-utils/type_safe/v3.63.3__for_llms__type_safe__collections__subclassing_guide.md` — Type_Safe collections
4. `library/dependencies/osbot-utils/type_safe/v3.63.3__for_llms__type_safe__decorator_guide.md` — @type_safe decorator
5. `library/dependencies/memory-fs/v0.36.2__memory-fs__architecture-and-how-to-use-It.md` — Memory-FS architecture
6. `library/guides/development/code-formating/v3.63.4__for_llms__python_formatting_guide.md` — Python formatting guide

---

## Execution Sequence (follow exactly)

Dinis has defined a precise workflow. **Do not skip steps or reorder.**

### Phase 1: Review All Existing Todos

Review every `# todo` comment in the source code. The key files are:

**`Transfer__Service.py`** — 15+ todos covering:
- `transfers` and `payloads` should be Type_Safe collections, not raw `dict`
- Must use Memory-FS abstraction layer (not in-memory dicts)
- All method signatures need `@type_safe` decorator with typed parameters
- `transfer_id` should be `Transfer_Id(Random_Guid)` — full GUID for security
- All timestamps should use `Timestamp_Now()` not `datetime.now().isoformat()`
- Status values should be ENUMs not raw strings
- The `meta` dict should be a Type_Safe class
- `hash_ip` should use a separate class (see `Cache__Hash__Generator`)
- `upload_url` shouldn't be hardcoded in the service

**`Schema__Transfer.py`** — 2 todos:
- One schema class per file (split into separate files)
- Replace raw primitives with Type_Safe equivalents
- `content_type_hint : str = ""` is unnecessary with Type_Safe (empty string is default)

**`Routes__Transfers.py`** — 2 todos:
- Don't create new objects in route methods — service should return the objects
- Injection vulnerability in error messages (transfer_id reflected in HTTPException detail)
- All methods should return Type_Safe classes (with Pydantic bug workaround if needed)

**`test_lambda_handler__user.py`** — 1 todo:
- Status code 200 because test setup sets headers — needs clarification comment

### Phase 2: Identify Additional Similar Issues

After understanding the patterns Dinis is raising, review ALL code for similar issues:
- Raw `dict` usage where Type_Safe classes should be used
- Raw `str` where Safe primitives should be used
- Missing `@type_safe` decorators on public methods
- Hardcoded strings that should be constants or ENUMs
- Objects created in wrong layers (e.g., route layer creating data objects)

Add `# todo` comments to every instance found.

### Phase 3: Commit All Todos

Commit all the newly added `# todo` comments (the existing ones from Dinis + your new ones).

### Phase 4: Group Todos into Issues

Group related todos into logical bugs or tasks:
- Don't create one issue per todo
- Don't lose any todo either
- Create issues in `team/roles/dev/.issues/` (Dev's issues database)
- Create a logical grouping hierarchy so issues link effectively
- All issues should link to a parent "review" issue that tracks this entire review

### Phase 5: Annotate Source Code with Issue IDs

Replace `# todo` comments with issue references:
```python
# Before:
# todo: transfers and payloads should be type safe collections
# After:
# TASK-42 | open | Replace raw dicts with Type_Safe collections
```

Format: `# {type}-{id} | {status} | {title}`
- Reuse issue IDs across multiple todos that belong to the same issue

### Phase 6: Commit Issues and Code Annotations

Commit all issues and updated code annotations.

### Phase 7: Create Briefing with Visualizations

Create a briefing document with:
- Tables summarizing all issues by severity, type, affected file
- AsciiArt diagrams showing issue distribution
- Mermaid diagrams showing issue relationships and dependencies

### Phase 8: Create Fix Plan

For each issue/group:
- Estimated effort (S/M/L)
- Complexity (Low/Medium/High)
- Risk (Low/Medium/High)
- Dependencies on other issues

### Phase 9: Create Priority Phases

Map issues into implementation phases/groups:
- Create corresponding Issues-FS entries
- Define execution order

### Phase 10: Commit Plan

Commit the plan document.

### Phase 11: Check for Blocking Questions

If blocking questions exist → ask Dinis and stop.
If no questions → proceed to Phase 12.

### Phase 12: Apply Fixes (One Phase at a Time)

- Fix one phase/group
- Update `.issues/` database
- Update source code references
- Run tests — if passing, continue to next phase
- If failing, document and stop

### Phase 13: Write Debrief

Detailed debrief of:
- What was fixed
- What remains
- Next steps
- Questions or clarifications needed

---

## Key Type_Safe Patterns to Apply

### Safe Primitives to Use

| Current | Should Be | Notes |
|---|---|---|
| `transfer_id: str` | `Transfer_Id` (extending `Random_Guid`) | Full GUID, not 12-char hex |
| `file_size_bytes: int` | `Safe_UInt__FileSize` | Has `.to_kb()`, `.to_mb()` |
| `content_type_hint: str` | Custom `Safe_Str` or HTTP Content-Type primitive | |
| `status: str` | Enum class | `pending`, `completed`, `expired` |
| `created_at: str` | `Timestamp_Now` | Auto-generates on creation |
| `download_count: int` | `Safe_UInt` | Default 0, no need to assign |
| `ip_hash: str` | `Safe_Str__Hash` or `Safe_Str__SHA1` | 64-char SHA-256 hex |

### Type_Safe Collections

```python
# Instead of:
transfers : dict     # raw, untyped
payloads  : dict     # raw, untyped

# Use:
class Dict__Transfers(Type_Safe__Dict):
    expected_key_type   = Transfer_Id
    expected_value_type = Transfer__Record    # a Type_Safe class

class Dict__Payloads(Type_Safe__Dict):
    expected_key_type   = Transfer_Id
    expected_value_type = bytes
```

### @type_safe Decorator

```python
# Instead of:
def create_transfer(self, file_size_bytes, content_type_hint, sender_ip):

# Use:
@type_safe
def create_transfer(self, file_size_bytes : Safe_UInt__FileSize,
                          content_type_hint : str,
                          sender_ip        : str) -> Transfer__Initiated:
```

### Memory-FS Integration

The current in-memory `dict` storage should be replaced with Memory-FS:
- `Memory_FS__Latest` for transfer metadata (current state only)
- `Memory_FS__Latest` for payloads (binary mode)
- This enables swapping to S3 backend via configuration alone

Reference: `library/dependencies/memory-fs/v0.36.2__memory-fs__architecture-and-how-to-use-It.md`

---

## Test Changes Required

### Rename `test_Routes__Transfers` → `test_Routes__Transfers__client`

The existing test file (`test_Routes__Transfers.py`) tests via the FastAPI test client. Per Dinis:
- Rename file and class to `test_Routes__Transfers__client`
- Create a NEW `test_Routes__Transfers.py` that tests `Routes__Transfers` methods directly (no HTTP client)
- Create a test helper class that sets up test data (transfers in various states) for reuse

### Schema Tests

After splitting schemas into one-per-file, tests must follow the same structure.

---

## Deliverables

1. All todo annotations (Phase 2-3)
2. Issues in `team/roles/dev/.issues/` (Phase 4-6)
3. Briefing with visualizations: `team/roles/dev/reviews/26-02-12/v0.2.15__issues-briefing__type-safe-refactor.md` (Phase 7)
4. Fix plan: `team/roles/dev/reviews/26-02-12/v0.2.15__fix-plan__type-safe-refactor.md` (Phase 8-10)
5. Applied fixes with passing tests (Phase 12)
6. Debrief: `team/roles/dev/reviews/26-02-12/v0.2.15__debrief__type-safe-refactor.md` (Phase 13)
