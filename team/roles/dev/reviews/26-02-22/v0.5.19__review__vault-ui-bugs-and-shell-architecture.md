# Dev Review: Vault UI Bugs & User Shell Architecture Decision

**Version:** v0.5.19
**Date:** 22 Feb 2026
**Role:** Dev
**Team:** Explorer

---

## Executive Summary

Two rounds of vault UI bugs were discovered through manual testing. The first round (admin console) exposed 5 backend/frontend issues. The second round (user-facing vault) exposed 3 additional issues, one a critical key generation blocker. All bugs were fixed. A strategic decision was also captured: the user-facing app needs its own shell component (separate from the admin shell) to provide navigation and debug panel access.

---

## Bug Round 1: Admin Console Vault (5 issues)

| # | Issue | Root Cause | Fix |
|---|-------|-----------|-----|
| 1 | Oversized folder SVG fills entire empty state | `.pk-empty__icon` has no SVG size constraint | Added `.pk-empty__icon svg { width: 40px; height: 40px }` |
| 2 | "Key: unknown" in status bar | IndexedDB key records don't store `fingerprint` field; code falls back to `'unknown'` | Compute fingerprint on-the-fly via `pki.computeFingerprint(publicKey)` |
| 3 | 500 error on GET `/vault/index/{key}` | Route returns raw binary (encrypted bytes) which FastAPI can't JSON-serialize — `'utf-8' codec can't decode byte 0xbb'` | Base64-encode binary before returning: `dict(data=base64.b64encode(result).decode('ascii'))` |
| 4 | Folders/files don't render after creation | GET `/vault/folder/{key}/{guid}` returns dict directly, but JS expects `result.data` wrapper | Wrapped response in `dict(data=result)` |
| 5 | SG/Send logo slash looks like `\|` | `transform: rotate(-15deg)` at small font-size distorts `/` character | Removed rotation, matched user UI pattern: `font-weight: 800` |

### Files Changed (Round 1)
- `sgraph_ai_app_send/lambda__admin/fast_api/routes/Routes__Vault.py` — fixes #3, #4 (response shapes)
- `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.5/components/vault-manager/vault-manager.js` — fixes #1, #2
- `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.4/css/sg-brand.css` — fix #5

---

## Bug Round 2: User-Facing Vault (3 issues)

| # | Issue | Root Cause | Fix |
|---|-------|-----------|-----|
| 6 | "Generate Key Pair" button appears unresponsive | **CORRECTED**: Original diagnosis was wrong. `extractable: false` does NOT prevent public key export — W3C spec says public keys are always extractable. The `extractable: true` "fix" was a **security regression** (makes private key exportable, enabling XSS exfiltration) and was **reverted**. Real cause: RSA-4096 generation takes several seconds with no UI feedback beyond "Loading vault...", plus `_generateKeys()` had no error handling | Added try-catch to `_generateKeys()` with fallback to `'no-key'` state. Kept `extractable: false`. |
| 7 | "Loading vault..." spinner stuck forever | `_generateKeys()` has no try-catch; unhandled exception leaves state as `'loading'` permanently | Added try-catch with fallback to `'no-key'` state |
| 8 | Index/file responses mismatched | After route fixes, GET index/file return `{data: b64}` but user-vault expects `{encrypted_index: ...}` / `{encrypted_data: ...}` | Updated `_loadIndex` and `_downloadFile` to use `resp.data`; updated `VaultAPI.getFolder` to unwrap `resp.data` |

### Files Changed (Round 2)
- `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.7/js/vault-crypto.js` — Bug #6: `extractable` was briefly changed to `true` then **reverted to `false`** after AppSec review
- `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.7/components/user-vault/user-vault.js` — fixes #7, #8 (try-catch + response field names)
- `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.7/js/vault-api.js` — fix #8 (folder unwrap)

---

## Pattern Observations

### Recurring Issue: Response Shape Contracts
The mismatch between what the server returns and what the client expects was the root cause of bugs #3, #4, and #8. No explicit API contract exists between the route handlers and the JS API clients.

**Recommendation:** Define the response shape in the route docstrings or schemas. Both the admin UI (`adminAPI`) and the user UI (`VaultAPI`) should expect the same response format from the same endpoints.

### Recurring Issue: Missing Error Boundaries
Bugs #2 and #7 involve async operations failing silently, leaving the UI in a stuck state. The admin vault has no fingerprint fallback computation. The user vault has no try-catch on key generation.

**Recommendation:** All async state transitions should have try-catch guards. Any state change to `'loading'` must have a guaranteed exit path (success or error state).

### Recurring Issue: Web Crypto API Subtleties — CORRECTED
**Original diagnosis was wrong.** Bug #6 was NOT caused by `extractable: false` preventing public key export. The W3C Web Crypto spec states that public keys are **always extractable** for asymmetric key pairs, regardless of the `extractable` parameter. The admin code confirms this: `pki-keys.js:92` uses `extractable: false` and successfully exports public keys at `pki-keys.js:93`.

The attempted "fix" (changing to `extractable: true`) was a **security regression** that made the private key exportable via `exportKey('pkcs8', privateKey)`, enabling XSS-based permanent key compromise. It was reverted after AppSec + GRC review flagged it as CRITICAL/HIGH severity — violating decision D-PKI-002, investor materials, and the project's zero-knowledge contract.

**Recommendation:** Any change to `extractable`, `generateKey`, or `exportKey` parameters MUST require AppSec sign-off. Share the crypto layer between UIs, or at minimum maintain a shared spec.

---

## Architecture Decision: User Shell Component

### Context
The user-facing app currently uses hardcoded HTML `<header>` navigation in each page. As the vault and future features are added, this approach doesn't scale. The admin console has a full `admin-shell` Web Component with routing, nav, and debug panel.

### Decision Recorded
Create a **separate shell component for the user UI** (`user-shell`), distinct from the admin shell:

1. **Separate codebase** — user shell renders from the user Lambda; admin shell renders from the admin Lambda
2. **Simpler UI** — the user shell should be minimal (header, nav, content area) while still providing debug panel access
3. **Debug panel access** — the admin console's debug panel (health, timing, raw responses) is invaluable for diagnosing issues like the 500 error and should be available in the user UI
4. **Web Components** — individual features become self-contained components, loaded via the shell's routing

### Status
This is an **Explorer decision** — design and experiment first, then hand to Villager for production hardening.
