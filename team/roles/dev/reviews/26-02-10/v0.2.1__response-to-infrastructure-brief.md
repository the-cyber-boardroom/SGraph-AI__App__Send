# v0.2.1 — Dev Response to MVP Infrastructure Brief

**Version:** v0.2.1
**Date:** 2026-02-10
**Role:** Dev
**Responding to:** `team/humans/dinis_cruz/briefs/2026-02-10/v0.1.4__briefs__focus-on-mvp-release-infrastructure.md`

---

## 1. Current Implementation Status

### What's Built

| Component | File | Status |
|---|---|---|
| Admin FastAPI app | `Fast_API__SGraph__App__Send__Admin.py` | Working |
| Admin Lambda handler | `lambda_handler__admin.py` | Working |
| Admin deploy config | `Deploy__Service.py` | Scaffolded |
| Admin config constants | `admin__config.py` | Working |
| Admin UI static mount | Setup in `setup_static_routes()` | Working |
| Version utility | `utils/Version.py` | Working |
| Admin UI placeholder | `sgraph_ai_app_send__ui__admin/` | Working |
| Test infrastructure | `Fast_API__Test_Objs__SGraph__App__Send__Admin.py` | Working |
| 7 unit tests | Various under `tests/unit/lambda__admin/` | All pass |

### What's Not Built (Brief Requirements)

| Component | Priority | Blocked By |
|---|---|---|
| User FastAPI app (`Fast_API__SGraph__App__Send__User`) | P0 | Nothing — can start now |
| User Lambda handler | P0 | User FastAPI app |
| Transfer service (`Service__App__Send__Transfers`) | P0 | Nothing |
| Token service (`Service__App__Send__Tokens`) | P0 | Nothing |
| Storage wrapper (`Storage__App__Send`) | P0 | Memory-FS S3 class (Conductor provides) |
| Action logging service | P0 | Storage wrapper |
| Schema classes (Type_Safe) | P0 | Nothing |
| CLI entry point | P1 | Transfer service |
| Uvicorn entry point (container/server) | P1 | Nothing |
| Frontend UI (upload/download pages) | P1 | Transfer API |
| Frontend encryption (Web Crypto) | P1 | Nothing (client-side) |
| Transparency panel | P2 | Transfer service + action logging |

---

## 2. Implementation Plan (What to Build Next)

Following the brief's guidance: "Focus on getting one deployment target fully working end-to-end first (Lambda), then replicate across the matrix."

### Phase 1: Core Library (No Deployment Target Needed)

**1.1 Schema Classes**

```python
# All following Type_Safe pattern
Schema__App__Send__Transfer_Meta      # transfer_id, status, file_size, content_type_hint, created_at
Schema__App__Send__Transfer_Event     # event_id, transfer_id, event_type, timestamp, ip_hash, ua_normalised
Schema__App__Send__Transfer_Request   # request_id, transfer_id, method, path, timestamp, ip_hash
Schema__App__Send__Token              # token_id, created_at, revoked_at, usage_count
Schema__App__Send__Config             # storage_backend, admin_key_name, admin_key_value
```

**1.2 Storage Wrapper**

```python
class Storage__App__Send(Type_Safe):
    storage: Storage_FS          # Memory-FS instance (backend configured externally)

    def transfer__create(self, transfer_id) -> Schema__App__Send__Transfer_Meta
    def transfer__save_payload(self, transfer_id, encrypted_bytes)
    def transfer__get_payload(self, transfer_id) -> bytes
    def transfer__get_meta(self, transfer_id) -> Schema__App__Send__Transfer_Meta
    def transfer__log_event(self, transfer_id, event_type, request_data)
    def token__create(self) -> Schema__App__Send__Token
    def token__list(self) -> list
    def token__revoke(self, token_id)
```

**1.3 Transfer Service**

```python
class Service__App__Send__Transfers(Type_Safe):
    storage: Storage__App__Send

    def create(self, file_size, content_type_hint) -> dict    # Returns {transfer_id, upload_endpoint}
    def upload(self, transfer_id, encrypted_bytes) -> dict    # Returns {download_link, transparency}
    def info(self, transfer_id) -> dict                       # Returns transfer metadata
    def download(self, transfer_id) -> bytes                  # Returns encrypted payload
```

### Phase 2: User Lambda (Mirror Admin Pattern)

```
sgraph_ai_app_send/
  lambda__user/
    user__config.py                              # Same pattern as admin__config.py
    fast_api/
      Fast_API__SGraph__App__Send__User.py       # Extends Serverless__Fast_API
      routes/
        Routes__Transfers.py                     # /transfers/* endpoints
        Routes__Health.py                        # /health endpoint
    lambda_function/
      lambda_handler__user.py                    # Mangum entry point
      deploy/
        Deploy__Service__User.py                 # Lambda deploy config

sgraph_ai_app_send__ui__user/                    # Already exists as package
  v0/v0.1/v0.1.0/
    index.html                                   # Upload page
    download.html                                # Download page
    js/
      crypto.js                                  # AES-256-GCM encrypt/decrypt
      upload.js                                  # Upload workflow
      download.js                                # Download workflow
      transparency.js                            # Transparency panel
```

### Phase 3: Entry Points for Other Targets

**3.1 Uvicorn entry point (Docker, EC2, GCP, local dev)**

```python
# sgraph_ai_app_send/entrypoints/app.py
import os
SERVICE_TYPE = os.getenv('SERVICE_TYPE', 'admin')
if SERVICE_TYPE == 'admin':
    from sgraph_ai_app_send.lambda__admin.fast_api.Fast_API__SGraph__App__Send__Admin import Fast_API__SGraph__App__Send__Admin as AppClass
else:
    from sgraph_ai_app_send.lambda__user.fast_api.Fast_API__SGraph__App__Send__User import Fast_API__SGraph__App__Send__User as AppClass

with AppClass() as fast_api:
    fast_api.setup()
    app = fast_api.app()
```

**3.2 CLI entry point**

```python
# sgraph_ai_app_send/cli/main.py
# Uses click or argparse
# Imports Service__App__Send__Transfers directly
# Handles encryption client-side (Python cryptography lib, not Web Crypto)
```

### Phase 4: Frontend UI

Following IFD methodology:
- Web Components (no framework)
- Event-driven architecture
- Surgical override versioning (`v0/v0.1/v0.1.0/`)
- Multiple themes/layouts from day one (A/B ready)
- i18n support via data attributes

---

## 3. Key Technical Decisions Needed

### 3.1 Storage Backend Selection

The Architect proposes env var `SGRAPH_SEND_STORAGE_BACKEND`. I agree. Implementation:

```python
# In Fast_API setup or Storage__App__Send factory
backend = os.getenv('SGRAPH_SEND_STORAGE_BACKEND', 'memory')
if backend == 'memory':
    storage = Storage_FS()                    # In-memory (default)
elif backend == 'disk':
    storage = Storage_FS__Disk(root=path)     # Local filesystem
elif backend == 's3':
    storage = Storage_FS__S3(bucket=bucket)   # S3 via osbot-aws
```

### 3.2 CLI Encryption Library

The browser uses Web Crypto API. The CLI needs a Python equivalent for AES-256-GCM. Options:
- `cryptography` library (well-maintained, standard)
- `pycryptodome` (alternative)

**Recommendation:** `cryptography` — it's the de facto standard and matches Web Crypto API's AES-256-GCM.

### 3.3 Transfer ID Format

Per spec: cryptographically random, 12 characters. Using `secrets.token_urlsafe(9)` gives 12 base64url characters. This should be wrapped in a Type_Safe `Transfer_Id` class.

---

## 4. Build Order (Sequenced)

| Step | What | Est. Tests Added | Blocks |
|---|---|---|---|
| 1 | Schema classes (Type_Safe) | 5-8 | Everything |
| 2 | Storage wrapper (Memory-FS memory backend) | 8-10 | Transfer/Token services |
| 3 | Transfer service (create, upload, download, info) | 10-15 | User Lambda routes |
| 4 | Token service (CRUD) | 5-8 | Admin Lambda routes |
| 5 | Action logging service | 5-8 | Transparency panel |
| 6 | User Lambda (FastAPI + handler + routes) | 10-15 | User deployments |
| 7 | Admin Lambda routes (wire tokens + stats) | 5-8 | Admin deployments |
| 8 | Uvicorn entry point | 2-3 | Docker, EC2 |
| 9 | Dockerfile | 2-3 | Fargate, GCP |
| 10 | Frontend UI (upload + download pages) | — | E2E tests |
| 11 | CLI | 5-8 | Post-publish tests |
| 12 | Frontend encryption (Web Crypto) | — | Full transfer cycle E2E |

**Total new tests estimated:** 55-80+ (from current 7)

---

## 5. Alignment with Conductor's Decisions

| Conductor Decision | Dev Response |
|---|---|
| Use Memory-FS single file mode | Will use `file__save()` / `file__str()` / `file__bytes()` for all storage |
| Use osbot-aws for AWS, never boto3 | Storage adapter will delegate to Memory-FS S3 backend which uses osbot-aws internally |
| All code follows Type_Safe patterns | All schemas are `Type_Safe` subclasses, no Pydantic |
| Transfer folder stores everything | `transfers/{id}/` with `meta.json`, `payload.enc`, `events/`, `requests/` |
| No mocks in tests | In-memory Memory-FS for all unit tests |
| Version prefix on all files | Using `version__sgraph_ai_app_send` from `utils/Version.py` |
| IFD methodology for frontend | Web Components, zero dependencies, surgical versioning |
| SPA routing, no hash routing | Client-side route handling in frontend |

---

## 6. Action Items for Dev

- [ ] Create Schema classes (all Type_Safe) (P0)
- [ ] Create Storage__App__Send wrapper (P0)
- [ ] Create Service__App__Send__Transfers (P0)
- [ ] Create Service__App__Send__Tokens (P0)
- [ ] Create action logging service (P0)
- [ ] Create User Lambda (mirror Admin pattern) (P0)
- [ ] Wire Admin Lambda routes to Token service (P0)
- [ ] Create uvicorn entry point (P1)
- [ ] Create Dockerfile (P1)
- [ ] Create frontend upload page (P1)
- [ ] Create frontend download page (P1)
- [ ] Implement Web Crypto encryption/decryption (P1)
- [ ] Create CLI entry point (P1)
- [ ] Implement transparency panel (P2)

---

*This review is the Dev master file for the v0.1.4 infrastructure brief response.*
