# v0.1.2 â€” Backend Implementation Plan (OSBot Fast_API + Memory-FS)

**version** v0.1.2  
**date** 9 Feb 2026  
**role** Dev

## 1. Scope

Implementation plan for the backend service using:

- OSBot-Fast-API-Serverless route-class architecture
- Type_Safe schemas and primitives
- Memory-FS as storage abstraction (default single-file mode)
- `osbot-aws` for AWS interactions
- two lambda functions: public and admin

## 2. Non-negotiable constraints

1. Server must not depend on `boto3` directly in app logic.
2. All schemas are Type_Safe classes, one schema per file.
3. Route classes must use `Fast_API__Routes` conventions.
4. Keep backend data non-sensitive by default; support anonymised IP mode.
5. Maintain full per-transfer observability in file storage (`events`, `actions`, `requests`).

## 3. Proposed backend structure

```text
sgraph_ai_app_send/
  fast_api/
    Service__Fast_API__Public.py
    Service__Fast_API__Admin.py
    lambda_handler__public.py
    lambda_handler__admin.py
    routes/
      Routes__Public__Health.py
      Routes__Public__Transfers.py
      Routes__Public__Payload.py
      Routes__Public__Audit.py
      Routes__Admin__Tokens.py
      Routes__Admin__Stats.py
      Routes__Admin__Audit.py
  service/
    Service__App__Send__Storage.py
    Service__App__Send__Transfers.py
    Service__App__Send__Payloads.py
    Service__App__Send__Tokens.py
    Service__App__Send__Events.py
    Service__App__Send__Actions.py
    Service__App__Send__Requests.py
    Service__App__Send__Anonymization.py
  schemas/
    app_send/
      Schema__App__Send__Transfer.py
      Schema__App__Send__Transfer__Create.py
      Schema__App__Send__Transfer__Status.py
      Schema__App__Send__Transfer__Payload.py
      Schema__App__Send__Token.py
      Schema__App__Send__Token__Create.py
      Schema__App__Send__Event.py
      Schema__App__Send__Action.py
      Schema__App__Send__Request.py
      Schema__App__Send__Error.py
  types/
    Transfer_Id.py
    Token_Id.py
    Event_Id.py
```

## 4. Route surface (explicit action style)

### 4.1 Public lambda

Public lambda contains public and sender-token endpoints. Sender checks are route-level.

| Method | Route | Notes |
|-------|-------|-------|
| GET | `/health` | health check |
| POST | `/transfers/create` | sender token required |
| POST | `/transfers/id/{transfer_id}/upload/complete` | sender token required |
| GET | `/transfers/id/{transfer_id}/status` | public by transfer id |
| POST | `/transfers/id/{transfer_id}/download/create-presign-url` | public by transfer id |
| POST | `/transfers/id/{transfer_id}/payload/upload-bytes` | fallback for non-presign storage backends |
| GET | `/transfers/id/{transfer_id}/payload/download-bytes` | fallback for non-presign storage backends |
| POST | `/transfers/id/{transfer_id}/events/add` | explicit event creation |
| GET | `/transfers/id/{transfer_id}/events/list` | per-transfer event list |
| GET | `/transfers/id/{transfer_id}/actions/list` | per-transfer action list |

### 4.2 Admin lambda

Protected using OSBot-Fast-API built-in header/cookie auth.

| Method | Route | Notes |
|-------|-------|-------|
| POST | `/tokens/create` | create token |
| GET | `/tokens/list` | list tokens |
| POST | `/tokens/id/{token_id}/revoke` | revoke token |
| GET | `/stats/overview` | aggregate metrics |
| GET | `/audit/transfers/id/{transfer_id}/all` | complete transfer audit stream |

## 5. Storage strategy

### 5.1 Default mode

- Memory-FS single-file mode as default app datastore.
- Storage implementation hidden behind `Service__App__Send__Storage`.
- For cloud mode, same service switches backend to S3-compatible storage.

### 5.2 Upload/download strategy by backend capability

1. If backend supports pre-signed URLs:
   - client uploads/downloads encrypted bytes directly.
2. If backend does not support pre-signed URLs:
   - use `payload/upload-bytes` and `payload/download-bytes` APIs.
3. Public API returns mode metadata so UI knows which flow to use.

## 6. Type and schema patterns

1. Timestamp fields use int primitives from `Timestamp_Now`.
2. ID types use Obj_Id-derived classes:
   - `Transfer_Id` (with empty support + `Transfer_Id.new()`)
   - `Token_Id`
   - `Event_Id`
3. Schema naming:
   - `Schema__App__Send__*`
4. Service naming:
   - `Service__App__Send__*`

## 7. Error and audit model

1. Route-level errors use explicit HTTP status codes.
2. Response contracts use Type_Safe error schema where needed.
3. Every request writes:
   - request record
   - action record
   - optional event record
4. Audit data is queryable by transfer id via dedicated routes.

## 8. Test strategy

### 8.1 Fast tests (default)

- Full stack in memory.
- No mocks/patches.
- API calls against running Fast_API service instance.

### 8.2 Integration tests

- LocalStack for S3 and presigned URL behavior.
- Run only tests that validate cloud-specific behavior.

### 8.3 Coverage focus

1. transfer lifecycle (create -> upload -> complete -> download)
2. token lifecycle (create -> list -> revoke)
3. anonymisation mode behavior
4. event/action/request log completeness
5. max file size enforcement at 100MB

## 9. Delivery estimate

| Component | Estimate |
|---|---:|
| Service skeleton + route classes + auth split | 1.0 day |
| Storage service + Memory-FS integration | 1.5 days |
| Transfer and payload route implementation | 1.0 day |
| Token/admin implementation | 0.5 day |
| Audit logging layers | 0.5 day |
| Tests (memory + localstack integration) | 1.5 days |
| **Total** | **6.0 days** |

