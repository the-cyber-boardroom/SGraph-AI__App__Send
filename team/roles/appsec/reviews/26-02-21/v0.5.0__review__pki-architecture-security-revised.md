# AppSec Review: PKI Architecture Security -- Key Discovery, Chain of Trust, and Secure Pod (REVISED)

**Version:** v0.5.0
**Date:** 21 February 2026
**Role:** AppSec (Application Security)
**Team:** Explorer
**Classification:** Internal -- Security Sensitive
**Threat model baseline:** [v0.2.15 threat model](../26-02-12/v0.2.15__threat-model__sgraph-send.md)
**Previous AppSec review:** [v0.3.2 action plan](../26-02-14/v0.3.2__action-plan__explorer-next-steps.md)
**Service Worker research:** [v0.4.20 trust anchor](../../../../humans/dinis_cruz/briefs/02/20/v0.4.20__appsec-research__service-worker-trust-anchor.md)
**Original review:** [v0.5.0 PKI architecture security](v0.5.0__review__pki-architecture-security.md)

**Briefs reviewed:**
1. [v0.4.27 Key Discovery and Public Registry](../../../../humans/dinis_cruz/briefs/02/21/v0.4.27__dev-brief__key-discovery-and-public-registry.md)
2. [v0.4.27 Chain of Trust and Key Graphs](../../../../humans/dinis_cruz/briefs/02/21/v0.4.27__architecture__chain-of-trust-and-key-graphs.md)
3. [v0.4.27 Secure Pod -- Multi-User Revocable Encryption](../../../../humans/dinis_cruz/briefs/02/21/v0.4.27__architecture__secure-pod-multi-user-encryption.md)

---

## Revision Note

This document is a **revised version** of [v0.5.0__review__pki-architecture-security.md](v0.5.0__review__pki-architecture-security.md), updated based on decisions from the project owner (Dinis Cruz) on 21 Feb 2026. The original review assessed the three PKI briefs without accounting for the deployment context. This revision incorporates the following human decisions:

1. **Only Part 1 (Key Discovery) is in active build scope.** Parts 2 and 3 are future research and should not be treated as immediate concerns.
2. **All endpoints go on the Admin Lambda**, which is already protected by Fast_API Auth key (cookie-based authentication). The `Serverless__Fast_API` base class has `enable_api_key = True` by default. This means every request to the admin Lambda already requires a valid auth cookie.
3. **No challenge-response for now.** This is MVP stage with no active external customers. All users are controlled by access tokens in a high-trust environment.
4. **The registry page is admin-only** (not publicly accessible). All access requires admin auth.
5. **Lookup codes should be case-insensitive** with consistent server-side normalisation.
6. **GRC should track the transition risk** from the current high-trust model to a wider user base.

**Impact on risk ratings:** Multiple findings have been downgraded because the admin Lambda auth layer already mitigates the unauthenticated access scenarios that the original review flagged as Critical/High. The findings remain documented for future reference when the auth model widens.

---

## Executive Summary

Three briefs collectively define SG/Send's PKI architecture: a public key registry with short-code discovery (immediate build), a hash-chained trust graph with layered identity and key rotation (design phase), and a secure pod for multi-user revocable encryption (future research). Together they transform SG/Send from a symmetric-key file transfer tool into a full PKI platform.

**Revised assessment:** Given that the admin Lambda already enforces cookie-based authentication on all endpoints, and that the only active build is Part 1 (Key Discovery) in an admin-only context with no anonymous users, the original finding counts have been revised:

- **Original:** 4 Critical, 7 High, 9 Medium, 5 Low
- **Revised:** 0 Critical, 2 High (active scope), 4 Medium (active scope), 2 Low (active scope) + 15 findings deferred to FUTURE scope

The most important findings for the immediate build are:

1. **KD-NEW: Case-insensitive lookup codes need consistent normalisation** -- a new finding specific to the implementation (Medium)
2. **KD-3: Lookup code enumeration** -- reduced risk since admin-only, but still warrants rate limiting as good practice (Low)
3. **KD-5: Rate limiting** -- less urgent since admin-only, but recommended for defence in depth (Medium)
4. **KD-7: Transparency log phased approach** -- the phased plan is appropriate (Medium)

**GRC cross-reference:** The current high-trust model (all users controlled by access tokens, admin-only access) is a conscious decision for MVP stage. When the platform widens to a broader user base, many deferred findings (KD-1, KD-2, CT-2, CT-4, etc.) will become genuinely critical. The GRC team must track this transition risk.

---

## Part 1: Key Discovery and Public Registry -- ACTIVE SCOPE

### 1.1 Threat Model (Revised)

**Scope:** 4 new API endpoints (`POST /api/keys`, `GET /api/keys/{code}`, `DELETE /api/keys/{code}`, `GET /api/keys`), the key lookup page, the key registry page, and the certificate transparency log. All endpoints are on the Admin Lambda.

**Key context change:** The Admin Lambda uses `Serverless__Fast_API` with `enable_api_key = True` (the default). This means every request requires a valid Fast_API Auth cookie. There is no anonymous access to any endpoint.

**Assets at risk:**
- Public keys (public data, but the association between a code and a key is metadata)
- The lookup code namespace (finite, enumerable -- but only by authenticated admins)
- The transparency log integrity (append-only property)
- The registry as a whole (denial of service via flooding -- but only by authenticated users)

**Threat actors (revised):**
- ~~Anonymous attacker~~ -- **Eliminated.** All endpoints require admin auth.
- Malicious authenticated admin (squatting, impersonation) -- **Reduced risk.** All admins are controlled by access tokens in the current model.
- Server operator (equivocation, selective serving) -- **Unchanged.** Server-side risk is independent of auth model.

### 1.2 Findings (Revised)

#### KD-1: POST /api/keys Authentication (MITIGATED)

**Original risk:** Critical
**Revised risk:** Low (mitigated by existing controls)
**Category:** Authentication
**Status:** MITIGATED -- admin Lambda auth already in place

The original review flagged this as Critical because the brief did not mention authentication on `POST /api/keys`. However, since all endpoints are on the Admin Lambda, which enforces cookie-based authentication by default via `Serverless__Fast_API`, this endpoint is already authenticated.

**Original attack scenarios and current status:**
1. **Key squatting** -- Requires admin auth. Only authenticated admins can publish keys. Risk is limited to malicious insiders, not anonymous attackers.
2. **Key impersonation** -- Same mitigation. An insider could publish a key for a code someone else wants, but this is detectable in the admin-only environment.
3. **Registry pollution** -- Bounded by the number of authenticated admins (currently a small, controlled set).
4. **Resource exhaustion** -- Same bounded risk.

**Remaining recommendation:**
- No immediate action required. The admin auth layer provides sufficient protection for the current high-trust model.
- **GRC FLAG:** When the auth model widens (more users, self-service registration, public-facing endpoints), this finding escalates to High/Critical. At that point, proof-of-possession (client signs a challenge with the private key corresponding to the public key being published) becomes a requirement.

#### KD-2: DELETE /api/keys/{code} Authentication (MITIGATED)

**Original risk:** High
**Revised risk:** Low (mitigated by existing controls)
**Category:** Authentication
**Status:** MITIGATED -- admin Lambda auth already in place

The brief mentions `DELETE /api/keys/{code}` "requires authentication" but does not specify what authentication. Since this endpoint is on the Admin Lambda, cookie-based auth is already enforced. In the current model, any authenticated admin can delete any key.

**Remaining questions for future (not blocking the build):**
1. When the platform has multiple users: who can delete a key? Only the publisher? Any admin?
2. Proof-of-possession for deletion (sign a challenge with the private key) -- not needed now, needed when auth widens.
3. Deletion token issued at publication time -- a good UX pattern for the future, not blocking for MVP.

**Remaining recommendation:**
- For MVP: any authenticated admin can delete any key. This is acceptable in the current high-trust environment.
- **GRC FLAG:** When self-service users are added, deletion auth must be scoped to the key owner (via proof-of-possession or deletion token). Track this as a transition requirement.

#### KD-3: Lookup Code Enumeration (REDUCED)

**Original risk:** Medium
**Revised risk:** Low
**Category:** Information Disclosure
**Status:** ACCEPTABLE for admin-only deployment

The enumeration analysis from the original review remains accurate:

| Length | Characters | Keyspace | Time to enumerate at 100 req/s |
|--------|-----------|----------|-------------------------------|
| 6 | 36 (a-z, 0-9, case-insensitive) | 2.18 billion | 252 days |
| 8 | 36 (a-z, 0-9, case-insensitive) | 2.82 trillion | 895 years |

**Note on case-insensitivity:** Since lookup codes are now case-insensitive (per human decision, see KD-NEW below), the effective alphabet is 36 characters (a-z + 0-9), not 62. This reduces the keyspace but the enumeration time at 8 characters remains infeasible.

**Revised assessment:** Since `GET /api/keys/{code}` requires admin auth, the enumeration threat is limited to authenticated admins probing for other admins' codes. In the current high-trust environment with a small user base, this is not a meaningful attack vector.

**Remaining recommendation:**
- Use 8 characters minimum. Even with the reduced 36-character alphabet, 2.82 trillion combinations is more than sufficient.
- Rate limiting is still good practice (see KD-5) but not urgent.
- Constant-time response for found/not-found is still recommended as defence in depth -- it costs nothing to implement and prevents timing side-channels if the auth model ever widens.

#### KD-4: GET /api/keys Registry Enumeration (MITIGATED)

**Original risk:** Medium
**Revised risk:** Informational (no action needed)
**Category:** Information Disclosure
**Status:** MITIGATED -- registry page is admin-only

The original concern was that `GET /api/keys` (list all) acts as a membership oracle, revealing the full set of users on private deployments. Since the registry page is admin-only and all users are already known to each other in the current model, this is not a meaningful risk.

**Remaining recommendation:**
- No action needed for MVP.
- **GRC FLAG:** If the registry page is ever made accessible to non-admin users or the public, this finding escalates to Medium. The membership oracle concern becomes real on multi-tenant deployments.

#### KD-5: Rate Limiting Requirements (REDUCED)

**Original risk:** High
**Revised risk:** Medium
**Category:** Availability / Denial of Service
**Status:** RECOMMENDED but not blocking

With admin auth on all endpoints, the DoS attack surface is limited to authenticated users. An attacker would need valid admin credentials to flood the registry or enumerate codes. This makes rate limiting a defence-in-depth measure rather than a critical control.

**Revised recommendations:**

| Endpoint | Rate Limit | Urgency |
|----------|-----------|---------|
| `POST /api/keys` | 10/hour per admin | Nice-to-have for MVP |
| `GET /api/keys/{code}` | 60/minute per admin | Nice-to-have for MVP |
| `GET /api/keys` | 10/minute per admin | Nice-to-have for MVP |
| `DELETE /api/keys/{code}` | 10/hour per admin | Nice-to-have for MVP |

**GRC FLAG:** Rate limiting becomes a MUST when the auth model widens. Implement before onboarding external users.

#### KD-6: CORS and Origin Restrictions (MITIGATED)

**Original risk:** Medium
**Revised risk:** Informational (no action needed)
**Category:** Access Control
**Status:** MITIGATED -- admin Lambda handles CORS

The Admin Lambda's `Serverless__Fast_API` base class handles CORS configuration. Since the key discovery endpoints are on the admin Lambda, they inherit the existing CORS policy. Cookie-based auth also mitigates CSRF -- the auth cookie must be present, and browsers do not send cookies cross-origin by default (SameSite policy).

**Remaining recommendation:**
- Verify that the admin Lambda's CORS configuration restricts origins to the deployment's own domain. This should already be the case.
- No additional CORS work needed for the key discovery build.

#### KD-7: Transparency Log as Security Control (UNCHANGED)

**Original risk:** Medium
**Revised risk:** Medium
**Category:** Integrity
**Status:** Phased approach acceptable

This finding is independent of the auth model. The transparency log is a server-maintained data structure. The phased approach from the original review remains the correct path:

- **Phase 1 (current build):** Implement the transparency log as an append-only audit trail. This provides value against accidental corruption and supports admin audit workflows. The server computes and displays the hash chain. Admins can inspect it.
- **Phase 2 (chain-of-trust integration -- FUTURE):** Implement client-side log verification. Clients independently compute the hash chain and verify the server's claimed head hash.
- **Phase 3 (FUTURE):** External witness mechanism for equivocation resistance.

**Recommendation:** Proceed with Phase 1 as designed. Document in the UI: "This log is server-maintained. Full tamper detection requires independent hash chain verification (future feature)."

#### KD-8: Hybrid Lookup Code Approach (UNCHANGED)

**Original risk:** Low
**Revised risk:** Low (acceptable as designed)
**Category:** Metadata Protection
**Status:** ACCEPTABLE

The hybrid approach (short opaque code like `DC-7X4F`) remains sound. The short code is not a meaningful name -- it is an opaque token. Storing it directly is acceptable because:
- It reveals nothing about the user's identity or purpose.
- Hashing a 6-8 character code provides no security benefit -- the keyspace is small enough to rainbow table.
- The code is now case-insensitive (see KD-NEW), which simplifies user experience without materially affecting security.

**Recommendation:** Proceed with the hybrid approach. No additional protection needed.

#### KD-NEW: Case-Insensitive Lookup Codes Require Consistent Normalisation (NEW)

**Risk:** Medium
**Category:** Data Integrity / Correctness
**Status:** MUST ADDRESS in implementation

Per the human decision, lookup codes should be case-insensitive. This means `DC-7X4F`, `dc-7x4f`, and `Dc-7x4F` must all resolve to the same key. This requires consistent normalisation at the server boundary.

**Concerns:**
1. **Normalisation point:** If normalisation happens inconsistently (e.g., the publish endpoint stores `DC-7X4F` but the lookup endpoint searches for `dc-7x4f`), lookups will fail silently.
2. **Hash consistency:** If the transparency log hashes include the lookup code, the hash must use the normalised form. Otherwise, the same logical operation produces different hashes depending on the client's capitalisation.
3. **Collision risk on generation:** When generating new codes, the server must check for collisions against the normalised form. If `DC-7X4F` exists, generating `dc-7x4f` must be detected as a collision.

**Recommendation:**
- **Normalise to lowercase at the API boundary.** Every endpoint that receives a lookup code must `code.lower()` (or equivalent) before any processing -- storage, lookup, deletion, logging.
- **Store only the normalised (lowercase) form.** The server never stores mixed-case codes.
- **Generate codes in a single canonical form.** The generation function should produce uppercase for display (human-friendly) but the server stores and matches lowercase internally.
- **Display convention:** Show codes as uppercase in the UI (e.g., `DC-7X4F`) for readability. The user can type any case and it works.
- **Transparency log entries must use the normalised form.** All log entries record the lowercase code so hashes are deterministic.
- **Test case:** Include a test that publishes a key, then looks it up with different capitalisations to verify they all resolve correctly.

### 1.3 Key Discovery -- Revised Risk Summary

| ID | Finding | Original Risk | Revised Risk | Status |
|----|---------|---------------|-------------|--------|
| KD-1 | POST /api/keys authentication | Critical | Low | MITIGATED by admin Lambda auth |
| KD-2 | DELETE authentication not specified | High | Low | MITIGATED by admin Lambda auth |
| KD-3 | Lookup code enumeration | Medium | Low | ACCEPTABLE -- admin-only, 8-char codes |
| KD-4 | Registry list exposes membership | Medium | Informational | MITIGATED -- admin-only registry |
| KD-5 | No rate limiting on endpoints | High | Medium | RECOMMENDED -- defence in depth |
| KD-6 | CORS/origin restrictions | Medium | Informational | MITIGATED -- admin Lambda handles |
| KD-7 | Transparency log not client-verifiable | Medium | Medium | Phased approach acceptable |
| KD-8 | Hybrid lookup code approach | Low | Low | ACCEPTABLE as designed |
| KD-NEW | Case-insensitive lookup normalisation | -- | Medium | MUST ADDRESS in implementation |

---

## Part 2: Chain of Trust and Key Graphs -- FUTURE SCOPE

> **NOTE:** All findings in this section are marked **FUTURE -- dependent on customer demand**. The Chain of Trust architecture is in design phase, not active build. These findings should be revisited when the feature moves to implementation. Risk ratings reflect the eventual deployed state, not the current project state.

### 2.1 Threat Model

**Scope:** Trust graph data model, git-style hash chaining, challenge-response authentication, key rotation with identity binding, layered key identity (4 layers), PKI-encrypted web delivery.

**Status:** Design phase. No implementation planned until customer demand validates the feature. The human has decided that challenge-response is not needed for MVP stage -- all users are controlled by access tokens.

**Assets at risk (when built):**
- The trust graph integrity (who trusts whom)
- Key-to-identity bindings (which keys belong to which identities)
- The hash chain (tamper-evident history)
- Identity provider trust (OAuth/Cognito as anchor)
- Private keys in browsers (IndexedDB, non-extractable)

### 2.2 Findings (Deferred)

#### CT-1: Equivocation Attack on the Hash Chain (FUTURE -- Critical when deployed)

**Eventual risk:** Critical
**Current status:** DEFERRED -- design phase only
**Category:** Integrity

The single-server equivocation attack remains the core unsolved problem for hash-chained transparency logs. A compromised server can show different chains to different clients. This is addressed by gossip protocols, external witnesses, or third-party auditors.

**Analysis unchanged from original review.** The phased approach remains correct:
- Phase 1: Hash chain as audit trail (provides value against accidental corruption).
- Phase 2: Client-side log verification.
- Phase 3: External witness for equivocation resistance.

**Action:** Revisit when Chain of Trust moves to active build. No action needed now.

#### CT-2: Group Admin Compromise Propagates Trust (FUTURE -- Critical when deployed)

**Eventual risk:** Critical
**Current status:** DEFERRED -- design phase only
**Category:** Trust Propagation

One compromised admin key can add attacker-controlled keys to any group the admin manages. Mitigations include multi-admin threshold signing, member addition notifications, and time-delayed additions.

**GRC FLAG:** This finding becomes genuinely critical when the platform moves from the current high-trust model (small set of known admins) to a broader user base where admin compromise by external threat actors is a realistic scenario.

**Action:** Revisit when Chain of Trust moves to active build. The GRC team should track this as a transition risk.

#### CT-3: Challenge-Response Replay Attacks and Nonce Management (FUTURE -- High when deployed)

**Eventual risk:** High
**Current status:** DEFERRED -- no challenge-response in MVP
**Category:** Authentication

The human has decided: no challenge-response for now. All users are controlled by access tokens. Challenge-response becomes relevant when the platform supports identity-verified key operations for a broader user base.

**When implemented, the nonce requirements from the original review apply:**
- Cryptographically random: minimum 128 bits.
- Single-use with server-side tracking.
- Time-bounded: 60-second expiry recommended.
- Context-bound: signed payload must include operation type.

**Action:** Revisit when challenge-response is designed. No action needed now.

#### CT-4: Identity Binding Security -- OAuth/Cognito as Trust Anchor (FUTURE -- High when deployed)

**Eventual risk:** High
**Current status:** DEFERRED -- no IdP-based key rotation in MVP
**Category:** Identity / Trust

If the IdP is compromised, an attacker can rotate any user's keys. Mitigations include rotation notifications, cooldown periods, and multi-factor key binding.

**GRC FLAG:** This finding becomes critical when the platform integrates OAuth/Cognito for user identity. The GRC team should ensure that IdP compromise scenarios are part of the threat model review when this feature is built.

**Action:** Revisit when Chain of Trust moves to active build. No action needed now.

#### CT-5: Layered Key Model -- Over-Engineering Risk (FUTURE -- Low)

**Eventual risk:** Low (architectural, not a vulnerability)
**Current status:** DEFERRED -- incremental implementation
**Category:** Design

The 4-layer key model (API Key, Device/Session Key, Persona Key, Admin Key) is sound in design. The recommendation to implement incrementally (Persona + API first) remains correct.

**Action:** Revisit when layered key model is designed. No action needed now.

#### CT-6: Trust Graph Revocation Timing (FUTURE -- Medium when deployed)

**Eventual risk:** Medium
**Current status:** DEFERRED -- no trust graph in MVP
**Category:** Revocation

Cache staleness for trust graph queries creates a window where revoked users remain trusted. Mitigations include maximum cache TTL and push-based revocation.

**Action:** Revisit when trust graph is implemented. No action needed now.

#### CT-7: PKI-Encrypted Web Delivery -- Code Integrity Bootstrap (FUTURE -- High when deployed)

**Eventual risk:** High
**Current status:** DEFERRED -- Phase 3 capability
**Category:** Integrity

The TOFU (Trust On First Use) problem for Service Worker delivery. Addressed by the v0.4.20 Service Worker trust anchor architecture.

**Action:** Revisit when PKI-encrypted web delivery is implemented. No action needed now.

#### CT-8: Hash Chain Signing -- Key Continuity vs Authority (FUTURE -- Medium when deployed)

**Eventual risk:** Medium
**Current status:** DEFERRED -- no hash chain signing in MVP
**Category:** Integrity / Non-Repudiation

Mixing signing authorities in the same chain requires strict enforcement of which key types may sign which commit types. The enforcement matrix from the original review remains the recommended approach.

**Action:** Revisit when hash chain signing is designed. No action needed now.

### 2.3 Chain of Trust -- Deferred Risk Summary

| ID | Finding | Eventual Risk | Current Status |
|----|---------|---------------|----------------|
| CT-1 | Equivocation attack on hash chain | Critical | FUTURE -- revisit at build time |
| CT-2 | Group admin compromise propagates trust | Critical | FUTURE -- GRC should track transition risk |
| CT-3 | Challenge-response replay / nonce management | High | FUTURE -- no challenge-response in MVP |
| CT-4 | OAuth/Cognito compromise enables key takeover | High | FUTURE -- GRC should track transition risk |
| CT-5 | 4-layer key model complexity | Low | FUTURE -- implement incrementally |
| CT-6 | Trust graph revocation cache staleness | Medium | FUTURE -- revisit at build time |
| CT-7 | PKI-encrypted web delivery TOFU bootstrap | High | FUTURE -- addressed by v0.4.20 |
| CT-8 | Hash chain signing authority confusion | Medium | FUTURE -- revisit at build time |

---

## Part 3: Secure Pod -- FUTURE SCOPE

> **NOTE:** All findings in this section are marked **FUTURE -- dependent on customer demand**. The Secure Pod is in research phase. These findings are architectural guidance for when the feature is eventually designed and built. Risk ratings reflect the eventual deployed state.

### 3.1 Threat Model

**Scope:** The secure pod as an intermediary decryption/re-encryption enclave for multi-user revocable access to encrypted content.

**Status:** Research phase. No implementation planned. The entire Secure Pod concept depends on customer demand for multi-user revocable encryption.

### 3.2 Findings (Deferred)

#### SP-1: Pod as Single Point of Failure (FUTURE -- High when deployed)

**Eventual risk:** High
**Current status:** DEFERRED -- research phase
**Category:** Availability

Pod unavailability blocks all content access. Mitigations include pod redundancy (Shamir's Secret Sharing for distributed key), health monitoring with failover, and SLA definitions.

**Action:** Revisit when Secure Pod moves to design phase. No action needed now.

#### SP-2: Pod Compromise Blast Radius (FUTURE -- High when deployed)

**Eventual risk:** High
**Current status:** DEFERRED -- research phase
**Category:** Confidentiality

The original review validated the brief's claims about blast radius with caveats. Key finding: the pod MUST NOT cache encrypted blobs (each re-encryption must involve a fresh fetch from the server).

**Action:** Revisit when Secure Pod moves to design phase. No action needed now.

#### SP-3: Micro-Payment Budget as Security Control (FUTURE -- Medium)

**Eventual risk:** Medium
**Current status:** DEFERRED -- research phase
**Category:** Detection / Rate Limiting

A novel and promising security control. Budget enforcement MUST be external to the pod. The original review's analysis of strengths and weaknesses remains valid.

**Action:** Revisit when Secure Pod moves to design phase. No action needed now.

#### SP-4: Client-Side Pod Option (FUTURE -- Medium)

**Eventual risk:** Medium
**Current status:** DEFERRED -- research phase
**Category:** Trust Model

Client-side pod is acceptable for personal sharing but not enterprise. Label clearly as "Sender-Controlled Mode."

**Action:** Revisit when Secure Pod moves to design phase. No action needed now.

#### SP-5: Pod Unavailability -- Availability vs Security Trade-Off (FUTURE -- Medium)

**Eventual risk:** Medium
**Current status:** DEFERRED -- research phase
**Category:** Availability / Design

Default to strict mode (deny access when pod unavailable). Never implement fallback-to-direct-PKI during pod outage.

**Action:** Revisit when Secure Pod moves to design phase. No action needed now.

### 3.3 Secure Pod -- Deferred Risk Summary

| ID | Finding | Eventual Risk | Current Status |
|----|---------|---------------|----------------|
| SP-1 | Pod as single point of failure | High | FUTURE -- revisit at design phase |
| SP-2 | Pod compromise blast radius | High | FUTURE -- revisit at design phase |
| SP-3 | Micro-payment budget control | Medium | FUTURE -- revisit at design phase |
| SP-4 | Client-side pod trust model | Medium | FUTURE -- revisit at design phase |
| SP-5 | Pod unavailability trade-off | Medium | FUTURE -- revisit at design phase |

---

## Cross-Cutting Concerns

### CC-1: Incremental Complexity Risk (UNCHANGED)

The three briefs collectively introduce significant cryptographic infrastructure. The recommendation to build and security-test each layer independently before composing them remains correct. For the current build, only key discovery (Part 1) is in scope.

### CC-2: The Server-Sees-Nothing Principle Under Pressure (UNCHANGED)

The key registry introduces public keys and lookup codes as new server-side metadata. The zero-knowledge claim for file content remains intact. When the trust graph and pod are eventually built, update security claims to: "the server never sees plaintext content. The server stores public keys, trust graph relationships, and access logs -- but never file content."

### CC-3: GRC Cross-Reference -- Auth Model Transition Risk (NEW)

**Risk:** High (future)
**Category:** Governance / Risk Management
**Status:** GRC MUST TRACK

The current security posture benefits from a high-trust model:
- All users are controlled by access tokens issued by the project owner.
- All endpoints require admin auth (Fast_API Auth cookie).
- There are no anonymous users, no self-service registration, no public-facing key discovery endpoints.
- The user base is small and known.

**This model will change.** When the platform onboards external customers, the auth model will widen:
- Self-service registration may be introduced.
- Key discovery endpoints may become accessible to non-admin users.
- The registry page may become semi-public or federated.
- Access tokens will be issued to users the project owner does not personally know.

**When this transition happens, the following deferred findings become critical:**

| Finding | Current Status | Becomes Critical When |
|---------|---------------|----------------------|
| KD-1 (key publishing auth) | Mitigated by admin auth | Endpoints accessible to non-admin users |
| KD-2 (deletion auth) | Mitigated by admin auth | Multiple users can publish keys (need ownership scoping) |
| KD-3 (enumeration) | Low risk (admin-only) | Lookup endpoints are publicly accessible |
| KD-4 (membership oracle) | Informational (admin-only) | Registry visible to non-admin users |
| KD-5 (rate limiting) | Recommended | Any non-admin access to endpoints |
| CT-2 (admin compromise) | Future | External users with admin roles |
| CT-4 (IdP compromise) | Future | OAuth/Cognito integration for user identity |

**Recommendation for GRC:**
1. Create a tracking item: "Auth Model Widening -- Security Review Trigger." This should fire a mandatory security review (re-assessment of all deferred findings) before any of the following changes ship to production:
   - New user roles beyond admin
   - Self-service registration
   - Public-facing key discovery endpoints
   - External IdP integration (OAuth/Cognito)
   - Federation with other SG/Send instances
2. The review should include: re-rating of all KD-* findings, design of proof-of-possession for key publishing, deletion token or ownership-scoped deletion, rate limiting implementation, and challenge-response protocol design.
3. Budget at least one full sprint for the security hardening work. The current findings are well-documented and the recommendations are ready -- they just do not need to be implemented yet.

---

## Risk Register Update (Revised)

### Active Risks (Part 1 -- Key Discovery Build)

| Risk ID | Risk | Source | Rating | Owner | Action |
|---------|------|--------|--------|-------|--------|
| **RF-38** | ~~Unauthenticated key publication~~ Mitigated by admin auth | KD-1 | Low | AppSec | No action for MVP |
| **RF-42** | ~~DELETE auth gap~~ Mitigated by admin auth | KD-2 | Low | AppSec | No action for MVP |
| **RF-43** | No rate limiting on key discovery endpoints | KD-5 | Medium | Dev | Recommended, not blocking |
| **RF-49** | Lookup code enumeration (admin-only) | KD-3 | Low | Dev | 8-char codes, acceptable |
| **RF-50** | ~~Registry as membership oracle~~ Admin-only | KD-4 | Info | -- | No action |
| **RF-51** | ~~CORS gap~~ Admin Lambda handles | KD-6 | Info | -- | No action |
| **RF-52** | Transparency log not client-verifiable | KD-7 | Medium | Dev | Phased approach |
| **RF-59** | Hybrid lookup code (acceptable) | KD-8 | Low | -- | Proceed as designed |
| **RF-63** | Case-insensitive lookup code normalisation | KD-NEW | Medium | Dev | MUST ADDRESS |
| **RF-64** | Auth model transition risk | CC-3 | -- | GRC | Track for future |

### Deferred Risks (Parts 2 & 3 -- FUTURE)

| Risk ID | Risk | Source | Eventual Rating | Revisit When |
|---------|------|--------|----------------|-------------|
| **RF-39** | Equivocation attack on hash chain | CT-1 | Critical | Chain of Trust build |
| **RF-40** | Group admin compromise propagates trust | CT-2 | Critical | Chain of Trust build |
| **RF-41** | Pod+server compromise = total exposure | SP-2 | Critical | Secure Pod build |
| **RF-44** | Challenge-response nonce mismanagement | CT-3 | High | Challenge-response build |
| **RF-45** | IdP compromise enables key takeover | CT-4 | High | IdP integration |
| **RF-46** | PKI-encrypted web delivery TOFU | CT-7 | High | Encrypted delivery build |
| **RF-47** | Pod single point of failure | SP-1 | High | Secure Pod build |
| **RF-48** | Pod caching extends compromise | SP-2 | High | Secure Pod build |
| **RF-53** | Trust graph revocation staleness | CT-6 | Medium | Trust graph build |
| **RF-54** | Hash chain signing authority confusion | CT-8 | Medium | Hash chain build |
| **RF-55** | Micro-payment budget self-enforcement | SP-3 | Medium | Secure Pod build |
| **RF-56** | Client-side pod trust model mismatch | SP-4 | Medium | Secure Pod build |
| **RF-57** | Pod unavailability degrades revocation | SP-5 | Medium | Secure Pod build |
| **RF-58** | 4-layer key model complexity | CT-5 | Low | Layered key build |
| **RF-60** | Incremental complexity across briefs | CC-1 | Low | Multi-part integration |

### Revised Risk Summary

| Priority | Active (Part 1) | Deferred (Parts 2 & 3) | Notes |
|----------|----------------|----------------------|-------|
| Critical | 0 | 3 | All Critical findings are in future scope |
| High | 0 | 5 | All High findings are in future scope |
| Medium | 3 | 5 | KD-5, KD-7, KD-NEW are active |
| Low | 3 | 1 | KD-1, KD-2, KD-3 mitigated to Low |
| Informational | 2 | 0 | KD-4, KD-6 fully mitigated |
| **Totals** | **8** | **14** | **+ 1 GRC tracking item (CC-3)** |

---

## Recommendations Summary (Revised)

### Immediate (Key Discovery Build -- MUST DO)

| # | Recommendation | Finding | Priority |
|---|---------------|---------|----------|
| 1 | **Normalise lookup codes to lowercase at API boundary** -- every endpoint must `code.lower()` before processing | KD-NEW | P0 |
| 2 | **Store only normalised (lowercase) codes** -- generate uppercase for display, store lowercase internally | KD-NEW | P0 |
| 3 | **Use normalised form in transparency log entries** -- ensures deterministic hashes | KD-NEW | P0 |
| 4 | **Use 8-character codes minimum** with 36-character alphabet (a-z, 0-9 after normalisation) | KD-3 | P1 |
| 5 | **Constant-time response for found/not-found** -- prevents timing side-channels (costs nothing to implement) | KD-3 | P1 |
| 6 | **Implement Phase 1 transparency log** -- append-only audit trail, server-maintained | KD-7 | P1 |
| 7 | **Test lookup with mixed-case inputs** -- verify `DC-7X4F`, `dc-7x4f`, `Dc-7x4F` all resolve identically | KD-NEW | P1 |

### Recommended (Key Discovery Build -- SHOULD DO)

| # | Recommendation | Finding | Priority |
|---|---------------|---------|----------|
| 8 | Rate limiting on all 4 endpoints (defence in depth) | KD-5 | P2 |
| 9 | Verify admin Lambda CORS restricts to own origin | KD-6 | P2 |

### GRC Actions (Track for Future)

| # | Recommendation | Finding | Owner |
|---|---------------|---------|-------|
| 10 | Create "Auth Model Widening" trigger for mandatory security review | CC-3 | GRC |
| 11 | Track KD-1 escalation: proof-of-possession when non-admin users can publish | KD-1, CC-3 | GRC |
| 12 | Track KD-2 escalation: ownership-scoped deletion when multi-user | KD-2, CC-3 | GRC |
| 13 | Track CT-2 escalation: threshold signing when external admins added | CT-2, CC-3 | GRC |
| 14 | Track CT-4 escalation: IdP compromise mitigations when OAuth integrated | CT-4, CC-3 | GRC |

### Deferred (Parts 2 & 3 -- Revisit When Building)

| # | Recommendation | Finding | Revisit When |
|---|---------------|---------|-------------|
| 15 | Design external witness mechanism for equivocation resistance | CT-1 | Chain of Trust build |
| 16 | Design multi-admin threshold signing for ADD_MEMBER | CT-2 | Chain of Trust build |
| 17 | Specify nonce requirements for challenge-response | CT-3 | Challenge-response build |
| 18 | Implement key rotation notification + cooldown | CT-4 | IdP integration |
| 19 | Define signing authority enforcement matrix | CT-8 | Hash chain build |
| 20 | Set trust graph cache TTL | CT-6 | Trust graph build |
| 21 | Implement key layers incrementally | CT-5 | Layered key build |
| 22 | Design pod redundancy | SP-1 | Secure Pod build |
| 23 | Enforce no-blob-caching in pod | SP-2 | Secure Pod build |
| 24 | External budget enforcement for pod | SP-3 | Secure Pod build |
| 25 | Label client-side pod as "Sender-Controlled Mode" | SP-4 | Secure Pod build |
| 26 | Default to strict mode when pod unavailable | SP-5 | Secure Pod build |
| 27 | Never implement fallback-to-direct-PKI during pod outage | SP-5 | Secure Pod build |

---

## Conclusion

The revised assessment reflects the reality of the current deployment: a high-trust, admin-only environment where all endpoints are protected by cookie-based authentication and all users are known and controlled by access tokens.

**For the immediate Key Discovery build**, the security posture is strong. The admin Lambda auth layer eliminates the anonymous attack scenarios that drove the original Critical and High findings. The actionable items are:
1. Case-insensitive lookup code normalisation (KD-NEW) -- a correctness issue that must be addressed in implementation.
2. Transparency log Phase 1 -- implement as an append-only audit trail.
3. 8-character codes and constant-time responses -- defence in depth, low cost.

**For the future**, the deferred findings are well-documented and the recommendations are ready. The key transition point is when the auth model widens from the current high-trust model to a broader user base. The GRC team must track this transition and trigger a mandatory security review before it happens.

The original review's analysis of Parts 2 (Chain of Trust) and Part 3 (Secure Pod) remains technically accurate. Those findings are preserved in this document for reference but are not actionable until the features move to active build.

---

*Revised AppSec review complete. This document supersedes the original [v0.5.0__review__pki-architecture-security.md](v0.5.0__review__pki-architecture-security.md) for decision-making purposes. The original is retained for audit trail. Next scheduled review: after key discovery implementation is complete, or when the auth model widening is proposed.*
