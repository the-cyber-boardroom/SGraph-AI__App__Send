# v0.2.24 -- AppSec Status Report: Post-Launch Security Review

**Version:** v0.2.24
**Date:** 2026-02-13
**Role:** AppSec
**Status:** ACTIVE

---

## 1. Access Token Mechanism

The current auth model uses a single shared secret (`SGRAPH_SEND__ACCESS_TOKEN` env var) verified per-route via the `x-sgraph-access-token` header. The token is stored in `localStorage` on the client.

**Findings:**

- **Shared secret, not per-user:** All authorised users share one token. No audit trail distinguishing users. Acceptable for friendlies phase; must be replaced before public launch.
- **localStorage exposure:** Token persists across sessions and is readable by any JS on the page. XSS on the domain would leak it. Mitigated by the fact that the site has no third-party JS (except GA -- see below).
- **No expiry or rotation:** Token has no TTL. If compromised, it remains valid until the env var is manually changed.
- **Transport security:** Token sent over HTTPS only (Lambda URL Functions enforce TLS). Header-based, so not logged in browser history (unlike query params).

**Verdict:** Acceptable for early access. Replace with per-user tokens (from the Admin Lambda token service) before wider rollout.

---

## 2. Google Analytics Privacy Implications

GA4 is now live across both domains. Security concerns:

- **Third-party JS on a zero-knowledge platform:** GA's `gtag.js` executes in the same origin. It cannot read the URL hash fragment (the `#key` portion), but it can read `document.title`, `document.referrer`, and any DOM content.
- **GA cannot access encryption keys** if keys are only ever in the hash fragment (hash is excluded from `document.location` fields sent to GA by default).
- **Cookie scope:** GA4 sets `_ga` and `_ga_*` cookies. These are first-party cookies on `sgraph.ai`. They track user identity across sessions.
- **Recommendation:** Add `anonymize_ip: true` to the GA config. Verify GA is not capturing page titles that could leak transfer IDs.

---

## 3. URL Hash Fragment Security (WS-13)

The planned sharing UX puts the decryption key in the URL hash fragment (`#key=...`). The hash is not sent to the server in HTTP requests. However:

- **Referrer headers:** If the download page links to an external site, the full URL (including hash) could leak via `Referer` header in some browsers. **Mitigation:** Set `Referrer-Policy: no-referrer` on all responses.
- **Browser extensions:** Extensions with `tabs` permission can read the full URL including hash. This is a user-level risk, not mitigatable by the application.
- **Redirects:** Server-side redirects (301/302) do not carry the hash. Client-side redirects (`window.location`) do. The root redirect should be verified to not inadvertently expose fragments.
- **Browser history:** The full URL including hash is stored in browser history. Users should be warned.
- **Copy/paste accidents:** Users may share the full URL (with key) instead of the link alone. Consider separating the key from the URL entirely.

---

## 4. CORS Posture

CORS is not currently configured on the Lambda URL Functions. This means:

- Browser-based API calls from other origins are blocked (default same-origin policy).
- This is acceptable for MVP where the UI is served from the same origin.
- When/if a separate frontend domain is used (e.g., CDN), CORS must be explicitly configured.

**No action needed now.** Flag for review when CloudFront is added.

---

## 5. Rate Limiting

No rate limiting exists on any endpoint. Risks:

- **Upload abuse:** Unlimited file uploads could exhaust S3 storage and incur costs.
- **Download scraping:** Automated enumeration of transfer IDs (12-char random = 2.8 trillion combinations, so brute-force is impractical, but rate limiting is still good practice).
- **Token brute-force:** The access token endpoint has no lockout mechanism.

**Priority:** Add rate limiting before public launch. Lambda URL Functions support AWS WAF integration.

---

## 6. Public Download Endpoints

Download endpoints (`/transfers/info/{id}`, `/transfers/download/{id}`) are intentionally unauthenticated. Security relies on:

- Transfer ID unguessability (12-char cryptographically random = ~60 bits of entropy).
- Content is encrypted ciphertext (useless without the key).

**This is sound by design.** The zero-knowledge model means even a leaked transfer ID exposes only ciphertext.

---

## 7. Top 3 Recommended Security Actions

| Priority | Action | Effort | Blocks |
|----------|--------|--------|--------|
| **P0** | Set `Referrer-Policy: no-referrer` on all responses | 1 line | Hash fragment key leakage |
| **P1** | Verify GA does not capture transfer IDs in page titles or custom dimensions | 30 min audit | Privacy guarantee |
| **P1** | Plan migration from shared access token to per-user tokens before public launch | Design doc | Audit trail, revocation |

---

*Next review: after hash-fragment sharing UX (WS-13) is implemented.*
