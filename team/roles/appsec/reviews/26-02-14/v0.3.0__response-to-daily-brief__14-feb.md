# v0.3.0 -- AppSec Response: Admin UI Security Review

**Version:** v0.3.0
**Date:** 14 February 2026
**Role:** AppSec (Application Security)
**Context:** Response to `team/humans/dinis_cruz/briefs/02/14/v0.3.0__daily-brief__sgraph-send-14-feb-2026.md` -- Priority 1: Admin UI security review
**Continues from:**
- `v0.2.40__review__cache-service-architecture-response.md` (cache service security, M1-M6 requirements)
- `v0.2.33__response-to-daily-brief-2__13-feb.md` (zero-knowledge verification)
- `v0.2.24__response-to-daily-brief__13-feb.md` (CSP, SRI, referrer policy)
**Architect reference:** `team/roles/architect/reviews/26-02-14/v0.3.0__response-to-daily-brief__14-feb.md` (admin UI component architecture)

---

## 1. Executive Summary

The admin UI introduces a browser-based interface for token management and analytics -- operations that were previously accessible only via Swagger UI or programmatic API calls. This review assesses the security implications of exposing these operations through a custom Web Components interface.

**Verdict: APPROVED with 4 mandatory requirements and 6 recommendations.**

The architecture is fundamentally sound because:
1. The admin Lambda already enforces API key authentication on all routes
2. All data displayed in the admin UI is non-sensitive by design (hashed IPs, opaque IDs, operational metrics)
3. The zero-knowledge guarantee is preserved -- no decryption keys, file names, or plaintext ever reach the server
4. The API key is stored in `sessionStorage` (session-scoped, not persistent)

The primary risks are: credential exposure through improper API key handling, missing security headers on admin Lambda responses, and potential XSS in data rendering.

---

## 2. Threat Model: Admin UI Attack Surface

### 2.1 New Attack Surface Introduced

The admin UI adds a custom JavaScript application that:
- Accepts user input (API key, token names, usage limits)
- Makes authenticated API calls to the admin Lambda
- Renders server responses in the DOM
- Stores credentials in browser storage

### 2.2 Threat Matrix

| Threat | Vector | Likelihood | Impact | Mitigation |
|--------|--------|------------|--------|------------|
| **T1: API key theft via XSS** | Attacker injects script that reads `sessionStorage` | LOW (no user-generated content in admin UI) | HIGH (full admin access) | CSP, SRI, input sanitisation, `textContent` rendering |
| **T2: API key in browser history** | Key passed as URL parameter | MEDIUM (if Approach B is chosen) | MEDIUM (key readable from history) | Use Approach A (login page), never put key in URL |
| **T3: API key in server logs** | Key sent as query parameter | MEDIUM (if implemented incorrectly) | MEDIUM (key in Lambda logs) | Key in header only, never in query string or URL path |
| **T4: XSS via token name rendering** | Malicious token name contains HTML/JS | LOW (admin creates tokens, not external users) | HIGH (script execution in admin context) | Always use `textContent`, never `innerHTML` for server data |
| **T5: CSRF on admin operations** | Attacker tricks admin into making unintended API calls | VERY LOW (API key in custom header prevents CSRF) | HIGH (token creation/revocation) | Custom header auth is inherently CSRF-resistant |
| **T6: Clickjacking** | Admin UI framed in attacker-controlled page | LOW (admin URL is not public) | MEDIUM (UI interaction hijacking) | `X-Frame-Options: DENY` header |
| **T7: Credential stuffing on login** | Automated attempts to guess API key | LOW (admin URL not widely known) | HIGH (full admin access) | Rate limiting on auth validation endpoint |

### 2.3 Risk Assessment Summary

| Risk Level | Count | Threats |
|------------|-------|---------|
| Needs immediate mitigation | 2 | T1 (XSS-based key theft), T4 (XSS via token name) |
| Needs architectural guardrail | 2 | T2 (key in URL), T3 (key in logs) |
| Mitigated by design | 2 | T5 (CSRF), T6 (clickjacking -- with header) |
| Acceptable residual risk | 1 | T7 (credential stuffing) |

---

## 3. API Key Handling -- Security Requirements

### 3.1 Rule: API Key MUST NOT Be Hardcoded in JavaScript

This is the single most important security requirement for the admin UI. If the API key appears in any JavaScript source file, CSS file, HTML file, or configuration file committed to the repository, it is a **critical security failure**.

**Verification test:** Search all files under `sgraph_ai_app_send__ui__admin/` for any string that could be an API key. This should be part of CI:

```bash
# CI check: no hardcoded API keys in admin UI source
grep -rn "api.key\|apikey\|api_key.*=.*['\"]" sgraph_ai_app_send__ui__admin/ \
  --include="*.js" --include="*.html" --include="*.css" \
  | grep -v "sessionStorage\|localStorage\|getItem\|setItem\|placeholder\|label\|comment"
```

### 3.2 API Key Storage: `sessionStorage` Only

The Architect's recommendation of `sessionStorage` is the correct choice. Review of alternatives:

| Storage Mechanism | Persistence | Cross-Tab | CSRF Risk | XSS Risk | Verdict |
|-------------------|-------------|-----------|-----------|----------|---------|
| **Hardcoded in JS** | Permanent (committed) | N/A | N/A | **CRITICAL** -- key in source | REJECTED |
| **`localStorage`** | Survives restart | Shared | None (header-based) | HIGH -- persists after session | REJECTED |
| **Cookie** | Configurable | Shared | **HIGH** -- auto-sent | MEDIUM | REJECTED (also violates D025) |
| **`sessionStorage`** | Tab lifetime | Isolated | None (header-based) | MEDIUM -- accessible during session | **APPROVED** |
| **JavaScript variable** | Page lifetime | Isolated | None | LOW -- cleared on navigation | Acceptable alternative |

**`sessionStorage` is the correct balance.** It persists across page navigations within a tab (important for SPA-like behaviour) but is cleared when the tab closes. The XSS risk is medium but acceptable because:
1. The admin UI has no user-generated content (reducing XSS vectors)
2. CSP headers will restrict script sources
3. The admin Lambda URL is not public knowledge

### 3.3 API Key Transmission: Header Only

The API key MUST be transmitted only in a custom HTTP header, never in:
- URL query parameters (visible in server logs, browser history, referer headers)
- URL path segments (same visibility issues)
- Request body (acceptable but inconsistent with the admin Lambda's existing header-based auth)
- Cookies (violates D025)

The admin Lambda already uses header-based API key authentication via `osbot-fast-api`'s built-in middleware. The admin UI must use the same header name.

### 3.4 Login Page Authentication Flow

The Architect proposes two approaches. AppSec strongly recommends **Approach A** (bootstrapped login page):

**Approach A (APPROVED):**
1. `/admin` serves a minimal login page -- this route is exempt from API key auth
2. Login page contains only: a text input, a submit button, and the validation logic
3. On submit, the page calls `GET /info/version` with the entered key in the header
4. If 200: store key in `sessionStorage`, redirect to `/admin/v0/v0.1/v0.1.0/console.html`
5. If 401: show error, clear input, re-prompt
6. `console.html` and all other admin routes still require the API key (via middleware)

**Approach B (REJECTED by AppSec):**
- Puts the API key in the URL, which appears in:
  - Browser history
  - Server access logs
  - Network proxy logs
  - Browser tab title (potentially)
  - `Referer` header on subsequent requests (unless `Referrer-Policy: no-referrer` is set)

### 3.5 Requirement: Login Page Must Be Minimal

The exempt login page must contain the absolute minimum code:
- No external script loads
- No API calls other than the validation request
- No analytics, no tracking, no third-party resources
- Self-contained HTML + inline JS (no separate JS file to be tampered with)
- Content Security Policy should be as restrictive as possible: `script-src 'self'`

This minimises the attack surface of the unauthenticated page.

---

## 4. CORS Policy for Admin Lambda

### 4.1 Current State

The admin Lambda's CORS policy is inherited from `Serverless__Fast_API` defaults. This needs explicit configuration for the admin UI.

### 4.2 Required CORS Configuration

```python
# Admin Lambda CORS should be restrictive
cors_origins = [
    "https://admin.send.sgraph.ai",    # Production admin domain
]
```

The admin Lambda should NOT allow `*` (wildcard) CORS origins. Only the admin domain itself needs CORS access.

**Important:** Since the admin UI is served from the same Lambda (same origin), most requests will be same-origin and CORS does not apply. CORS is only relevant if:
- The admin UI is served from a different domain than the API
- Third-party tools (like Postman or curl) access the API

For same-origin deployment (which is the current architecture), CORS restrictions are a defence-in-depth measure, not a primary control.

### 4.3 Preflight Requirements

If the admin UI makes requests with custom headers (which it does -- the API key header), browsers will send a preflight `OPTIONS` request. The admin Lambda must handle preflight correctly:

```
OPTIONS /tokens/list HTTP/1.1
Access-Control-Request-Headers: x-api-key
Access-Control-Request-Method: GET

Response:
Access-Control-Allow-Origin: https://admin.send.sgraph.ai
Access-Control-Allow-Headers: x-api-key, content-type
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Max-Age: 3600
```

**Note:** The `osbot-fast-api` framework handles CORS middleware. Verify that the admin Lambda's CORS configuration includes the API key header name in `Access-Control-Allow-Headers`.

---

## 5. Security Headers for Admin Lambda

### 5.1 Required Headers

The admin Lambda MUST set these response headers on ALL responses (static files and API):

| Header | Value | Purpose |
|--------|-------|---------|
| `Content-Security-Policy` | `default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; frame-ancestors 'none'` | Prevents XSS, clickjacking |
| `X-Frame-Options` | `DENY` | Prevents clickjacking (legacy header) |
| `X-Content-Type-Options` | `nosniff` | Prevents MIME-type sniffing |
| `Referrer-Policy` | `no-referrer` | Prevents API key leakage via referer (P0 carry-forward) |
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains` | Forces HTTPS |
| `Cache-Control` | `no-store` | Prevents caching of authenticated content |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=()` | Disables unused browser APIs |

### 5.2 CSP Notes

- `'unsafe-inline'` for `style-src` is required because Web Components use inline `<style>` tags in `render()`. This is an acceptable trade-off for the IFD architecture. If security requirements tighten, consider migrating to external CSS files or using CSP nonces.
- `frame-ancestors 'none'` replaces the `X-Frame-Options: DENY` header (CSP is the modern approach, X-Frame-Options is the fallback).
- `connect-src 'self'` restricts `fetch()` calls to same-origin only, preventing exfiltration of the API key to external servers.

---

## 6. Data Sensitivity Review: Admin UI Display

### 6.1 Confirmation: No Sensitive Data in Admin UI

Cross-referencing the Architect's component design with the data classification from `v0.2.40__review__cache-service-architecture-response.md` (Section 5):

| Component | Data Displayed | Source | Sensitive? | Notes |
|-----------|---------------|--------|------------|-------|
| Token Manager -- list | token_name, status, usage_count/limit | `/tokens/list` | NO | Token names are human-friendly, deliberately shared |
| Token Manager -- detail | Full token metadata, usage events | `/tokens/lookup/{name}` | NO | ip_hash is irreversible (SHA-256 + daily salt) |
| Token Manager -- create | User input (token_name, usage_limit) | Local form | NO | Admin-provided values |
| Analytics Dashboard | active_requests, active_visitors, active_transfers | `/health/pulse` | NO | Aggregate counts, no individual data |
| System Info | version, service name, status | `/info/*` | NO | Public information |
| Event Browser | Client-side API call log | Local JavaScript | NO | Admin's own actions |

### 6.2 What Is NOT Displayed (by design)

| Data | Why Not | Enforcement |
|------|---------|-------------|
| Encryption keys | Server never has them | Architectural (Web Crypto API, client-side only) |
| File names | Server never stores them | Architectural (SGMETA in encrypted payload) |
| File contents | Server only has ciphertext | Architectural (AES-256-GCM encryption) |
| Plaintext IP addresses | Only ip_hash stored | Application logic (SHA-256 + daily salt at middleware level) |
| User email addresses | No user accounts exist | Architectural (token-based access, no registration) |
| Raw decryption URLs | Keys in hash fragment, never sent to server | Protocol (hash fragments excluded from HTTP requests) |

### 6.3 Residual Risk: IP Hash Correlation

IP hashes appear in token usage events. While individual hashes are irreversible, an attacker with admin access could observe that the same ip_hash appears across multiple token usages, revealing that the same IP accessed multiple tokens. This is operational monitoring data, not PII, but it is worth noting.

**Risk level: LOW.** The daily salt rotation means ip_hashes are only correlatable within a single day. Cross-day correlation is not possible.

---

## 7. XSS Prevention in Admin UI

### 7.1 Rule: All Server Data Rendered via `textContent`

Every piece of data received from the server and rendered in the DOM MUST use `textContent`, never `innerHTML`:

```javascript
// CORRECT: safe rendering
element.textContent = tokenData.token_name;

// INCORRECT: XSS vulnerability
element.innerHTML = tokenData.token_name;
```

### 7.2 High-Risk Rendering Points

| Component | Data Rendered | Risk if innerHTML Used |
|-----------|--------------|----------------------|
| Token Manager -- token_name | Arbitrary string from server | Script injection via crafted token name |
| Token Manager -- created_by | String from token creator | Script injection |
| Token Manager -- metadata | JSON object from server | Script injection via JSON values |
| Event Browser -- event details | Various server response data | Script injection |

### 7.3 Template Literal Safety

Web Components use template literals in `render()`:

```javascript
// DANGEROUS: interpolating server data into innerHTML
render() {
    this.innerHTML = `<div>${this.tokenName}</div>`;  // XSS if tokenName contains HTML
}

// SAFE: set structure first, then use textContent
render() {
    this.innerHTML = `<div class="atm-name"></div>`;
    this.querySelector('.atm-name').textContent = this.tokenName;
}
```

**Recommendation:** Establish a rendering pattern where `innerHTML` is used only for static HTML structure (no interpolated variables), and all dynamic data is set via `textContent` or `setAttribute` after the structure is created.

### 7.4 Test Requirement

Write a test that creates a token with a name containing HTML/script tags:

```
Token name: <script>alert('xss')</script>
Expected: Name displays as literal text, no script execution
```

This test should be part of the admin UI QA checklist.

---

## 8. Carry-Forward from Previous Reviews

### 8.1 Items from v0.2.40 (Cache Service Security)

| # | Previous Requirement | Status | Update |
|---|---------------------|--------|--------|
| M1 | Regression test: admin endpoints return 404 on public Lambda URL | **STILL REQUIRED P0** | Not related to admin UI, but blocks deployment |
| M2 | Pin exact dependency versions | **STILL REQUIRED P0** | Not related to admin UI, but blocks deployment |
| M3 | Cross-prefix isolation test | **STILL REQUIRED P1** | Not related to admin UI |
| M4 | `Send__Cache__Client` no `admin_storage()` exposure | **STILL REQUIRED P1** | Not related to admin UI |
| M5 | Document architecture boundary in code | **STILL REQUIRED P1** | Not related to admin UI |
| M6 | Rate limiting on token resolution | **STILL REQUIRED P1** | Relevant to admin UI -- the token lookup endpoint needs rate limiting before the token system is user-facing |

### 8.2 Items from v0.2.33 and v0.2.24

| # | Previous Action | Status | Update |
|---|----------------|--------|--------|
| 1 | `Referrer-Policy: no-referrer` on all responses | **STILL REQUIRED P0** | Now also required on admin Lambda responses |
| 2 | `history.replaceState` after decryption | Still required P1 | User Lambda only, not admin UI |
| 3 | Strict CSP headers | **STILL REQUIRED P1** | Now also required on admin Lambda (see Section 5) |
| 4 | SRI on all script/stylesheet references | **UPDATED P2** | For admin UI: all scripts loaded from same origin, SRI is defence-in-depth |
| 5 | `textContent` not `innerHTML` for data rendering | **STILL REQUIRED P1** | Now also required in admin UI components |
| 6 | Key expiry mechanism in localStorage | Still required P2 | User Lambda only |

---

## 9. Mandatory Requirements for Admin UI

These conditions must be met before the admin UI ships:

| # | Requirement | Priority | Rationale |
|---|-------------|----------|-----------|
| **AU-1** | **API key in `sessionStorage` only** -- never in `localStorage`, never in cookies, never in URL, never hardcoded in source files | P0 | Credential exposure prevention |
| **AU-2** | **Login page exempt from API key auth** -- minimal HTML, no external resources, self-contained validation | P0 | Bootstrap authentication without exposing key in URL |
| **AU-3** | **All server data rendered via `textContent`** -- no `innerHTML` interpolation of server-provided values | P0 | XSS prevention |
| **AU-4** | **Security headers on admin Lambda responses** -- CSP, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, HSTS, Cache-Control | P1 | Defence-in-depth against XSS, clickjacking, MIME sniffing, credential leakage |

---

## 10. Recommendations

| # | Recommendation | Priority | Rationale |
|---|---------------|----------|-----------|
| AU-R1 | Add CI check for hardcoded API keys in admin UI source files | P1 | Prevent accidental credential commits |
| AU-R2 | Implement `Cache-Control: no-store` on all admin API responses | P1 | Prevent caching of authenticated data in browser or proxy |
| AU-R3 | Add `connect-src 'self'` to CSP | P1 | Prevent API key exfiltration via `fetch()` to external servers |
| AU-R4 | Log failed authentication attempts on admin Lambda | P2 | Detect credential stuffing or brute-force attempts |
| AU-R5 | Consider session timeout -- clear `sessionStorage` after 30 minutes of inactivity | P2 | Reduce exposure window if admin leaves browser open |
| AU-R6 | Test token creation with XSS payload in token name | P1 | Verify `textContent` rendering prevents script injection |

---

## 11. Updated Cumulative Action Items

### Active Actions (all sources, ordered by priority)

| # | Action | Priority | Owner | Source | Status |
|---|--------|----------|-------|--------|--------|
| 1 | `Referrer-Policy: no-referrer` on all responses (both Lambdas) | **P0** | Dev | v0.2.24 | Carried |
| 2 | Regression test: admin endpoints 404 on public Lambda URL | **P0** | QA/Dev | v0.2.40 M1 | Carried |
| 3 | Pin exact dependency versions in Lambda config | **P0** | Dev | v0.2.40 M2 | Carried |
| 4 | API key in `sessionStorage` only | **P0** | Dev | **NEW -- AU-1** | New |
| 5 | Login page exempt from API key auth | **P0** | Dev/DevOps | **NEW -- AU-2** | New |
| 6 | All server data rendered via `textContent` | **P0** | Dev | **NEW -- AU-3** | New |
| 7 | Security headers on admin Lambda | **P1** | Dev | **NEW -- AU-4** | New |
| 8 | `history.replaceState` after decryption | P1 | Dev | v0.2.24 | Carried |
| 9 | Strict CSP headers (both Lambdas) | P1 | Dev | v0.2.33 | Updated |
| 10 | SRI on script/stylesheet references | P1 | Dev | v0.2.33 | Carried (P2 for admin) |
| 11 | Cross-prefix isolation test | P1 | QA/Dev | v0.2.40 M3 | Carried |
| 12 | Audit `Send__Cache__Client` -- no admin_storage() | P1 | AppSec/Dev | v0.2.40 M4 | Carried |
| 13 | Document architecture boundary in code | P1 | Dev | v0.2.40 M5 | Carried |
| 14 | Rate limiting on token resolution | P1 | Dev | v0.2.40 M6 | Carried |
| 15 | Salt the cache hash for token namespace | P1 | Dev | v0.2.33 | Carried |
| 16 | `textContent` not `innerHTML` for user UI data | P1 | Dev/QA | v0.2.24 | Carried |
| 17 | CI check for hardcoded API keys in UI source | P1 | DevOps | **NEW -- AU-R1** | New |
| 18 | `Cache-Control: no-store` on admin API responses | P1 | Dev | **NEW -- AU-R2** | New |
| 19 | XSS test with script payload in token name | P1 | QA | **NEW -- AU-R6** | New |
| 20 | Key expiry in localStorage (user UI) | P2 | Dev | v0.2.33 | Carried |
| 21 | Constant-time token lookup | P2 | Dev | v0.2.33 | Carried |
| 22 | Token probing audit trail | P2 | Dev | v0.2.33 | Carried |
| 23 | Per-user token migration | P2 | Architect/Dev | v0.2.24 | Carried |
| 24 | Separate S3 bucket for cache service extraction | P2 | DevOps | v0.2.40 | Carried |
| 25 | Monitor Lambda cold start impact | P2 | DevOps | v0.2.40 | Carried |
| 26 | Pin all `pyproject.toml` deps to exact versions | P2 | Dev | v0.2.40 | Carried |
| 27 | Log failed auth attempts on admin Lambda | P2 | Dev | **NEW -- AU-R4** | New |
| 28 | Session timeout (clear sessionStorage after inactivity) | P2 | Dev | **NEW -- AU-R5** | New |

**P0 count: 6** (3 carried, 3 new from admin UI)
**P1 count: 13** (9 carried, 4 new from admin UI)
**P2 count: 9** (7 carried, 2 new from admin UI)

---

## 12. Summary

The admin UI introduces a browser-based interface for token management and analytics monitoring. The security posture is strong because:

1. **The admin Lambda is already authenticated** -- API key required on all routes
2. **All displayed data is non-sensitive** -- hashed IPs, opaque transfer IDs, operational metrics
3. **Zero-knowledge is preserved** -- no keys, file names, or plaintext ever reach the server
4. **CSRF is mitigated by design** -- custom header authentication prevents cross-site request forgery
5. **The API key storage model is correct** -- `sessionStorage` provides session-scoped, tab-isolated credential storage

The primary risks are XSS (mitigated by `textContent` rendering and CSP) and credential exposure (mitigated by `sessionStorage` and login page architecture). The four mandatory requirements (AU-1 through AU-4) must be implemented before the admin UI ships.

---

*AppSec review complete. This document assesses the security implications of the admin UI as designed in the Architect's v0.3.0 response. All findings are consistent with the existing threat model and carry-forward from previous reviews.*
