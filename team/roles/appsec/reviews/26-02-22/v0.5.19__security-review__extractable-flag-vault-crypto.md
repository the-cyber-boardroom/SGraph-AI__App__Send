# AppSec Security Review: `extractable` Flag in vault-crypto.js

**Version:** v0.5.19
**Date:** 22 February 2026
**Role:** AppSec
**Team:** Explorer
**Classification:** Security Critical
**Reviewed file:** `sgraph_ai_app_send__ui__user/v0/v0.1/v0.1.7/js/vault-crypto.js`
**Reference file:** `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.3/components/pki-keys/pki-keys.js`

---

## SEVERITY: HIGH -- Change was unnecessary and introduced private key exfiltration risk. Reverted immediately.

---

## What Happened

During a bug fix session (commit `a64275e`), the `extractable` parameter in `VaultCrypto.generateKeyPair()` was changed from `false` to `true`. The stated reason was that `deriveVaultCacheKey()` calls `crypto.subtle.exportKey('spki', publicKey)` which was believed to throw `InvalidAccessError` for non-extractable keys.

**This diagnosis was incorrect.** The change was reverted in a follow-up commit.

---

## Root Cause of the Misdiagnosis

The developer incorrectly assumed that `extractable: false` prevents public key export. The W3C Web Crypto API specification states:

For `generateKey()` on asymmetric algorithms (RSA-OAEP, ECDSA, ECDH):
- **Public key** `[[extractable]]` = **always `true`** (hardcoded per spec)
- **Private key** `[[extractable]]` = the value of the `extractable` parameter

This means:
- `crypto.subtle.exportKey('spki', publicKey)` **always works**, regardless of the `extractable` parameter
- `crypto.subtle.exportKey('pkcs8', privateKey)` **only works when `extractable: true`**

The admin codebase confirms this: `pki-keys.js:92` generates with `extractable: false` and `pki-keys.js:93` successfully exports the public key via `exportPublicKeyPEM()`.

---

## Security Impact of the (Now-Reverted) Change

| Dimension | `extractable: false` (correct) | `extractable: true` (was briefly deployed) |
|-----------|-------------------------------|--------------------------------------------|
| Public key export | Works | Works |
| Private key export | **Blocked by browser** | **Allowed -- any JS can extract** |
| XSS blast radius | Session-bounded | **Permanent total key compromise** |
| Recovery after XSS | Patch XSS, done | Must rotate key and re-encrypt ALL vault data |
| Compliance | Matches D-PKI-002, investor materials | Violates D-PKI-002, falsifies investor claims |

---

## Corrected Lesson

The previous Dev review (Bug #6) and Historian record incorrectly stated:

> "Web Crypto `extractable` flag affects public key export -- not just private keys"

**This is incorrect.** The correct statement is:

> For asymmetric key pairs, the `extractable` parameter only controls private key exportability. The public key is always extractable per the W3C spec. `exportKey('spki', publicKey)` works regardless of the `extractable` flag.

---

## Process Recommendation

Any change to files matching `*/vault-crypto.js`, `*/crypto.js`, or `*/pki-*.js` that modifies `generateKey`, `exportKey`, `importKey`, or the `extractable` parameter should require AppSec review before merge. This could be enforced via CODEOWNERS or CI check.

---

## Related Documents

- Decision D-PKI-002: `team/roles/historian/reviews/26-02-20/v0.4.25__milestone__first-pki-message-exchange.md`
- Architect implementation plan: `team/roles/architect/reviews/26-02-20/v0.4.17__implementation-plan__browser-pki-key-management.md`
- Admin PKI keys (correct pattern): `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.3/components/pki-keys/pki-keys.js:92`
- Investor briefing pack: `library/alchemist/materials/v0.5.8__investor-briefing-pack__pki-milestone.md`
