# v0.5.19 — Decision Record: User Shell Architecture & Vault Bug Triage

**Version:** v0.5.19
**Date:** 22 February 2026
**Role:** Historian
**Team:** Explorer

---

## Decision Summary

| Field | Value |
|-------|-------|
| Decision | Create a dedicated user-facing shell component (`user-shell`), separate from the admin shell |
| Trigger | Manual testing of vault feature on both admin and user UIs exposed 8 bugs and revealed the need for consistent navigation and debug tooling |
| Status | Approved for Explorer experimentation |
| Impact | Architectural — establishes two parallel shell codebases serving different Lambda functions |

---

## Context

The PKI-keyed personal data vault (v0.5.19) is the first feature that exists in **both** UIs — the admin console and the user-facing app. During manual testing, Dinis discovered:

1. The admin vault had 5 bugs (SVG sizing, fingerprint display, binary response encoding, response shape mismatch, logo CSS)
2. The user vault had 3 bugs (key generation blocker, stuck spinner, API response mismatch)
3. The user UI has no shell component — navigation is hardcoded in each HTML page
4. The user UI has no debug panel, making it harder to diagnose the 500 error that was visible in browser dev tools

This testing session demonstrated that:
- **Response shape contracts** between server and client are critical and were not enforced
- **Error boundaries** in async UI code are essential — two bugs resulted in permanently stuck UIs
- **Debug tooling** should be available in all UIs, not just admin
- **Feature parity** between UIs requires shared infrastructure (shell, routing, debug panel)

---

## Timeline of Events

| # | Event | Category |
|---|-------|----------|
| 1 | Dinis tests admin vault — discovers oversized folder icon, "Key: unknown", missing folder/file rendering | Bug discovery |
| 2 | Dinis identifies 500 error on `/vault/index/{key}` in browser network tab | Bug discovery |
| 3 | Dinis notes SG/Send logo slash rendering issue | UI polish |
| 4 | All 5 admin bugs fixed in one commit | Bug fix |
| 5 | Dinis tests user vault — "Generate Key Pair" button does nothing | Bug discovery |
| 6 | Dinis observes "Loading vault..." stuck spinner | Bug discovery |
| 7 | Root cause: `extractable: false` in `generateKeyPair()` prevents `exportKey()` | Root cause analysis |
| 8 | Root cause: `_generateKeys()` has no error handling — state permanently stuck at 'loading' | Root cause analysis |
| 9 | Response shape mismatch identified — routes return `{data: ...}` but user vault expects `{encrypted_index: ...}` | Root cause analysis |
| 10 | Dinis proposes user shell architecture — separate from admin, simpler UI, with debug panel | Architecture decision |
| 11 | All 3 user vault bugs fixed | Bug fix |
| 12 | Dev review and Historian record created | Documentation |

---

## Architectural Decision: Two Shell Components

### The Pattern

```
User Lambda (send.sgraph.ai)              Admin Lambda (admin.sgraph.ai)
├── user-shell.js                         ├── admin-shell.js
│   ├── Minimal chrome (header, nav)      │   ├── Full chrome (sidebar, nav)
│   ├── Debug panel (opt-in)              │   ├── Debug panel (always visible)
│   ├── Route: /send → send-upload        │   ├── Route: pki-keys
│   ├── Route: /vault → user-vault        │   ├── Route: vault-manager
│   └── Route: /download → send-download  │   └── Route: tokens, stats, etc.
└── Served by user Lambda                 └── Served by admin Lambda
```

### Rationale

1. **Separation of concerns** — User UI is public-facing (minimal, clean). Admin UI is operator-facing (feature-rich, verbose).
2. **Independent deployment** — Two Lambda functions, two static asset trees, two release cycles.
3. **Shared debug panel** — The debug panel pattern (health check, timing breakdown, raw API responses) should be available in both, but opt-in for users.
4. **Web Component architecture** — Each feature is a self-contained component (IFD), loaded by the shell's router.

### Constraints

- User shell must remain zero-dependency (vanilla JS, Web Components)
- User shell serves from user Lambda (`/send/` route)
- Admin shell serves from admin Lambda (`/admin/` route)
- Debug panel code can be shared (loaded from common path)

---

## Bug Classification

### Severity: Critical (P0)
- **Bug #6** — "Generate Key Pair" does nothing (key generation silently fails due to `extractable: false`)
- **Bug #3** — 500 error on vault index GET (binary data can't be JSON-serialized)

### Severity: High (P1)
- **Bug #7** — "Loading vault..." stuck forever (no error recovery)
- **Bug #4** — Folders/files don't render (response shape mismatch)
- **Bug #8** — Index/file response fields mismatched between server and client

### Severity: Medium (P2)
- **Bug #1** — Oversized folder icon (SVG fills container)
- **Bug #2** — "Key: unknown" (fingerprint not computed)
- **Bug #5** — Logo slash looks like pipe character

---

## Lessons Learned

| # | Lesson | Action |
|---|--------|--------|
| 1 | Response shapes between server routes and JS clients need explicit contracts | Define response schemas in route docstrings |
| 2 | Async state machines (`loading → success/error`) must guarantee exit from `loading` | All async lifecycle methods need try-catch guards |
| 3 | Web Crypto `extractable` flag affects public key export — not just private keys | Document crypto parameter choices; share between UIs |
| 4 | Manual testing of both UIs caught bugs automated tests missed (visual, integration) | Add E2E smoke tests for vault lifecycle |
| 5 | Debug panel access in user UI would have surfaced the 500 error faster | Include debug panel in user shell architecture |

---

## Related Documents

- Dev review: `team/roles/dev/reviews/26-02-22/v0.5.19__review__vault-ui-bugs-and-shell-architecture.md`
- Previous vault architecture: `team/roles/dev/reviews/26-02-22/v0.5.19__review__pki-vault-revised-cache-service-architecture.md`
- PKI milestone: `team/roles/historian/reviews/26-02-20/v0.4.25__milestone__first-pki-message-exchange.md`
