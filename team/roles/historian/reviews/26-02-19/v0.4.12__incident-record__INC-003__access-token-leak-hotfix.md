# v0.4.12 -- Historian Incident Record: INC-003 Access Token Leak Hotfix

**Version:** v0.4.12
**Date:** 19 February 2026
**Role:** Historian (Explorer team)
**Type:** Incident record and decision capture
**Related:** [AppSec incident response](../../appsec/reviews/26-02-19/v0.4.12__incident-response__access-token-leak.md)
**Continues from:** [`v0.3.12__action-plan__brief-response-15-feb.md`](../26-02-15/v0.3.12__action-plan__brief-response-15-feb.md) (M015, D048-D057, 20 named patterns, Q001-Q013)

---

## 1. Incident Summary

**INC-003: Access Token Leak via Shareable URLs**

Sender access tokens were embedded as `?token=` query parameters in every shareable URL generated since v0.1.3. The token -- a sender authentication credential -- was visible to recipients, server logs, browser history, HTTP Referer headers, and intermediary proxies.

The zero-knowledge encryption model held throughout: no file content was ever at risk. The leaked tokens granted platform access (upload, token validation) and consumed sender quota on recipient downloads.

### Timeline (19 February 2026)

| Time | Event | Actor |
|------|-------|-------|
| ~13:50 | Token discovered in shareable URL during routine use | Dinis Cruz (human) |
| ~14:00 | Incident classified as P3-as-P1 (low blast radius / high severity) | Dinis Cruz |
| 14:56 | AppSec incident response report committed to git | Agent (AppSec role) |
| ~15:04 | Security hotfix committed (8 files, 4 frontend + 1 backend + 2 tests + 1 new test) | Agent (Dev role) |
| ~15:10 | Hotfix initially on feature branch (wrong branch -- mixed with unreviewed work) | Agent |
| ~15:20 | Hotfix cherry-picked onto clean `hotfix-token-leak` branch from `dev` | Agent |
| ~15:30 | Hotfix deployed to production | Dinis Cruz |
| ~15:30 | 153 tests passing (including new URL sanitisation suite) | CI / local test run |

**Total elapsed time from discovery to production fix: ~100 minutes.**

### Before and After (Production URLs)

**Before hotfix (token leaked in query string):**
```
https://send.sgraph.ai/send/v0/v0.1/v0.1.6/download.html?token=[REDACTED]#[TRANSFER-ID-1]/[DECRYPTION-KEY-1]
```
The `?token=[REDACTED]` is the sender's access token, visible to the server, logs, and recipients.

**Shareable (link-only) URL before hotfix:**
```
https://send.sgraph.ai/send/v0/v0.1/v0.1.6/download.html?token=[REDACTED]#[TRANSFER-ID-1]
```

**After hotfix (token removed):**
```
https://send.sgraph.ai/send/v0/v0.1/v0.1.6/download.html#[TRANSFER-ID-2]/[DECRYPTION-KEY-2]
```
Only the transfer ID and encryption key remain. The key stays in the hash fragment (never sent to the server).

**Shareable (link-only) URL after hotfix:**
```
https://send.sgraph.ai/send/v0/v0.1/v0.1.6/download.html#[TRANSFER-ID-2]
```

---

## 2. Milestone Record

### M016: First Security Hotfix Deployed to Production

**Date:** 19 February 2026
**Version:** v0.4.12
**Significance:** The project's first security hotfix, from discovery through root cause analysis, code fix, test creation, code review, and production deployment -- all completed within ~100 minutes.

**Why this matters for the historical record:**

1. **First real security incident with production impact.** INC-001 (commit impersonation, 12 Feb) was a process issue. INC-002 (external security review, 17 Feb) was a planned assessment. INC-003 is the first security vulnerability discovered in production, affecting live URLs shared with real users.

2. **The P3-as-P1 philosophy was applied in practice.** Dinis Cruz treated this as P1 despite the beta's limited blast radius. The full incident response chain ran: classification, root cause analysis, hotfix development, review, cherry-pick to clean branch, deployment. This matches the incident handling philosophy documented by the Journalist on 13 Feb ("Why We Treat Every Incident Like a Crisis").

3. **The hotfix workflow matured in real time.** The initial fix was committed on the wrong branch (a feature branch with unreviewed work). This was caught during review, and the fix was cleanly cherry-picked onto a dedicated hotfix branch from `dev`. The correction itself is a process improvement -- future hotfixes now have a pattern to follow: branch from `dev`, cherry-pick only the fix, deploy independently.

4. **IFD versioning required multi-version patching.** The bug existed in v0.1.3 through v0.1.6 (four IFD versions). The hotfix patched all four versions simultaneously. This is the first real test of the IFD override mechanism for security fixes -- Pattern 3 (IFD amplification) from the AppSec report confirmed: IFD carries bugs forward, but also allows targeted patching across all versions.

5. **153 tests passing including new regression guard.** A dedicated `test_url_sanitisation.py` was created as part of the hotfix. This is the first negative security test in the codebase -- testing that sensitive data does NOT appear in URLs, not just that URLs work correctly.

**Cumulative milestone count: M001-M016 (16 milestones in 8 working days).**

---

## 3. Decision Log Update

### New Decisions: D068-D073 (19 February 2026, INC-003)

| ID | Decision | Date | Rationale | Made By |
|----|----------|------|-----------|---------|
| D068 | **Sender tokens must never appear in shareable URLs** | 2026-02-19 | Authentication credentials are not download authorization. The sender's token is a credential that proves identity; embedding it in a URL distributes it to every recipient. | Agent (AppSec), confirmed by human |
| D069 | **Backend must not return token_name in transfer completion response** | 2026-02-19 | The server returning `token_name` in the complete endpoint was the root enabler. Removing it ensures the frontend cannot embed it even accidentally. | Agent (Dev) |
| D070 | **URL sanitisation tests are mandatory for all URL construction paths** | 2026-02-19 | No tests existed that verified shareable URLs did not contain sensitive data. The new `test_url_sanitisation.py` suite is the template for this pattern. | Agent (QA/Dev) |
| D071 | **Security hotfixes use dedicated branches from dev, not feature branches** | 2026-02-19 | The initial fix was on a feature branch with unreviewed work. Cherry-picking to a clean hotfix branch from `dev` ensures only the fix goes to production. This is now the established pattern. | Dinis Cruz |
| D072 | **Downloads work without tokens in the URL** | 2026-02-19 | The download components already handled null tokens (`if (this.tokenName)` guard). No download-side changes were needed. Anonymous download is the post-hotfix behaviour. | Agent (Dev) |
| D073 | **All affected IFD versions patched simultaneously** | 2026-02-19 | v0.1.3, v0.1.4, v0.1.5, and v0.1.6 all carried the bug. All four were patched in the same commit. Security fixes override the IFD version independence principle. | Agent (Dev) |

### Decision Type Analysis Update

| Brief / Session | Decisions | Range | Decision Type |
|-----------------|-----------|-------|---------------|
| Infrastructure brief (08 Feb) | 13 | D001-D013 | Architectural |
| Daily Brief #1 (13 Feb) | 10 | D014-D023 | Capability + policy |
| Daily Brief #2 (13 Feb) | 10 | D024-D033 | Capability + policy |
| v0.3.0 Brief (14 Feb) | 4 | D034-D037 | Consolidation |
| v0.3.2 Briefs (14 Feb) | 10 | D038-D047 | Structural + strategic |
| v0.3.10 Brief (15 Feb) | 5 | D048-D052 | Operational + validation |
| v0.3.12 Human Decisions (15 Feb) | 5 | D053-D057 | Execution + scope |
| v0.4.4-v0.4.12 Briefs (16-19 Feb) | 10 | D058-D067 | External engagement + maturity |
| **INC-003 Hotfix (19 Feb)** | **6** | **D068-D073** | **Incident response + process** |
| **Total** | **73** | D001-D073 | |

A new decision type emerges: **incident response + process.** These decisions are made under time pressure, codify security principles, and establish patterns for future incidents. They are qualitatively different from planning decisions -- they are reactive, immediate, and irreversible once deployed.

**Cumulative decision count: D001-D073 (73 decisions in 8 working days, 9.1/day average).**

---

## 4. Patterns Observed

### Pattern 17: P3-as-P1 Philosophy Applied to Internal Discovery

**First observed:** 19 February 2026
**Source:** INC-003 hotfix timeline
**Description:** The P3-as-P1 incident philosophy (first documented 13 Feb) was applied to a vulnerability discovered internally during routine use. The human treated the discovery with the same urgency as an externally reported P1, running the full incident response chain within 100 minutes.

**Why this is a named pattern:** INC-002 (17 Feb external security review) was a planned assessment -- treating it as P1 was a policy choice. INC-003 was discovered by the human while using the product normally. The same P1 urgency was applied without prompting, confirming that the philosophy is internalised, not just policy.

**Historical significance:** The P3-as-P1 philosophy has now been tested three ways: (1) documented as theory (13 Feb, Journalist article), (2) applied to external disclosure (17 Feb, INC-002), (3) applied to internal discovery (19 Feb, INC-003). Each test strengthens the pattern.

### Pattern 18: Hotfix Branch Discipline (Learned In-Incident)

**First observed:** 19 February 2026
**Source:** INC-003 branch correction
**Description:** The initial hotfix was committed to the active feature branch, which contained unreviewed work. The human caught this during review and directed a cherry-pick to a clean branch from `dev`. This process correction happened during the incident, establishing a new pattern for future hotfixes.

**Why this is a named pattern:** Most process improvements come from post-mortems. This one was identified and corrected during the incident itself. The cost of the mistake was low (a few minutes of re-work), but the pattern it established is durable: security hotfixes get dedicated branches from `dev`, containing only the fix.

### Pattern 19: IFD Security Override

**First observed:** 19 February 2026
**Source:** INC-003 hotfix spanning v0.1.3-v0.1.6
**Description:** The IFD methodology treats each version as independent and immutable. Security fixes override this principle -- all affected versions are patched simultaneously in a single commit. This is the first practical application of the "IFD amplification" concern raised in the AppSec report.

**Why this is a named pattern:** IFD's core value proposition is version independence. Security is the exception. This creates a formal category of changes that cross IFD version boundaries, establishing that security overrides independence.

### Cumulative Named Patterns

| # | Pattern Name | First Observed |
|---|-------------|----------------|
| 1-13 | (See v0.3.0 and v0.3.2 reviews) | 08-14 Feb |
| 14 | Privacy-by-design as role-model governance | 15 Feb |
| 15 | Three-track sprint structure | 15 Feb |
| 16 | Explorer-specific briefing as structural divergence | 15 Feb |
| **17** | **P3-as-P1 philosophy applied to internal discovery** | **19 Feb** |
| **18** | **Hotfix branch discipline (learned in-incident)** | **19 Feb** |
| **19** | **IFD security override** | **19 Feb** |
| A-D | (See v0.3.0 review -- lettered patterns) | 13-14 Feb |

**Cumulative named patterns: 23** (19 numbered + 4 lettered).

---

## 5. Incident Registry

### INC-003 in Context

| Incident | Date | Type | Severity | Resolution Time | Key Learning |
|----------|------|------|----------|----------------|--------------|
| INC-001 | 12 Feb | Commit impersonation | Process | Same day | Git config hygiene |
| INC-002 | 17 Feb | External security review | P1 (process) | Ongoing | 29 findings; zero-knowledge validated |
| **INC-003** | **19 Feb** | **Access token in URLs** | **P3-as-P1** | **~100 minutes** | **Auth credentials must never be forwarded; negative security tests needed** |

### Connection to INC-002

INC-003 was not found in the INC-002 security review (17 Feb). The external reviewer focused on server-side findings (token race conditions, localStorage usage, CSP). The URL token leak was a client-side design flaw in the URL construction logic. This reinforces the AppSec report's lesson: security reviews and internal monitoring are complementary, not substitutes.

---

## 6. Timeline Update

Building on the timeline from v0.3.12:

```
2026-02-08  | v0.1.4 brief: focus on MVP infrastructure (D001-D013)
2026-02-10  | v0.2.1: repo refactored, master index published
2026-02-12  | v0.2.16: MVP shipped, domain live, INC-001 (commit impersonation)
2026-02-13  | v0.2.24-v0.2.33: Daily Briefs #1 and #2 (D014-D033)
            | 3 UI versions shipped, 7 bug fixes
2026-02-14  | v0.3.0: Foundation sprint complete (D034-D037)
            | v0.3.2: Explorer/Villager team split (M014, D038-D047)
2026-02-15  | v0.3.10-v0.3.12: First Explorer brief, LETS pipeline (M015, D048-D057)
2026-02-16  | v0.4.4: DPO article, daily brief 16 Feb (D058-D061)
2026-02-17  | v0.4.7-v0.4.9: INC-002 first external security review (D062-D067)
            | 29 findings, zero-knowledge validated, P1 incident response
2026-02-18  | v0.4.10: Strategic expansion -- Accountant role, encrypted chat,
            | partner ecosystem, User A interview
2026-02-19  | v0.4.11-v0.4.12: INC-003 access token leak                      <-- NEW
            | ~13:50  Token discovered in live URL by human                     <-- NEW
            | ~14:00  Classified P3-as-P1                                       <-- NEW
            | 14:56   AppSec incident response report committed                 <-- NEW
            | ~15:04  Security hotfix committed (8 files)                       <-- NEW
            | ~15:10  Fix initially on wrong branch (feature branch)            <-- NEW
            | ~15:20  Cherry-picked to clean hotfix branch from dev             <-- NEW
            | ~15:30  Hotfix deployed to production (153 tests passing)         <-- NEW
            | M016: First security hotfix deployed to production                <-- NEW
            | D068-D073 logged (73 cumulative decisions)                        <-- NEW
            | Patterns 17-19 identified (23 cumulative named patterns)          <-- NEW
```

---

## 7. Lessons Learned (Historian Perspective)

### 7.1 The Zero-Knowledge Architecture Proved Its Value Twice in One Week

INC-002 (17 Feb, external review) validated that the cryptographic model is sound. INC-003 (19 Feb, token leak) validated that the architecture limits blast radius -- even when an authentication credential is fully exposed in URLs shared with real users, no file content was compromised. The encryption key remained safely in the hash fragment. Two different types of test (planned review and accidental leak) both confirmed the same architectural property.

### 7.2 Process Improvements Can Happen During Incidents, Not Just After

The hotfix branch discipline (Pattern 18) was learned and applied during INC-003, not in a post-mortem. The human caught the wrong-branch issue during review and directed the correction immediately. This is a faster feedback loop than the traditional "incident -> post-mortem -> action item -> process change" cycle.

### 7.3 The Incident Handling Series Is Now a Tested Playbook

The Journalist's article "Why We Treat Every Incident Like a Crisis" (13 Feb) and the P3-as-P1 philosophy have now been tested against three incidents (INC-001 through INC-003). Each incident reinforced the philosophy. The theoretical framework has become a tested playbook.

---

## 8. Open Questions Update

| ID | Question | Status | Update |
|----|----------|--------|--------|
| Q001-Q013 | (See v0.3.12 review) | Various | Unchanged by INC-003 |
| **Q014** | Should token rotation be performed for tokens that appeared in shareable URLs during v0.1.3-v0.1.6? | **Open** | AppSec recommends rotation. Human decision pending. Beta blast radius is small but the principle matters. |
| **Q015** | Should server logs be audited for exposed tokens from the affected period? | **Open** | AppSec preventive measure #5. Requires DevOps. |
| **Q016** | Should a formal download authorization model replace the current anonymous-download approach? | **Open** | AppSec recommends architectural separation. Not urgent for beta but needed before general availability. |

---

## Summary

INC-003 is the project's first security vulnerability discovered and fixed in production. The full cycle -- discovery, classification, root cause analysis, hotfix development, code review, branch correction, deployment, and test verification -- completed in approximately 100 minutes.

Milestone M016 records the first security hotfix deployed to production. Six decisions (D068-D073) codify the security principles and process patterns that emerged. Three new patterns (17-19) capture the P3-as-P1 philosophy in practice, the hotfix branch discipline learned during the incident, and the IFD security override precedent.

The zero-knowledge architecture proved its value: despite full token exposure in shared URLs, no file content was compromised. The hash fragment design held exactly as intended.

**Cumulative record: 16 milestones, 73 decisions, 23 named patterns, 16 open questions across 8 working days.**

---

*Historian incident record complete. This document records M016, logs D068-D073, identifies patterns 17-19, and raises Q014-Q016. The incident is resolved and deployed. Outstanding items: token rotation decision (Q014), server log audit (Q015), and download authorization model design (Q016).*
