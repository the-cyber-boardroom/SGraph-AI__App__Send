# v0.1.2 — Data Model and Storage Structure

**Version:** v0.1.2
**Date:** 2026-02-09
**Author:** Claude (Architect role)
**Status:** DRAFT
**Extracted from:** FastAPI service plan per Conductor request

---

## 1. Storage Abstraction

All data is stored via Memory-FS (`Storage_FS` interface). The application code never knows which backend is active.

```
Application Code
       │
       ▼
Storage__App__Send          (app-specific wrapper)
       │
       ▼
Memory-FS (Storage_FS)      (pluggable backend)
       │
       ├── Storage_FS__Memory      (tests — in-memory dict)
       ├── Storage_FS__Local_Disk  (dev — filesystem)
       ├── Storage_FS__Sqlite      (embedded deployments)
       ├── Storage_FS__Zip         (export/backup)
       └── Storage_FS__S3          (prod — via osbot-aws, provided by Conductor)
```

**Interface used:**
```python
storage_fs.file__save(path, content_bytes)
storage_fs.file__str(path)
storage_fs.file__bytes(path)
storage_fs.file__exists(path)
storage_fs.file__delete(path)
storage_fs.files__paths()
```

---

## 2. File Layout — Transfer Data

Each transfer gets a dedicated folder. **Everything** that happens related to a transfer is stored here.

```
transfers/{transfer_id}/
├── meta.json                          Transfer metadata (created on POST /transfers/create)
├── payload.enc                        Encrypted file blob (uploaded by client)
├── events/                            One file per lifecycle event
│   ├── {timestamp}__created.json
│   ├── {timestamp}__upload_started.json
│   ├── {timestamp}__upload_completed.json
│   ├── {timestamp}__downloaded.json
│   ├── {timestamp}__downloaded.json     (one per download)
│   └── {timestamp}__expired.json
└── requests/                          One file per HTTP request (observability)
    ├── {timestamp}__{request_id}.json
    ├── {timestamp}__{request_id}.json
    └── ...
```

### 2.1 meta.json Schema

```json
{
  "transfer_id"     : "abc123def456",
  "status"          : "pending",
  "file_size_bytes" : 4821033,
  "content_type_hint": "application/pdf",
  "token_id"        : "tok_xyz789abc012",
  "created_at"      : 1739030400000,
  "completed_at"    : 0,
  "expires_at"      : 1739635200000,
  "download_count"  : 0
}
```

**Type_Safe class:**
```python
class Schema__App__Send__Transfer(Type_Safe):
    transfer_id     : Transfer_Id    = None
    status          : str            = 'pending'
    file_size_bytes : int            = 0
    content_type_hint: str           = ''
    token_id        : str            = ''
    created_at      : int            = 0
    completed_at    : int            = 0
    expires_at      : int            = 0
    download_count  : int            = 0
```

**Status values:** `pending` → `completed` → `expired` | `deleted`

**Fields deliberately NOT stored:**
- File name (never sent to server)
- File content (only ciphertext in payload.enc)
- Decryption key (never leaves the browser)

### 2.2 Event File Schema

Each event is a separate JSON file in the `events/` folder. Filename format: `{timestamp}__{event_type}.json`

```json
{
  "event_id"    : "e1a2b3c4d5e6",
  "event_type"  : "downloaded",
  "timestamp"   : 1739030400000,
  "ip_hash"     : "sha256:a1b2c3...",
  "user_agent_normalised": "Chrome/Windows",
  "country"     : "GB",
  "region"      : "England"
}
```

**Type_Safe class:**
```python
class Schema__App__Send__Event(Type_Safe):
    event_id              : str = ''
    event_type            : str = ''
    timestamp             : int = 0
    ip_hash               : str = ''
    user_agent_normalised : str = ''
    country               : str = ''
    region                : str = ''
```

**Event types:** `created`, `upload_started`, `upload_completed`, `downloaded`, `expired`, `deleted`

**Privacy note:** IP addresses are stored as one-way hashes (SHA-256 with rotating daily salt — see IP privacy research brief). User-Agent is normalised to browser family + OS only. Country and region are stored in plaintext (per privacy research — populations large enough to be non-identifying). City, postal code, coordinates, and raw IP are NEVER stored.

### 2.3 Request Log File Schema

Each HTTP request related to a transfer is logged. Filename format: `{timestamp}__{request_id}.json`

```json
{
  "request_id"  : "r1a2b3c4d5e6",
  "timestamp"   : 1739030400000,
  "method"      : "GET",
  "path"        : "/transfers/download/abc123def456",
  "status_code" : 200,
  "duration_ms" : 45,
  "ip_hash"     : "sha256:a1b2c3...",
  "country"     : "GB"
}
```

**Privacy note:** Same anonymisation as events — IP hashed, no raw IP stored, no full User-Agent.

---

## 3. File Layout — Token Data

```
tokens/
├── {token_id}.json
├── {token_id}.json
└── ...
```

### 3.1 Token Schema

```json
{
  "token_id"    : "tok_abc123def456",
  "label"       : "Friend - Alice",
  "status"      : "active",
  "created_at"  : 1739030400000,
  "expires_at"  : 1741622400000,
  "revoked_at"  : 0,
  "usage_count" : 7,
  "last_used_at": 1739116800000
}
```

**Type_Safe class:**
```python
class Schema__App__Send__Token(Type_Safe):
    token_id    : str = ''
    label       : str = ''
    status      : str = 'active'
    created_at  : int = 0
    expires_at  : int = 0
    revoked_at  : int = 0
    usage_count : int = 0
    last_used_at: int = 0
```

**Status values:** `active` → `revoked` | `expired`

---

## 4. File Layout — Admin Data

```
admin/
├── logs/                              Admin action log
│   ├── {timestamp}__{action}.json     One file per admin action
│   └── ...
└── stats/                             Cached aggregate stats
    └── latest.json                    Most recent stats snapshot
```

### 4.1 Stats Schema

```json
{
  "generated_at"        : 1739030400000,
  "active_tokens"       : 5,
  "revoked_tokens"      : 1,
  "total_transfers"     : 42,
  "transfers_pending"   : 1,
  "transfers_completed" : 38,
  "transfers_expired"   : 3,
  "total_bytes_uploaded": 284000000
}
```

---

## 5. Complete Storage Tree

```
(Memory-FS root)/
├── transfers/
│   └── {transfer_id}/
│       ├── meta.json
│       ├── payload.enc
│       ├── events/
│       │   └── {timestamp}__{event_type}.json
│       └── requests/
│           └── {timestamp}__{request_id}.json
├── tokens/
│   └── {token_id}.json
└── admin/
    ├── logs/
    │   └── {timestamp}__{action}.json
    └── stats/
        └── latest.json
```

---

## 6. Transparency Object

Returned in API responses to show users what was captured. This data is derived from the request at response time — the raw values (IP, full User-Agent) are shown to the user but NOT stored on disk.

```json
{
  "your_ip"         : "203.0.113.42",
  "timestamp"       : 1739030400000,
  "user_agent"      : "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
  "country"         : "United Kingdom",
  "region"          : "England",
  "stored_fields"   : ["ip_hash", "timestamp", "country", "region", "user_agent_normalised", "file_size"],
  "not_stored"      : ["raw_ip", "full_user_agent", "file_name", "file_content", "decryption_key"]
}
```

**Pattern: Show live, store anonymised.** The user sees their real IP in the transparency panel (derived from the request). The server stores only a one-way hash.

---

## 7. ID Formats

| ID Type | Format | Example | Generation |
|---------|--------|---------|------------|
| Transfer ID | 12-char alphanumeric | `abc123def456` | `Transfer_Id.new()` |
| Token ID | `tok_` + 12-char | `tok_abc123def456` | `Token_Id.new()` |
| Event ID | 12-char alphanumeric | `e1a2b3c4d5e6` | Obj_Id pattern |
| Request ID | 12-char alphanumeric | `r1a2b3c4d5e6` | Obj_Id pattern |

All IDs are cryptographically random. Transfer_Id supports empty values (unlike Obj_Id) and has a `.new()` class method.

---

## 8. Timestamps

All timestamps are **integers** (milliseconds since epoch UTC), using:

```python
from osbot_utils.type_safe.primitives.domains.identifiers.safe_int.Timestamp_Now import Timestamp_Now
```

No ISO 8601 strings. No timezone conversions on the server. Clients convert to local time for display.
