# Research Summary: PKI & LLM Integration for SG/Send

**Version:** v0.4.17
**Date:** 2026-02-20
**Role:** Architect
**Team:** Explorer

---

## Research Scope

Six research streams were completed to evaluate how SG/Send can add public-key infrastructure and LLM integration while preserving its zero-knowledge encryption model:

1. **Web Crypto API capabilities** — key generation, ECDH, storage options
2. **Browser PKI landscape** — libraries, extensions, native support
3. **FastAPI mTLS approaches** — client certificate authentication for admin
4. **LLM integration paths** — MCP, Claude Skills, GPT Actions, CLI
5. **"Send the private key" mode** — security trade-offs of key-in-URL
6. **Existing codebase review** — integration points, schema patterns

---

## Key Findings

### 1. Browser PKI Is Ready

The Web Crypto API provides everything needed for hybrid encryption:

- **ECDH P-256** key agreement — universally supported (>97% browsers)
- **Key storage via IndexedDB** — private keys marked `extractable: false` cannot be exported even by JavaScript
- **JWK format** for key exchange — standard, JSON-based, easy to transmit
- **No external libraries needed** — all operations available natively

The recommended approach is **hybrid encryption**: ECDH for key agreement, AES-256-GCM for file encryption. This enables recipient-addressed encryption ("send to Alice") while preserving zero-knowledge.

### 2. CLI Tool Is the Universal LLM Integration Path

Four LLM integration approaches were evaluated:

| Path | Works? | Zero-Knowledge? | LLM Support |
|------|--------|-----------------|-------------|
| **CLI Tool** | Yes | Yes | Universal |
| **MCP Server** | Yes | Yes | Claude, OpenAI, Gemini, Cursor |
| Claude Skills | Partially (network restricted) | Partial | Claude only |
| GPT Actions | Crypto impossible | **No** | ChatGPT only |

**The CLI tool (`sg_send`) should be built first.** It works with every LLM that has shell access, uses the same `cryptography` library for format-compatible AES-256-GCM, and the same code powers the MCP server.

**GPT Actions are rejected** — they cannot perform client-side encryption, which would require sending plaintext to the server.

### 3. mTLS Requires Infrastructure Changes for Lambda

AWS Lambda Function URLs don't support mTLS natively. Three alternatives exist:

- **API Gateway mTLS** — viable but adds infrastructure cost and complexity
- **Signed request authentication** — application-level crypto proof, works on Lambda (recommended for Explorer)
- **True mTLS** — possible on EC2/container deployments (Villager territory)

The recommended path is **signed requests first** (ECDSA P-256), with true mTLS when deploying to containers.

### 4. The "Send the Private Key" Model Is Already the Current Model

SG/Send's current design puts the AES key in the URL fragment (`#transfer_id/key`). The URL fragment is never sent to the server (per RFC 3986), so this is secure in transit. The trade-off:

- **Pro:** Single-link sharing — recipient clicks one URL, decryption is automatic
- **Pro:** No key management infrastructure needed
- **Con:** Anyone with the URL can decrypt (the URL *is* the secret)
- **Con:** URL can be leaked in browser history, screenshots, messaging previews

This model is appropriate for the current use case (ad-hoc file sharing). The hybrid encryption model (Phase B) provides a stronger alternative for cases where recipient identity matters.

### 5. Trust Model Shift for LLM Integration

When an LLM encrypts a file on behalf of the user, the trust boundary moves from "browser" to "user's machine." The LLM has already seen the plaintext (the user shared it). The critical property to preserve is: **the SG/Send server never sees plaintext**. Both CLI and MCP maintain this property.

---

## Recommended Implementation Order

### Immediate (Explorer)

| Priority | Work Item | Plan Document |
|----------|-----------|---------------|
| 1 | CLI tool (`sg_send`) — crypto module, upload/download, PyPI | [LLM Integration Plan](v0.4.17__implementation-plan__llm-integration-cli-mcp.md) |
| 2 | MCP server — FastMCP wrapper around CLI | [LLM Integration Plan](v0.4.17__implementation-plan__llm-integration-cli-mcp.md) |
| 3 | Key registration API — `/api/keys` endpoints | [Browser PKI Plan](v0.4.17__implementation-plan__browser-pki-key-management.md) |

### Near-Term (Explorer)

| Priority | Work Item | Plan Document |
|----------|-----------|---------------|
| 4 | Hybrid encryption UI — upload with recipient code | [Browser PKI Plan](v0.4.17__implementation-plan__browser-pki-key-management.md) |
| 5 | Hybrid decryption UI — download with IndexedDB key | [Browser PKI Plan](v0.4.17__implementation-plan__browser-pki-key-management.md) |
| 6 | Single-step upload API — `/api/upload` | [LLM Integration Plan](v0.4.17__implementation-plan__llm-integration-cli-mcp.md) |

### Future (Explorer → Villager Handoff)

| Priority | Work Item | Plan Document |
|----------|-----------|---------------|
| 7 | Signed request auth for admin | [Admin PKI Plan](v0.4.17__implementation-plan__admin-pki-mtls.md) |
| 8 | True mTLS for container deployments | [Admin PKI Plan](v0.4.17__implementation-plan__admin-pki-mtls.md) |
| 9 | Key recovery / multi-device sync | [Browser PKI Plan](v0.4.17__implementation-plan__browser-pki-key-management.md) |

---

## Architecture Decisions Made

| Decision | Rationale |
|----------|-----------|
| ECDH P-256 over RSA for browser PKI | Smaller keys (65 vs 294+ bytes), faster, modern standard, universal browser support |
| CLI first, MCP second | CLI works with all LLMs immediately; MCP wraps the same code |
| Reject GPT Actions | Cannot encrypt — breaks zero-knowledge |
| Signed requests over mTLS for Lambda | Lambda doesn't support mTLS; signed requests provide crypto proof without infra changes |
| Per-transfer ephemeral keys | Forward secrecy; compromise of one transfer doesn't affect others |
| IndexedDB with extractable:false | Browser-enforced private key protection; even XSS cannot export the key |

---

## Dependencies

| Dependency | Used By | Version |
|------------|---------|---------|
| `cryptography` (Python) | CLI tool, MCP server | Latest stable |
| `httpx` (Python) | CLI tool, MCP server | Latest stable |
| `mcp` / `fastmcp` (Python) | MCP server | Latest stable |
| Web Crypto API (browser) | Browser PKI | Built-in (no version) |

All dependencies are well-maintained, widely used, and have no known security issues.

---

## Open Questions (Consolidated)

1. ~~**CLI package name:**~~ Decided: `sg_send`
2. **Short code format for keys:** alphanumeric (`abc123`) or words (`blue-tiger-7`)?
3. **Key expiry policy:** 90 days, 1 year, or configurable?
4. **Priority order:** CLI/MCP first or browser PKI first?
5. **Admin PKI timing:** Before or after LLM integration?
6. **Single-step upload path:** `/api/upload` or extend `/transfers/create`?
