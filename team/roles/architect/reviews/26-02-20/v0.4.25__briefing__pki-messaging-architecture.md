# v0.4.25 â€” Architecture Briefing: PKI Messaging System

**Version:** v0.4.25
**Date:** 2026-02-20
**Role:** Architect
**Team:** Explorer
**Status:** LIVE â€” deployed to production admin console

---

## Executive Summary

The PKI Messaging system is a fully client-side cryptographic communication layer built as a single Web Component (`<pki-manager>`). It provides **confidentiality** (hybrid encryption) and **sender authentication** (digital signatures) with zero server involvement. The server serves the static HTML/JS; every cryptographic operation happens in the browser.

---

## System Context

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BROWSER (Secure Context)                     â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  <pki-manager> Web Component                  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Key Store   â”‚  â”‚  Contact     â”‚  â”‚   Crypto Engine     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (IndexedDB) â”‚  â”‚  Store       â”‚  â”‚   (Web Crypto API)  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚             â”‚  â”‚  (IndexedDB) â”‚  â”‚                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  RSA-OAEP   â”‚  â”‚  RSA-OAEP   â”‚  â”‚  RSA-OAEP 4096     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ECDSA P256 â”‚  â”‚  ECDSA P256 â”‚  â”‚  AES-256-GCM       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  (private)  â”‚  â”‚  (public)   â”‚  â”‚  ECDSA P-256       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                          â–²
          â”‚  Serves static HTML/JS only              â”‚
          â–¼                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SG/Send Server     â”‚                  â”‚   Out-of-Band        â”‚
â”‚   (Lambda / Admin)   â”‚                  â”‚   Key Exchange       â”‚
â”‚                      â”‚                  â”‚   (copy-paste,       â”‚
â”‚   NO crypto ops      â”‚                  â”‚    Slack, email)     â”‚
â”‚   NO key material    â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   NO plaintext       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key principle:** The server is a dumb file server for this feature. It never sees keys, plaintext, or ciphertext metadata.

---

## Cryptographic Algorithm Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Algorithm Layers                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  CONFIDENTIALITY (hybrid encryption)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  RSA-OAEP 4096-bit   â”‚  â”‚  AES-256-GCM              â”‚ â”‚
â”‚  â”‚  Key encapsulation    â”‚  â”‚  Symmetric encryption     â”‚ â”‚
â”‚  â”‚  Wraps/unwraps AES    â”‚â”€â”€â–¶  Encrypts/decrypts data   â”‚ â”‚
â”‚  â”‚  session key (32 B)   â”‚  â”‚  96-bit IV, auth tag      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  AUTHENTICITY (digital signature)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ECDSA P-256 + SHA-256                               â”‚ â”‚
â”‚  â”‚  Signs ciphertext bytes â†’ proves sender identity     â”‚ â”‚
â”‚  â”‚  64-byte signature                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â”‚  IDENTIFICATION                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SHA-256 fingerprint (truncated to 8 bytes / 16 hex) â”‚ â”‚
â”‚  â”‚  Format: sha256:a1b2c3d4e5f6g7h8                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Generation Flow

When the user clicks **"+ Generate"** in the My Keys section:

```
User clicks "+ Generate"
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Generate Modal     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ Label: [____]  â”‚ â”‚
â”‚   â”‚ â—‹ RSA-OAEP 4096â”‚ â”‚  â—€â”€â”€ default
â”‚   â”‚ â—‹ ECDH P-256   â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (RSA-OAEP selected)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Generate RSA-OAEP 4096-bit encryption key pair         â”‚
â”‚                                                                  â”‚
â”‚  crypto.subtle.generateKey({                                     â”‚
â”‚    name: 'RSA-OAEP', modulusLength: 4096,                       â”‚
â”‚    publicExponent: [1,0,1], hash: 'SHA-256'                      â”‚
â”‚  }, extractable: false, ['encrypt','decrypt'])                   â”‚
â”‚                                           â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  publicKey      â”‚    â”‚  privateKey      â”‚                      â”‚
â”‚  â”‚  (extractable)  â”‚    â”‚  (NON-extract.)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  exportKey('spki') â”€â”€â–¶ PEM string                               â”‚
â”‚  digest('SHA-256')  â”€â”€â–¶ sha256:a1b2c3d4...  (fingerprint)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Generate ECDSA P-256 signing key pair                   â”‚
â”‚                                                                  â”‚
â”‚  crypto.subtle.generateKey({                                     â”‚
â”‚    name: 'ECDSA', namedCurve: 'P-256'                            â”‚
â”‚  }, extractable: false, ['sign','verify'])                       â”‚
â”‚                                           â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  signingPublic  â”‚    â”‚  signingPrivate  â”‚                      â”‚
â”‚  â”‚  (extractable)  â”‚    â”‚  (NON-extract.)  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚          â”‚                                                       â”‚
â”‚          â–¼                                                       â”‚
â”‚  exportKey('spki') â”€â”€â–¶ PEM string                               â”‚
â”‚  digest('SHA-256')  â”€â”€â–¶ sha256:x9y8z7w6...  (signing fp)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Store in IndexedDB                                      â”‚
â”‚                                                                  â”‚
â”‚  sg-send-pki / keys / {                                          â”‚
â”‚    label, created, algorithm: 'RSA-OAEP', keySize: 4096,        â”‚
â”‚    publicKey, privateKey,          â—€â”€â”€ CryptoKey objects          â”‚
â”‚    publicKeyPEM, publicKeyFingerprint,                           â”‚
â”‚    signingKey, signingPublicKey,   â—€â”€â”€ CryptoKey objects          â”‚
â”‚    signingPublicKeyPEM, signingFingerprint                       â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  UI refreshes â”€â”€â–¶ Key card appears in "My Keys"
```

**Private keys are non-extractable.** Once generated, not even JavaScript can read the raw key material â€” the Web Crypto API enforces this at the browser engine level.

---

## Public Key Exchange Format

When the user clicks **"Copy Public Key"**, the component builds a JSON bundle:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Key Bundle (JSON)                    â”‚
â”‚                                                  â”‚
â”‚  {                                               â”‚
â”‚    "v": 1,                                       â”‚
â”‚    "encrypt": "-----BEGIN PUBLIC KEY-----\n..."  â”‚  â—€â”€â”€ RSA-OAEP 4096 SPKI
â”‚    "sign":    "-----BEGIN PUBLIC KEY-----\n..."  â”‚  â—€â”€â”€ ECDSA P-256 SPKI
â”‚  }                                               â”‚
â”‚                                                  â”‚
â”‚  Clipboard â”€â”€â–¶ Paste to recipient                â”‚
â”‚                (Slack, email, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

On import, the component auto-detects the format:

```
Raw text starts with '{'  â”€â”€â–¶  Parse as JSON bundle
                                â”œâ”€â”€ bundle.encrypt â”€â”€â–¶ import as RSA-OAEP
                                â””â”€â”€ bundle.sign    â”€â”€â–¶ import as ECDSA (if present)

Raw text starts with '---' â”€â”€â–¶  Legacy PEM
                                â””â”€â”€ try RSA-OAEP, fallback to ECDH
```

---

## Encrypt & Sign Workflow

This maps to the **"Encrypt & Sign"** panel in the UI (left column of the Messages grid):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI: Encrypt & Sign Panel                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ To: [dc-in-localhost  â–¼] â”‚  â—€â”€â”€ recipient's public key       â”‚
â”‚  â”‚ From: [dc-in-prod     â–¼] â”‚  â—€â”€â”€ my key pair (for signing)    â”‚
â”‚  â”‚ Message: [Hello!______]  â”‚                                   â”‚
â”‚  â”‚ [Encrypt, Sign & Copy]   â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Hybrid Encrypt (for recipient's eyes only)              â”‚
â”‚                                                                  â”‚
â”‚  "Hello!"                                                        â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Generate random AES-256-GCM key (ephemeral, per msg)   â”‚    â”‚
â”‚  â”‚  Generate random 96-bit IV                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â–¼                           â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  AES-GCM encrypt â”‚    â”‚  RSA-OAEP wrap AES key â”‚             â”‚
â”‚  â”‚  plaintext â”€â”€â–¶ c â”‚    â”‚  rawKey â”€â”€â–¶ w          â”‚             â”‚
â”‚  â”‚  (+ auth tag)    â”‚    â”‚  (512 bytes output)    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                           â”‚                            â”‚
â”‚         â–¼                           â–¼                            â”‚
â”‚     payload.c                   payload.w                        â”‚
â”‚     (base64)                    (base64)                         â”‚
â”‚                                                                  â”‚
â”‚     payload.i = base64(IV)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Sign (prove sender identity)                            â”‚
â”‚                                                                  â”‚
â”‚  IF sender key has ECDSA signing capability:                     â”‚
â”‚                                                                  â”‚
â”‚     raw bytes of payload.c                                       â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚     crypto.subtle.sign(                                          â”‚
â”‚       { name: 'ECDSA', hash: 'SHA-256' },                       â”‚
â”‚       senderKey.signingKey,    â—€â”€â”€ my ECDSA private key          â”‚
â”‚       ciphertextBytes                                            â”‚
â”‚     )                                                            â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚     payload.s = base64(signature)    (64 bytes)                  â”‚
â”‚     payload.f = "sha256:..."         (sender's signing fp)       â”‚
â”‚                                                                  â”‚
â”‚  ELSE: payload sent without s and f fields                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Encode & Copy                                           â”‚
â”‚                                                                  â”‚
â”‚  JSON.stringify(payload) â”€â”€â–¶ btoa() â”€â”€â–¶ clipboard                â”‚
â”‚                                                                  â”‚
â”‚  Final payload (base64-encoded JSON):                            â”‚
â”‚                                                                  â”‚
â”‚  eyJ2IjoyLCJ3IjoiTUlJQklqQU5C...  (single base64 string)       â”‚
â”‚                                                                  â”‚
â”‚  User copies this and sends via any channel                      â”‚
â”‚  (Slack, email, SMS â€” channel security doesn't matter)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decrypt & Verify Workflow

This maps to the **"Decrypt & Verify"** panel (right column of the Messages grid):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI: Decrypt & Verify Panel                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ With: [dc-in-prod        â–¼]  â”‚  â—€â”€â”€ my key pair              â”‚
â”‚  â”‚ Payload: [eyJ2IjoyLC...]     â”‚  â—€â”€â”€ paste from sender        â”‚
â”‚  â”‚ [Decrypt & Verify]           â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Decode payload                                          â”‚
â”‚                                                                  â”‚
â”‚  atob(base64string) â”€â”€â–¶ JSON.parse() â”€â”€â–¶ {v, w, i, c, s?, f?}   â”‚
â”‚                                                                  â”‚
â”‚  Check: v === 1 or v === 2 (else throw)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Hybrid Decrypt                                          â”‚
â”‚                                                                  â”‚
â”‚  payload.w (wrapped AES key)                                     â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  RSA-OAEP decrypt with my private key â”€â”€â–¶ raw AES key (32 B)    â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  Import as AES-GCM key                                           â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  AES-GCM decrypt (payload.c, payload.i as IV)                    â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  "Hello!"  â—€â”€â”€ plaintext recovered                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Verify Signature                                        â”‚
â”‚                                                                  â”‚
â”‚  CASE A: payload.s AND payload.f present                         â”‚
â”‚    â”‚                                                             â”‚
â”‚    â”œâ”€â–¶ Find contact where signingFingerprint === payload.f       â”‚
â”‚    â”‚                                                             â”‚
â”‚    â”œâ”€â–¶ FOUND + has signingPublicKey:                             â”‚
â”‚    â”‚     crypto.subtle.verify(ECDSA, contactKey, sig, ciphertext)â”‚
â”‚    â”‚     â”‚                                                       â”‚
â”‚    â”‚     â”œâ”€â–¶ true:  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚     â”‚          â”‚ âœ“ Signed by Alice â€” signature verifiedâ”‚    â”‚
â”‚    â”‚     â”‚          â”‚ (green banner)                        â”‚    â”‚
â”‚    â”‚     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚    â”‚     â”‚                                                       â”‚
â”‚    â”‚     â””â”€â–¶ false: â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                â”‚ âœ— Signature INVALID â€” may be tampered â”‚    â”‚
â”‚    â”‚                â”‚ (red banner)                          â”‚    â”‚
â”‚    â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚    â”‚                                                             â”‚
â”‚    â””â”€â–¶ NOT FOUND:                                                â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚ Signed (fp: sha256:...) â€” sender not in contacts   â”‚  â”‚
â”‚          â”‚ (amber banner)                                     â”‚  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  CASE B: payload.s or payload.f absent                           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚ No signature â€” sender's key was created before     â”‚  â”‚
â”‚          â”‚ signing was available. Confidentiality is intact.  â”‚  â”‚
â”‚          â”‚ (blue-grey banner)                                 â”‚  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  NOTE: Plaintext is always shown. Verification is additive       â”‚
â”‚  trust information, NOT a decryption gate.                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## End-to-End Message Exchange (Two Parties)

```
         ALICE (Browser A)                      BOB (Browser B)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    1. Generate key pair                   1. Generate key pair
       RSA-OAEP 4096 + ECDSA P-256           RSA-OAEP 4096 + ECDSA P-256
              â”‚                                       â”‚
              â–¼                                       â–¼
    2. Copy public key bundle              2. Copy public key bundle
       { encrypt: PEM, sign: PEM }            { encrypt: PEM, sign: PEM }
              â”‚                                       â”‚
              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Out-of-band   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚  exchange      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (paste keys)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
              â–¼                                       â–¼
    3. Import Bob's key as contact         3. Import Alice's key as contact
              â”‚                                       â”‚
              â–¼                                       â–¼
    4. Encrypt message TO Bob              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       Sign message FROM Alice             â”‚  (waiting for message)  â”‚
              â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼                                       â”‚
    5. Copy encrypted payload                         â”‚
       (single base64 string)                         â”‚
              â”‚                                       â”‚
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
              â””â”€â”€â”€â”€â–¶â”‚  Any channel        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  (Slack, email, etc) â”‚           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                                                      â–¼
                                           6. Paste payload
                                              Decrypt with Bob's private key
                                              Verify Alice's signature
                                                      â”‚
                                                      â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ "Hello from      â”‚
                                              â”‚  Alice!"         â”‚
                                              â”‚                  â”‚
                                              â”‚ âœ“ Signed by      â”‚
                                              â”‚   Alice â€”        â”‚
                                              â”‚   verified       â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## UI Layout Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SG/Send Â· PKI                              [Back to Admin]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                   â”‚
â”‚  MY KEYS            [+Gen]  â”‚  CONTACTS              [+Import]  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”‘ dc-in-prod          â”‚ â”‚  â”‚ ğŸ‘¤ dc-in-localhost           â”‚ â”‚
â”‚  â”‚ Created: 20 Feb 2026   â”‚ â”‚  â”‚ Imported: 20 Feb 2026       â”‚ â”‚
â”‚  â”‚ RSA-OAEP 4096-bit      â”‚ â”‚  â”‚ sha256:b4e7f2a1...          â”‚ â”‚
â”‚  â”‚ sha256:a1b2c3d4...     â”‚ â”‚  â”‚ Signing: [verifiable]       â”‚ â”‚
â”‚  â”‚ Private: [non-extract.] â”‚ â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ Signing: [ECDSA P-256] â”‚ â”‚  â”‚ [View Key]  [Delete]        â”‚ â”‚
â”‚  â”‚                        â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ [Copy Public Key] [Del]â”‚ â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                   â”‚
â”‚                             â”‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                   â”‚
â”‚  ENCRYPT & SIGN             â”‚  DECRYPT & VERIFY                 â”‚
â”‚                             â”‚                                   â”‚
â”‚  To:   [dc-in-localhost â–¼]  â”‚  With: [dc-in-prod          â–¼]   â”‚
â”‚  From: [dc-in-prod      â–¼]  â”‚  Payload: [paste here...]        â”‚
â”‚  Msg:  [Type here...]       â”‚                                   â”‚
â”‚                             â”‚  [Decrypt & Verify]               â”‚
â”‚  [Encrypt, Sign & Copy]    â”‚                                   â”‚
â”‚                             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ Hello from Alice!            â”‚ â”‚
â”‚  â”‚ eyJ2IjoyLCJ3Ijoi...   â”‚ â”‚  â”‚                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ âœ“ Signed by dc-in-localhost  â”‚ â”‚
â”‚                             â”‚  â”‚   â€” signature verified        â”‚ â”‚
â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TEST                                                           â”‚
â”‚  Encrypt/Decrypt round-trip test                                â”‚
â”‚  Key pair: [dc-in-prod â–¼]   Plaintext: [Hello, test...]        â”‚
â”‚  [Encrypt with Public Key, then Decrypt with Private Key]       â”‚
â”‚  Ciphertext: MIIBIjANB...   Result: âœ“ "Hello, test..." OK      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Crypto [ok]  IndexedDB [ok] 1 key, 1 contact                  â”‚
â”‚  Private keys [non-extractable]  Origin: https://send.sgraph.ai â”‚
â”‚  âš  Keys stored in this browser only. Clearing = permanent loss  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## IndexedDB Data Model

```
Database: sg-send-pki  (version 1)
â”‚
â”œâ”€â”€ Object Store: keys   (keyPath: 'id', autoIncrement: true)
â”‚   â”‚
â”‚   â””â”€â”€ Record {
â”‚         id:                    number   (auto)
â”‚         label:                 string   "dc-in-prod"
â”‚         created:               string   "2026-02-20T14:32:00Z"
â”‚         algorithm:             string   "RSA-OAEP"
â”‚         keySize:               number   4096
â”‚         publicKey:             CryptoKey (encrypt)
â”‚         privateKey:            CryptoKey (decrypt, NON-EXTRACTABLE)
â”‚         publicKeyPEM:          string   "-----BEGIN PUBLIC KEY-----\n..."
â”‚         publicKeyFingerprint:  string   "sha256:a1b2c3d4e5f6g7h8"
â”‚         signingKey:            CryptoKey (sign, NON-EXTRACTABLE) | null
â”‚         signingPublicKey:      CryptoKey (verify) | null
â”‚         signingPublicKeyPEM:   string   | null
â”‚         signingFingerprint:    string   | null
â”‚       }
â”‚
â””â”€â”€ Object Store: contacts   (keyPath: 'id', autoIncrement: true)
    â”‚
    â””â”€â”€ Record {
          id:                    number   (auto)
          label:                 string   "dc-in-localhost"
          imported:              string   "2026-02-20T14:35:00Z"
          algorithm:             string   "RSA-OAEP"
          publicKey:             CryptoKey (encrypt)
          publicKeyPEM:          string   "-----BEGIN PUBLIC KEY-----\n..."
          publicKeyFingerprint:  string   "sha256:b4e7f2a1c8d9e0f3"
          signingPublicKey:      CryptoKey (verify) | null
          signingPublicKeyPEM:   string   | null
          signingFingerprint:    string   | null
          source:                string   "manual"
        }
```

---

## Payload Wire Format

```
Payload v2 (current â€” signed):

  btoa(JSON.stringify({
    "v": 2,                          â—€â”€â”€ format version
    "w": "base64(RSA-OAEP(AES-key))", â—€â”€â”€ 512 bytes â†’ ~684 base64 chars
    "i": "base64(IV)",                â—€â”€â”€ 12 bytes â†’ 16 base64 chars
    "c": "base64(AES-GCM(plaintext))", â—€â”€â”€ variable length
    "s": "base64(ECDSA-sig)",         â—€â”€â”€ 64 bytes â†’ ~88 base64 chars
    "f": "sha256:a1b2c3d4e5f6g7h8"   â—€â”€â”€ sender's signing fingerprint
  }))

  Final output: single base64 string, ~1.5KB+ overhead for a short message


Payload v1 (legacy â€” unsigned, still accepted on decrypt):

  btoa(JSON.stringify({
    "v": 1,
    "w": "...",
    "i": "...",
    "c": "..."
  }))

  No "s" or "f" fields.
```

---

## Security Properties

| Property | Status | Mechanism |
|----------|--------|-----------|
| **Confidentiality** | Yes | RSA-OAEP 4096 + AES-256-GCM hybrid |
| **Integrity** | Yes | AES-GCM authentication tag (implicit) |
| **Sender authentication** | Yes (v2) | ECDSA P-256 signature over ciphertext |
| **Non-repudiation** | Partial | Signature proves sender had the private key; no timestamping |
| **Forward secrecy** | No | Same RSA key pair used for all messages |
| **Key non-extractability** | Yes | Browser-enforced via Web Crypto API |
| **Server zero-knowledge** | Yes | All crypto is client-side; server serves static files only |

### What ECDSA Signs

The signature covers the **ciphertext bytes** (`payload.c` decoded from base64), not the full payload JSON. This means:
- Ciphertext integrity is cryptographically proven by the signature
- The AES-GCM auth tag separately ensures decryption will fail if any ciphertext byte is modified
- The IV (`payload.i`) and wrapped key (`payload.w`) are not directly signed, but tampering with either will cause AES-GCM decryption to fail

### Trust Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Trust Assumptions                        â”‚
â”‚                                                              â”‚
â”‚  1. Key exchange is trusted (manual copy-paste)              â”‚
â”‚     â””â”€â”€ "I pasted the key, so I know who it came from"       â”‚
â”‚                                                              â”‚
â”‚  2. Browser is trusted (runs crypto operations)              â”‚
â”‚     â””â”€â”€ Web Crypto API enforces non-extractability           â”‚
â”‚                                                              â”‚
â”‚  3. No trusted third party / CA                              â”‚
â”‚     â””â”€â”€ Direct key exchange, not PKI hierarchy               â”‚
â”‚                                                              â”‚
â”‚  4. No key revocation                                        â”‚
â”‚     â””â”€â”€ Delete contact = local only; no broadcast            â”‚
â”‚                                                              â”‚
â”‚  5. No key expiry                                            â”‚
â”‚     â””â”€â”€ Keys persist until browser data is cleared           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Backwards Compatibility

```
                    GENERATE                      IMPORT
                    â•â•â•â•â•â•â•â•                      â•â•â•â•â•â•

  Old key (pre-signing)              JSON bundle: { v:1, encrypt: PEM }
  â”œâ”€â”€ signingKey: null               â”œâ”€â”€ signingPublicKey: null
  â”œâ”€â”€ signingFingerprint: null       â””â”€â”€ Badge: "no signing key"
  â””â”€â”€ Badge: "none" (amber)
                                     Legacy bare PEM:
  New key (with signing)             â”œâ”€â”€ Detected by: doesn't start with '{'
  â”œâ”€â”€ signingKey: CryptoKey          â”œâ”€â”€ Try RSA-OAEP, fallback to ECDH
  â”œâ”€â”€ signingFingerprint: sha256:... â””â”€â”€ signingPublicKey: null
  â””â”€â”€ Badge: "ECDSA P-256" (green)

                    ENCRYPT                       DECRYPT
                    â•â•â•â•â•â•â•                       â•â•â•â•â•â•â•

  Sender has signing key:            Payload has s + f:
  â””â”€â”€ payload.s + payload.f added    â””â”€â”€ Verify against contacts store

  Sender has NO signing key:         Payload missing s/f:
  â””â”€â”€ payload sent without s/f       â””â”€â”€ "No signature â€” sender's key was
  â””â”€â”€ Info banner on encrypt side        created before signing was available"
```

---

## Component File Reference

| File | Purpose |
|------|---------|
| `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.2/pki.html` | Host page â€” loads component + admin CSS |
| `sgraph_ai_app_send__ui__admin/v0/v0.1/v0.1.2/components/pki-manager/pki-manager.js` | Full component â€” 1821 lines, zero dependencies |

---

## Cross-References

| Document | Location |
|----------|----------|
| Librarian catalogue | [`v0.4.25__catalogue__pki-milestone-and-linkedin-post.md`](../../librarian/reviews/26-02-20/v0.4.25__catalogue__pki-milestone-and-linkedin-post.md) |
| Historian record | [`v0.4.25__milestone__first-pki-message-exchange.md`](../../historian/reviews/26-02-20/v0.4.25__milestone__first-pki-message-exchange.md) |
| Journalist article | [`v0.4.25__article__pki-milestone.md`](../../journalist/reviews/26-02-20/v0.4.25__article__pki-milestone.md) |
| Original PKI implementation plan | [`v0.4.17__implementation-plan__browser-pki-key-management.md`](v0.4.17__implementation-plan__browser-pki-key-management.md) |
