# v0.3.6 Observability Pipeline — Implementation Proposal

**Date:** 15 February 2026
**Version:** v0.3.6
**Responding to:** `team/humans/dinis_cruz/briefs/02/15/aws-setup/v0.3.6__aws-observability-brief.md`
**Roles:** Architect (lead), Dev, DevOps — with Librarian and Historian input

---

## Executive Summary

The brief is well-structured and maps cleanly onto our existing patterns. The infrastructure is already live (per the setup guide). This proposal identifies **11 corrections** to align the brief with our Type_Safe conventions, **3 architectural refinements**, and a concrete implementation plan with our "no mocks" testing strategy.

**Estimated scope:** 9 new files (schemas), 4 new files (services + collectors), 1 new route file, 2 modified files. ~1,200 lines of application code, ~800 lines of tests.

---

## 1. Librarian & Historian: Type_Safe Compliance Review

The brief is mostly excellent on Type_Safe usage but has specific gaps that must be corrected before implementation. The Librarian has cross-referenced every schema against the osbot-utils primitive catalogue (100+ types available).

### 1.1 Corrections Required

| # | Brief Says | Should Be | Reason |
|---|-----------|-----------|--------|
| C1 | `boto3_client : object = None` | Remove from class attributes entirely | `object` is not a valid Type_Safe attribute. Use lazy init pattern (see Section 3.1) |
| C2 | `Safe_Str__AWS__Region` | `Safe_Str__Id` (or create custom) | `Safe_Str__AWS__Region` does not exist in osbot-utils. `Safe_Str__Id` accepts `eu-west-2` format. Create a custom type if strict validation needed |
| C3 | `List[Safe_Str__Id]` for `lambda_function_names` | `list` attribute + runtime validation | Type_Safe supports `List[Safe_Str__Id]` but only via `Type_Safe__List`. Use `list` for now, validate in `setup()` |
| C4 | `List[Safe_UInt]` for `timestamps` | `list` attribute + `@type_safe` on accessors | Same — typed lists work in Type_Safe but complex nested schemas should use `list` attributes with validated accessors |
| C5 | `List[Safe_Float]` for `values` | `list` attribute + `@type_safe` on accessors | Same pattern |
| C6 | `List[Schema__Metric__Dimension]` | `list` attribute | Typed lists of Type_Safe objects work but keep it simple |
| C7 | `List[Schema__Health__Status]` | `list` attribute | Same |
| C8 | `thresholds : Schema__Thresholds__Config = None` | Must have default instance or be required | Type_Safe doesn't support `= None` for Type_Safe subclass attributes — use factory in `setup()` |
| C9 | `cloudwatch_client : CloudWatch__Client = None` | Same — factory in `setup()` | Same reason as C8 |
| C10 | `data{}` in `Schema__Aggregation__Window` | `data : dict` or proper Type_Safe sub-schema | Raw `{}` is ambiguous — use `dict` attribute (existing pattern in codebase) |
| C11 | Brief step 2 says "unit test with **mocked** boto3 client" | Use a real boto3 stub class (Type_Safe) | Project rule: **no mocks, no patches**. Create `CloudWatch__Client__Stub(Type_Safe)` with canned responses |

### 1.2 Available Typed Primitives (confirmed in osbot-utils)

These primitives from the brief **do exist** and should be used:

| Primitive | Available | Notes |
|-----------|-----------|-------|
| `Safe_UInt` | Yes | Unsigned integers (timestamps, counts, durations) |
| `Safe_Float` | Yes | Float with Decimal arithmetic (metric values) |
| `Safe_Float__Percentage_Exact` | Yes | 0–100 with 2 decimals (error rates, cache hit rate) |
| `Safe_Str__Id` | Yes | Identifiers (function names, distribution IDs, filter IDs) |
| `Safe_Str__Text` | Yes | Text content (up to 4KB — health messages) |
| `Safe_Str__Label` | Yes | Display labels (metric names, namespaces) |
| `Safe_Str__Namespace` | Yes | Dotted namespaces (AWS/Lambda, AWS/S3) |
| `Safe_UInt__FileSize` | Yes | Bytes with `.to_kb()`, `.to_mb()`, `.to_gb()` |
| `Timestamp_Now` | Yes | Millisecond timestamps |
| `Safe_Str__File__Path` | Yes | File paths (for cache storage paths) |
| `@type_safe` decorator | Yes | Method parameter validation — use on all public methods |

### 1.3 Historian: Decision Registration

| ID | Decision | Rationale |
|----|----------|-----------|
| D048 | Adopt CloudWatch metrics pipeline in admin Lambda | Server-side observability, GA replacement |
| D049 | LETS aggregation pattern for analytics | Cascade: 30min → hourly → daily, avoid N+1 reads |
| D050 | boto3 lazy import (not a class attribute) | Lambda runtime provides boto3, avoid cold start penalty |
| D051 | CloudWatch__Client__Stub for tests (not mocks) | Maintains "no mocks, no patches" rule — real Type_Safe class with canned data |
| D052 | HTML/CSS/SVG dashboards (no matplotlib) | Avoid Lambda layer bloat, consistent with IFD approach |
| D053 | CloudFront metrics use separate us-east-1 client | CloudFront publishes metrics only to us-east-1 |

---

## 2. Architect: Schema Design (Corrected)

All schemas follow the existing pattern: `# ═══` header, one import per line, `Type_Safe` base class, typed primitives everywhere.

### 2.1 Schema__Metric__Dimension

```python
class Schema__Metric__Dimension(Type_Safe):              # Single CloudWatch dimension
    name  : Safe_Str__Label                               # Dimension name (e.g., 'FunctionName')
    value : Safe_Str__Id                                  # Dimension value (e.g., 'user-dev')
```

### 2.2 Schema__Metric__Series

```python
class Schema__Metric__Series(Type_Safe):                  # Time-series data from CloudWatch
    metric_name : Safe_Str__Label                         # Metric name (e.g., 'Invocations')
    namespace   : Safe_Str__Namespace                     # AWS namespace (e.g., 'AWS/Lambda')
    dimensions  : list                                    # List of Schema__Metric__Dimension dicts
    unit        : Safe_Str__Label                         # Unit (e.g., 'Count', 'Milliseconds')
    statistic   : Safe_Str__Label                         # Statistic type (e.g., 'Sum', 'Average', 'p95')
    timestamps  : list                                    # List of epoch-second timestamps
    values      : list                                    # List of float values (aligned with timestamps)
```

**Architect note:** `dimensions`, `timestamps`, `values` use `list` rather than `List[Schema__Metric__Dimension]` / `List[Safe_UInt]` / `List[Safe_Float]`. This is pragmatic: CloudWatch returns raw lists, and wrapping each element adds overhead with no safety benefit (the data comes from a trusted AWS API). The `@type_safe` decorator on accessor methods provides the validation boundary instead.

### 2.3 Schema__Lambda__Metrics

```python
class Schema__Lambda__Metrics(Type_Safe):                 # All metrics for one Lambda function
    function_name          : Safe_Str__Id                 # Lambda function name (e.g., 'user-dev')
    invocations            : Schema__Metric__Series       # Total invocations
    errors                 : Schema__Metric__Series       # Total errors
    duration_avg           : Schema__Metric__Series       # Average duration (ms)
    duration_p50           : Schema__Metric__Series       # Median duration
    duration_p95           : Schema__Metric__Series       # 95th percentile
    duration_p99           : Schema__Metric__Series       # 99th percentile
    duration_max           : Schema__Metric__Series       # Maximum duration
    throttles              : Schema__Metric__Series       # Throttle count
    concurrent_executions  : Schema__Metric__Series       # Concurrent execution count
```

**Important:** Each field is a `Schema__Metric__Series` (Type_Safe class), not `= None`. Type_Safe auto-creates default instances for class-typed attributes. This means every `Schema__Lambda__Metrics()` starts with empty but valid `Schema__Metric__Series` objects — no None checks needed.

### 2.4 Schema__CloudFront__Metrics

```python
class Schema__CloudFront__Metrics(Type_Safe):             # CloudFront distribution metrics
    distribution_id  : Safe_Str__Id                       # CloudFront distribution ID
    requests         : Schema__Metric__Series             # Total requests
    bytes_downloaded : Schema__Metric__Series             # Bytes to viewers
    bytes_uploaded   : Schema__Metric__Series             # Bytes from viewers
    error_rate_4xx   : Schema__Metric__Series             # 4xx error rate (%)
    error_rate_5xx   : Schema__Metric__Series             # 5xx error rate (%)
    cache_hit_rate   : Schema__Metric__Series             # Cache hit ratio (%)
```

### 2.5 Schema__S3__Metrics

```python
class Schema__S3__Metrics(Type_Safe):                     # S3 bucket metrics
    bucket_name           : Safe_Str__Id                  # S3 bucket name
    filter_id             : Safe_Str__Id                  # Request metrics filter ID
    get_requests          : Schema__Metric__Series        # GetObject requests
    put_requests          : Schema__Metric__Series        # PutObject requests
    first_byte_latency    : Schema__Metric__Series        # Time to first byte (ms)
    total_request_latency : Schema__Metric__Series        # Total request time (ms)
    errors_4xx            : Schema__Metric__Series        # 4xx errors
    errors_5xx            : Schema__Metric__Series        # 5xx errors
    bytes_downloaded      : Schema__Metric__Series        # Bytes out
    bytes_uploaded        : Schema__Metric__Series        # Bytes in
```

### 2.6 Schema__Health__Status

```python
class Schema__Health__Status(Type_Safe):                  # Health evaluation for one component
    component    : Safe_Str__Label                        # Component name (e.g., 'Lambda: user-dev')
    status       : Safe_Str__Id                           # 'healthy', 'warning', 'critical'
    status_emoji : Safe_Str__Label                        # Visual indicator
    message      : Safe_Str__Text                         # Human-readable description
    metrics      : dict                                   # Key metric values for this evaluation
```

### 2.7 Schema__Thresholds__Config

```python
class Schema__Thresholds__Config(Type_Safe):              # Health evaluation thresholds
    lambda_error_rate_warning   : Safe_Float = 1.0        # % error rate → warning
    lambda_error_rate_critical  : Safe_Float = 5.0        # % error rate → critical
    lambda_duration_p95_warning : Safe_UInt  = 5000       # ms → warning
    s3_error_5xx_threshold      : Safe_UInt  = 0          # Any 5xx → warning
    cloudfront_5xx_rate_warning : Safe_Float = 1.0        # % → warning
    cloudfront_cache_hit_low    : Safe_Float = 50.0       # Below this % → warning
```

### 2.8 Schema__Metrics__Snapshot

```python
class Schema__Metrics__Snapshot(Type_Safe):                # Complete metrics snapshot
    snapshot_time     : Timestamp_Now                      # When snapshot was taken
    region            : Safe_Str__Id                       # AWS region
    lookback_minutes  : Safe_UInt                          # Time range collected
    period_seconds    : Safe_UInt                          # CloudWatch resolution
    cloudfront        : Schema__CloudFront__Metrics        # CloudFront metrics
    lambda_user       : Schema__Lambda__Metrics            # User Lambda metrics
    lambda_admin      : Schema__Lambda__Metrics            # Admin Lambda metrics
    s3_transfers      : Schema__S3__Metrics                # Transfers bucket metrics
    s3_cache          : Schema__S3__Metrics                # Cache bucket metrics
    health_status     : list                               # List of Schema__Health__Status dicts
```

**Architect note:** `lambda_user` and `lambda_admin` are explicit named fields rather than a `list` of `Schema__Lambda__Metrics`. This is clearer — we know exactly which Lambdas exist. If the architecture ever has more than 2 Lambdas, we add named fields (not iterate over a list).

### 2.9 Schema__Aggregation__Window

```python
class Schema__Aggregation__Window(Type_Safe):              # Computed analytics aggregation
    window_label      : Safe_Str__Label                    # '30min', 'hourly', 'daily'
    window_minutes    : Safe_UInt                          # 30, 60, 1440
    time_key          : Safe_Str__Id                       # '2026-02-15T14:00' or '2026-02-15'
    computed_at       : Timestamp_Now                      # When aggregation was computed
    event_count       : Safe_UInt                          # Raw events processed
    total_requests    : Safe_UInt                          # Total HTTP requests
    unique_visitors   : Safe_UInt                          # Distinct ip_hashes
    total_bytes       : Safe_UInt                          # Total content bytes
    avg_duration_ms   : Safe_UInt                          # Average request duration
    requests_by_type  : dict                               # {page_view: N, api_call: N, ...}
    requests_by_status: dict                               # {2xx: N, 3xx: N, 4xx: N, 5xx: N}
    top_paths         : list                               # [{path: str, count: int}, ...] (top 20)
    active_transfers  : Safe_UInt                          # File transfer operations
```

**Librarian note:** `requests_by_type`, `requests_by_status`, and `top_paths` use `dict`/`list` because they are aggregated summary data — not domain entities. This matches the existing `metadata : dict` pattern in `Schema__Token__Create__Request`. Future refinement: replace with `Dict[Safe_Str__Key, Safe_UInt]`.

---

## 3. Architect: Architectural Refinements

### 3.1 boto3 Handling (Correction C1)

The brief puts `boto3_client : object = None` as a class attribute. This violates Type_Safe rules. Instead:

```python
class CloudWatch__Client(Type_Safe):
    region : Safe_Str__Id = 'eu-west-2'                   # Primary region

    def setup(self):
        import boto3                                       # Lazy import — boto3 is in Lambda runtime
        self._boto3_client    = boto3.client('cloudwatch', region_name=str(self.region))
        self._boto3_client_cf = boto3.client('cloudwatch', region_name='us-east-1')  # CloudFront only
        return self
```

Use `self._boto3_client` (underscore prefix) to store the boto3 client outside of Type_Safe's attribute system. Type_Safe ignores underscore-prefixed attributes — they're treated as implementation details.

### 3.2 CloudFront us-east-1 Region Issue (D053)

The brief correctly identifies that CloudFront metrics are **only published to us-east-1**. The proposed solution (separate boto3 client) is correct. The `CloudWatch__Client` creates two internal boto3 clients in `setup()`:

- `self._boto3_client` — for Lambda and S3 metrics (configured region)
- `self._boto3_client_cf` — for CloudFront metrics (always us-east-1)

The `get_cloudfront_metric()` method uses `self._boto3_client_cf` instead of `self._boto3_client`. This is transparent to callers.

### 3.3 Testing Without Mocks (Correction C11)

The brief says "unit test with mocked boto3 client." Our project rule is **no mocks, no patches**. Instead, create a **stub class**:

```python
class CloudWatch__Client__Stub(Type_Safe):                # Test stub with canned CloudWatch data
    region       : Safe_Str__Id = 'eu-west-2'
    sample_data  : dict                                    # Pre-loaded sample responses

    def setup(self):
        return self                                        # No boto3 needed

    def get_metric_data(self, **kwargs):                   # Return canned Schema__Metric__Series
        return self._build_sample_series(kwargs)

    def get_lambda_metric(self, **kwargs):
        return self._build_sample_series(kwargs)

    # ... same interface as CloudWatch__Client
```

The stub is a real Type_Safe class with the same interface. Tests use it via constructor injection:

```python
snapshot = SGraph_Send__Metrics__Snapshot(
    cloudwatch_client = CloudWatch__Client__Stub().setup(),
    send_cache_client = create_send_cache_client(),        # Real in-memory cache
    ...
)
```

This preserves the full stack in-memory pattern. The only thing stubbed is the external AWS API boundary — everything else runs real.

**For live integration tests** (when AWS credentials are available), use the real `CloudWatch__Client` with a guard:

```python
def test__collect_all__live(self):
    if not aws_config.aws_configured():
        pytest.skip('AWS credentials not available')
    # Run against real CloudWatch
```

---

## 4. Dev: Implementation Plan (Corrected Sequence)

### 4.1 File Structure

```
sgraph_ai_app_send/lambda__admin/
├── schemas/
│   ├── Schema__Metric__Dimension.py          # NEW
│   ├── Schema__Metric__Series.py             # NEW
│   ├── Schema__CloudFront__Metrics.py        # NEW
│   ├── Schema__Lambda__Metrics.py            # NEW
│   ├── Schema__S3__Metrics.py                # NEW
│   ├── Schema__Metrics__Snapshot.py          # NEW
│   ├── Schema__Health__Status.py             # NEW
│   ├── Schema__Thresholds__Config.py         # NEW
│   └── Schema__Aggregation__Window.py        # NEW
├── service/
│   ├── CloudWatch__Client.py                 # NEW
│   ├── CloudWatch__Client__Stub.py           # NEW (test support)
│   ├── SGraph_Send__Metrics__Snapshot.py     # NEW
│   ├── Service__Analytics__Aggregator.py     # NEW
│   ├── Dashboard__Generator.py              # NEW
│   ├── Send__Cache__Client.py               # MODIFY (add metrics/agg/costs methods)
│   └── collectors/
│       ├── __init__.py                       # NEW
│       ├── CloudFront__Metrics__Collector.py # NEW
│       ├── Lambda__Metrics__Collector.py     # NEW
│       └── S3__Metrics__Collector.py         # NEW
└── fast_api/
    ├── routes/
    │   └── Routes__Metrics.py               # NEW
    └── Fast_API__SGraph__App__Send__Admin.py # MODIFY (register Routes__Metrics)

tests/unit/lambda__admin/
├── schemas/
│   └── test_Schema__Metrics.py              # NEW (all metric schemas)
├── service/
│   ├── test_CloudWatch__Client.py           # NEW (using Stub)
│   ├── test_SGraph_Send__Metrics__Snapshot.py # NEW
│   ├── test_Service__Analytics__Aggregator.py # NEW
│   └── collectors/
│       ├── test_Lambda__Metrics__Collector.py   # NEW
│       ├── test_S3__Metrics__Collector.py       # NEW
│       └── test_CloudFront__Metrics__Collector.py # NEW
└── fast_api/routes/
    └── test_Routes__Metrics.py              # NEW
```

### 4.2 Implementation Sequence

Each step is a testable, deployable increment:

```
Step 1: Schemas (all 9 files)
├── No dependencies on services
├── Test: instantiate with defaults, verify json() serialisation
└── Deliverable: 9 schema files + 1 test file

Step 2: CloudWatch__Client + Stub
├── Depends on: Schema__Metric__Series, Schema__Metric__Dimension
├── Lazy boto3 import, us-east-1 CloudFront handling
├── Test: Stub returns canned data, real client skipped without AWS creds
└── Deliverable: 2 files + 1 test file

Step 3: Collectors (Lambda, S3, CloudFront)
├── Depends on: CloudWatch__Client, metric schemas
├── Each collector has collect() → typed schema
├── Test: inject Stub, verify schema output
└── Deliverable: 4 files (3 collectors + __init__) + 3 test files

Step 4: Send__Cache__Client extensions
├── Depends on: nothing new (extends existing class)
├── Add metrics__*, aggregation__*, costs__* methods
├── Test: integration with in-memory cache
└── Deliverable: 1 modified file + extend existing test

Step 5: SGraph_Send__Metrics__Snapshot orchestrator
├── Depends on: all collectors, cache client, all schemas
├── Wire collectors + health evaluation + cache save
├── Test: Stub CloudWatch, real in-memory cache
└── Deliverable: 1 file + 1 test file

Step 6: Service__Analytics__Aggregator
├── Depends on: Send__Cache__Client, Schema__Aggregation__Window
├── LETS cascade: 30min → hourly → daily
├── Test: write sample raw events, run aggregation, verify output
└── Deliverable: 1 file + 1 test file

Step 7: Dashboard__Generator
├── Depends on: Schema__Metrics__Snapshot, Schema__Aggregation__Window
├── HTML/CSS/SVG output (no matplotlib)
├── Test: generate from sample data, verify HTML structure
└── Deliverable: 1 file + embedded in route test

Step 8: Routes__Metrics + FastAPI registration
├── Depends on: everything above
├── Wire into admin FastAPI app
├── Test: end-to-end via TestClient
└── Deliverable: 1 new route file, 1 modified FastAPI file, 1 test file

Step 9: Deploy configuration
├── Add env vars to admin__config.py
├── Add GitHub secrets to deploy pipeline
├── Test: deploy to dev, call /metrics/snapshot
└── Deliverable: 1 modified config, CI pipeline update
```

### 4.3 Key Code Patterns to Follow

From the existing codebase:

```python
# === Comment header pattern ===
# ===============================================================================
# SGraph Send - CloudWatch Client
# Type_Safe wrapper for AWS CloudWatch metric collection
# ===============================================================================

# === Import pattern (one per line, column-aligned) ===
from osbot_utils.type_safe.Type_Safe                                import Type_Safe
from osbot_utils.type_safe.primitives.core.Safe_UInt                import Safe_UInt
from osbot_utils.type_safe.primitives.core.Safe_Float               import Safe_Float

# === Class pattern ===
class CloudWatch__Client(Type_Safe):                                # One-line description
    region : Safe_Str__Id = 'eu-west-2'                             # Inline comment

# === Method pattern (column-aligned parameters) ===
    def get_lambda_metric(self, function_name : Safe_Str__Id  ,     # Lambda function name
                                metric_name   : Safe_Str__Label,    # CloudWatch metric
                                statistic     : Safe_Str__Label = 'Sum',
                                unit          : Safe_Str__Label = 'Count',
                                lookback_minutes : Safe_UInt = 60   ,
                                period_seconds   : Safe_UInt = 300  ):

# === Service injection pattern (follow Routes__Tokens) ===
class Routes__Metrics(Fast_API__Routes):
    tag               : str = TAG__ROUTES_METRICS
    send_cache_client : Send__Cache__Client                         # Injected by add_routes()
```

---

## 5. DevOps: Infrastructure & Deploy Changes

### 5.1 What's Already Live (per setup guide)

| # | Service | Status | Notes |
|---|---------|--------|-------|
| 1 | CloudFront Real-Time Logs (no IP) | **Live** | Kinesis → Firehose → S3, c-ip excluded |
| 2 | CloudFront Additional Metrics | **Live** | 4xx/5xx/CacheHitRate in CloudWatch |
| 3 | CloudFront Response Headers | **Live** | Referrer-Policy: no-referrer (fixes T8) |
| 4 | X-Ray Tracing | **Live** | Both Lambdas |
| 5 | Lambda Insights | **Live** | Enhanced monitoring |
| 6 | CloudWatch Logs Retention | **Live** | 30-day retention |
| 7 | CloudTrail Data Events | **Live** | S3 + Lambda audit |
| 8 | S3 Access Logging | **Live** | Both buckets → log bucket |
| 9 | S3 Request Metrics | **Live** | Filter: `all-requests` |
| 10 | S3 Storage Lens | **Live** | Dashboard created |
| 11 | AWS Budgets | **Live** | $50 monthly + $5 daily spike |
| 12 | Cost Anomaly Detection | **Live** | $10 threshold |
| 13 | Lambda Concurrency Limits | **Live** | User: 50, Admin: 10 |

**All CloudWatch data is now flowing.** The metrics pipeline can start collecting immediately once deployed.

### 5.2 New Environment Variables Needed

| Env Var | Value Source | Lambda | Priority |
|---------|-------------|--------|----------|
| `SGRAPH_SEND__CLOUDFRONT_DISTRIBUTION_ID` | CloudFront console | Admin | P1 |
| `SGRAPH_SEND__S3_TRANSFERS_FILTER_ID` | S3 metrics console (probably `all-requests`) | Admin | P1 |
| `SGRAPH_SEND__S3_CACHE_FILTER_ID` | S3 metrics console (probably `all-requests`) | Admin | P1 |
| `SGRAPH_SEND__AWS_REGION` | AWS region (e.g., `eu-west-2`) | Admin | P1 |

**Already exists:** `SEND__S3_BUCKET` (transfers bucket), `CACHE__SERVICE__BUCKET_NAME` (cache bucket).

### 5.3 admin__config.py Changes

Add to `admin__config.py`:

```python
# Observability configuration
ENV__CLOUDFRONT_DISTRIBUTION_ID = 'SGRAPH_SEND__CLOUDFRONT_DISTRIBUTION_ID'
ENV__S3_TRANSFERS_FILTER_ID     = 'SGRAPH_SEND__S3_TRANSFERS_FILTER_ID'
ENV__S3_CACHE_FILTER_ID         = 'SGRAPH_SEND__S3_CACHE_FILTER_ID'
ENV__AWS_REGION                 = 'SGRAPH_SEND__AWS_REGION'
```

### 5.4 IAM Permissions Required

The admin Lambda execution role needs these additional permissions:

```json
{
    "Effect": "Allow",
    "Action": [
        "cloudwatch:GetMetricData",
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:ListMetrics"
    ],
    "Resource": "*"
}
```

**DevOps action:** Verify the admin Lambda execution role has these permissions. If not, add them via IAM console or osbot-aws.

### 5.5 GitHub Secrets to Add

| Secret Name | Purpose |
|-------------|---------|
| `SGRAPH_SEND__CLOUDFRONT_DISTRIBUTION_ID` | CloudFront distribution ID |
| `SGRAPH_SEND__S3_TRANSFERS_FILTER_ID` | S3 transfers bucket request metrics filter |
| `SGRAPH_SEND__S3_CACHE_FILTER_ID` | S3 cache bucket request metrics filter |
| `SGRAPH_SEND__AWS_REGION` | AWS region for CloudWatch |

Add to `ci-pipeline.yml` env var mapping for admin Lambda deploy.

### 5.6 No New Lambda Dependencies

`boto3` is provided by the Lambda runtime — do **not** add it to `APP__SEND__ADMIN__LAMBDA_DEPENDENCIES`. No matplotlib (using HTML/CSS/SVG dashboards instead).

---

## 6. Architect: Open Questions for Dinis

### Q1: Dashboard as HTML response vs Admin UI component?

The brief proposes a `Dashboard__Generator` that returns HTML from `/metrics/dashboard`. Alternative: return JSON from `/metrics/snapshot` and render in the admin UI (Web Component). The admin UI already has an analytics dashboard component.

**Recommendation:** Do both. JSON API for the admin UI, HTML endpoint for standalone/shareable dashboards.

### Q2: Aggregation trigger — on-demand vs scheduled?

The brief implies on-demand aggregation (triggered by route call). In Lambda, there's no cron scheduler. Options:

| Option | Mechanism | Latency |
|--------|-----------|---------|
| A. On-demand only | `/metrics/aggregation?window=30min` triggers computation | Real-time but slow first call |
| B. EventBridge rule | Scheduled Lambda invocation every 30 minutes | Pre-computed, fast reads |
| C. On-demand + cache | Compute if stale (>30min old), serve cache otherwise | Best of both |

**Recommendation:** Option C (on-demand + cache). Avoids EventBridge complexity, serves cached results for most requests, recomputes when stale. This is what the brief's `aggregate_window()` already implies with its "check if saved aggregation exists" logic.

### Q3: S3 Request Metrics Filter ID value?

The setup guide creates a filter named `all-requests` with scope "all objects in the bucket." The filter ID used in CloudWatch API calls may be the filter name itself. **DevOps action:** verify by checking CloudWatch console → S3 metrics → confirm the `FilterId` dimension value.

### Q4: CloudFront Real-Time Logs processing (Phase 2)?

The setup guide configures Kinesis → Firehose → S3 for CloudFront real-time logs. The brief defers log processing to Phase 2. Should we build the log reader infrastructure now (even if deferred) or wait?

**Recommendation:** Wait. Phase 1 uses CloudWatch aggregate metrics. Phase 2 adds per-request granularity from real-time logs. Building the reader now would be premature.

---

## 7. Summary: Changes from Brief

| Brief Section | Change | Reason |
|---------------|--------|--------|
| 4.1 CloudWatch Client | Remove `boto3_client : object = None` → use `_boto3_client` | Type_Safe compliance |
| 4.1 CloudWatch Client | `Safe_Str__AWS__Region` → `Safe_Str__Id` | Primitive doesn't exist |
| 5.1 Schemas | `List[Safe_*]` → `list` for most fields | Pragmatic — validated at boundaries |
| 5.1 Schemas | Named Lambda fields instead of list | Clearer than iterating |
| 5.4 Orchestrator | `thresholds = None` → factory in setup() | Type_Safe doesn't allow None for TS attrs |
| 5.4 Orchestrator | `cloudwatch_client = None` → factory in setup() | Same |
| 8 Testing | "Mocked boto3" → `CloudWatch__Client__Stub` (real class) | No mocks, no patches rule |
| 8 Testing | All tests use in-memory cache (real) | Consistent with existing test patterns |
| Dashboard | matplotlib → HTML/CSS/SVG | No Lambda dependency bloat |

---

## 8. Librarian: Cross-References

| Topic | Source Document |
|-------|----------------|
| Two-Lambda architecture | [v0.3.5 Architect](../../library/sgraph-send/releases/v0.3.5/v0.3.5__architect.md) |
| Deployment pipeline | [v0.3.5 DevOps](../../library/sgraph-send/releases/v0.3.5/v0.3.5__devops.md) |
| Security boundaries | [v0.3.5 AppSec](../../library/sgraph-send/releases/v0.3.5/v0.3.5__appsec.md) |
| Test patterns | [v0.3.5 QA](../../library/sgraph-send/releases/v0.3.5/v0.3.5__qa.md) |
| Codebase structure | [v0.3.5 Dev](../../library/sgraph-send/releases/v0.3.5/v0.3.5__dev.md) |
| Cache service patterns | `Send__Cache__Client.py` (existing) |
| Analytics middleware | `Middleware__Analytics.py` (existing, do not modify) |
| osbot-utils primitives | `library/dependencies/osbot-utils/type_safe/` |
| Type_Safe testing guide | `library/dependencies/osbot-utils/type_safe/v3.1.1__for_llms__type_safe__testing_guidance.md` |
| Original brief | `team/humans/dinis_cruz/briefs/02/15/aws-setup/v0.3.6__aws-observability-brief.md` |
| AWS setup guide | `team/humans/dinis_cruz/briefs/02/15/aws-setup/v0.3.6__devops__aws-observability-setup-guide.md` |

---

*Architect: Schema design, architectural corrections, open questions*
*Dev: Implementation plan, code patterns, file structure*
*DevOps: Infrastructure status, env vars, IAM, deploy changes*
*Librarian: Type_Safe compliance, cross-references, primitive catalogue*
*Historian: Decisions D048–D053 registered*
