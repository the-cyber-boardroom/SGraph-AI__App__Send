# Architect Review — Commit 07f1b09

**Version:** v0.1.4
**Date:** 2026-02-10
**Commit:** `07f1b09b227744a513177b1cf24f27fce874a0f6` — "added first implementation of Fast_API infrastructure"
**Author:** Architect role (Claude)
**Status:** Review complete

---

## 1. Architecture Pattern Assessment

**Two-Lambda split: correctly scaffolded.** The admin Lambda is fully wired end-to-end (config → FastAPI class → Lambda handler → deploy service). `lambda__user/note.txt` says "do the same here as what was done in lambda__admin". This is the right approach — prove the pattern on one Lambda, then replicate.

**OSBot-Fast-API: properly adopted.** `Fast_API__SGraph__App__Send__Admin` extends `Serverless__Fast_API`, which gives Mangum integration, route registration via `add_routes()`, and the `handler()` factory method for free. The `setup()` / `setup_routes()` hook pattern is correctly used.

**Type_Safe: used in test harness** (`Fast_API__Test_Objs__SGraph__App__Send__Admin` extends `Type_Safe` with typed fields), but `admin__config.py` uses bare module-level constants rather than a Type_Safe config class. A `# todo` at line 30 of the FastAPI class acknowledges the static routes should be refactored into their own class.

**Memory-FS: declared but not exercised.** Listed in `APP__SEND__ADMIN__LAMBDA_DEPENDENCIES` (pinned `memory-fs==v0.40.0`) — available for use when storage features are added.

**Verdict:** The foundational patterns are correct and well-aligned with the Conductor's decisions. This is a clean skeleton to build on.

---

## 2. API Contract & Route Analysis

### Routes exposed

The admin Lambda registers the following routes (validated by `test_Service__Fast_API__client.py:51-62`):

| Route | Source | Purpose |
|-------|--------|---------|
| `/info` | `Routes__Info` (osbot_fast_api_serverless) | Health/info endpoint |
| `/config/status` | `Routes__Info` | Config status |
| `/set-cookie` | `Routes__Set_Cookie` (osbot_fast_api) | Cookie management |
| `/admin` | Custom redirect | 307 → `/admin/v0/v0.1/v0.1.0/index.html` |
| `/admin/{path}` | `StaticFiles` mount | Static file serving |

### Auth model

API-key-based via HTTP headers using OSBot-Fast-API's built-in auth middleware:
- Key name and value injected via environment variables (`ENV_VAR__FAST_API__AUTH__API_KEY__NAME`, `ENV_VAR__FAST_API__AUTH__API_KEY__VALUE`)
- Returns `401 Unauthorized` with `{"detail": {"error": "API key is missing or invalid"}}` when no/invalid key provided
- Tests use `Random_Guid()` for the key value — good for test isolation

### Redirect chain

`GET /admin` → 307 redirect → `/admin/v0/v0.1/v0.1.0/index.html` (versioned static page)

---

## 3. Package & Module Structure

### Three top-level packages

```
sgraph_ai_app_send/              # Application code
  lambda__admin/                 # Admin Lambda
    admin__config.py             # All admin constants
    fast_api/                    # FastAPI service class
    lambda_function/             # Handler + deploy
  lambda__user/                  # User Lambda (placeholder)

sgraph_ai_app_send__ui__admin/   # Admin UI (separate package)
  __init__.py                    # Exports path = __path__[0]
  index.html                     # Root placeholder
  v0/v0.1/v0.1.0/index.html    # Versioned page

sgraph_ai_app_send__ui__user/    # User UI (separate package)
  __init__.py                    # Same pattern
  index.html                     # Placeholder
```

**UI packages are deliberately separate top-level packages.** This means:
- Independently discoverable via `__path__[0]`
- Can be independently versioned/deployed
- `Deploy__Service.deploy_lambda()` adds the UI folder to the Lambda zip explicitly
- Clean separation between server code and static assets

### Versioned static assets

The `v0/v0.1/v0.1.0/` directory nesting supports serving multiple versions simultaneously. The redirect target is config-driven — updating `APP_SEND__UI__ADMIN__LATEST__VERSION` in `admin__config.py` points all users to the new version instantly.

---

## 4. Dependency Analysis

### New dependencies in pyproject.toml

| Dependency | Version | Purpose |
|-----------|---------|---------|
| `osbot-fast-api-serverless` | `*` (unpinned) | FastAPI + Mangum + Lambda integration |

### Lambda layer dependencies (admin__config.py)

| Dependency | Pinned Version | Purpose |
|-----------|---------------|---------|
| `osbot-fast-api-serverless` | `v1.33.0` | FastAPI + Mangum |
| `osbot-aws` | `v2.29.9` | AWS operations |
| `memory-fs` | `v0.40.0` | Storage abstraction |

**Note:** `osbot-fast-api` is not a direct dependency — it's pulled in transitively through `osbot-fast-api-serverless`. This is correct per the dependency chain.

---

## 5. Data Flow

### Request path

```
Lambda event (API Gateway v2 / Lambda URL Function)
  → run(event, context)
    → handler(event, context)              [Mangum adapter]
      → ASGI / FastAPI app
        → Auth middleware (API key check)
        → Route dispatch
          → Response
```

### Cold-start initialisation

Module-level code in `lambda_handler__admin.py` runs once on cold start:
1. If `AWS_REGION` is set (i.e., running in Lambda): load Lambda layer dependencies, clear osbot_aws modules
2. Create `Fast_API__SGraph__App__Send__Admin` instance
3. Call `setup()` (configures app) then `handler()` (returns Mangum adapter)
4. If any exception: capture error string (don't crash the Lambda)

### Static file serving

`StaticFiles(directory=sgraph_ai_app_send__ui__admin.path)` mounts the UI package's filesystem directory under `/admin`. Any file in the package tree is served directly. The redirect from `/admin` to the versioned path is a separate explicit route.

---

## 6. Key Observations

### What's notably well done

1. **Contract test for routes** (`test_Service__Fast_API__client.py:51-62`) — verifies the exact set of registered routes. Any route addition/removal will break this test. This is an excellent pattern for catching unintended API changes.

2. **File-on-disk content verification** (`test__App_Send__UI__Admin__static_pages.py:34-37`) — reads the actual HTML file from disk and compares it byte-for-byte with the HTTP response body. Catches deployment misconfiguration.

3. **Error capture in Lambda handler** (lines 30-34) — prevents cold-start import failures from crashing the Lambda. The handler still runs and returns the error, rather than producing an opaque 502.

4. **Singleton test fixture** with `setup_completed` guard — efficient, ensures the FastAPI app is created once and reused across all test classes.

5. **UI packages with `__path__[0]` export** — elegant pattern for filesystem path discovery that works in both local development and Lambda deployment.

### Patterns to adopt going forward

- Route registration via `self.add_routes(Routes__ClassName)` in `setup_routes()`
- Config constants in a dedicated `*__config.py` module
- Test objects as Type_Safe classes with typed fields
- Route-completeness tests that assert the exact set of paths
- Static file serving via package `__path__[0]` + `StaticFiles` mount

---

## 7. Questions & Concerns

### Q1: Config class pattern
`admin__config.py` uses bare constants. Should we establish the Type_Safe config class pattern now (e.g., `Config__App__Send__Admin(Type_Safe)`) before `user__config.py` duplicates the bare-constants approach?

### Q2: Inverted comment
`lambda_handler__admin.py:3` — comment says "only execute if we are not running inside an AWS Lambda function" but the condition (`if os.getenv('AWS_REGION')`) is truthy *inside* Lambda. Code is correct, comment misleads.

### Q3: `clear_osbot_modules()` safety
Lines 10-16 delete `osbot_aws` from `sys.modules` after loading. If a route handler later imports `osbot_aws` at request time, will re-import work cleanly from the Lambda layer?

### Q4: UI packages in pyproject.toml
The two UI packages (`sgraph_ai_app_send__ui__admin`, `sgraph_ai_app_send__ui__user`) are not listed in `[tool.poetry.packages]`. This works for Lambda (Deploy__Service handles it) but would miss them in a wheel/pip install.

### Q5: Copy-paste function name
Test function `setup__html_graph_service__fast_api_test_objs` references "html_graph_service" from another project. Should be renamed to match this project.

### Q6: Static routes are unauthenticated
`/admin/index.html` returns 200 with no API key. The admin API endpoints require auth. Is this intentional — serve the admin UI publicly but require auth for API calls? Or should static routes also require auth?

### Q7: Root path returns 404
`GET /` returns 404. Should there be a health check or redirect at root for load balancer probes?

### Q8: Naming inconsistency in config
`admin__config.py` uses `APP__SEND__ADMIN__` (double underscore) on lines 3-5 but `APP_SEND__UI__ADMIN__` (single underscore) on lines 11-14. Should be uniform.
