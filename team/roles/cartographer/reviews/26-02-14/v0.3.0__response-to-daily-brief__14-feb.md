# v0.3.0 -- Cartographer Response to Daily Brief (14 Feb 2026)

**Version:** v0.3.0
**Date:** 2026-02-14
**Role:** Cartographer
**Brief:** `team/humans/dinis_cruz/briefs/02/14/v0.3.0__daily-brief__sgraph-send-14-feb-2026.md`
**Directive:** Update system landscape map with inter-Lambda communication flow.

---

## Executive Summary

This response updates the system topology maps to reflect the v0.3.0 architecture state. Key changes since the v0.2.24 cartographer review:

1. **Inter-Lambda communication** is now live via the Service Registry pattern
2. **Admin Lambda** has 3 service layers (Cache Client, Token Service, Analytics) fully wired
3. **Admin UI** is the next component to be mapped -- currently a placeholder
4. **Middleware__Analytics** intercepts all admin Lambda HTTP requests

The maps below capture the complete system as built, not as planned. Every arrow represents implemented, tested code.

---

## 1. Updated System Landscape Map

### 1.1 Full System View

```
                                    INTERNET
                                       |
                            +-----------+-----------+
                            |                       |
                     [User Lambda URL]        [Admin Lambda URL]
                     (public, no auth)        (API key auth)
                            |                       |
                +-----------+----------+    +-------+--------+
                |                      |    |                |
         [Static UI]           [FastAPI]    [FastAPI]   [Static UI]
         User v0.1.4           User App    Admin App   Admin v0.1.0
                                  |              |     (placeholder)
                                  |              |
                    +-------------+     +--------+--------+-------+
                    |                   |        |        |       |
            [Transfer__Service]   [Service   [Service   [Mid-   [Routes
                    |              Tokens]   Analytics]  ware    __Info]
            [Storage_FS]              |        Pulse]   Analy-
            (Memory/S3)               |        |       tics]
                                      +--------+--------+
                                             |
                                    [Send__Cache__Client]
                                             |
                                    [Cache__Service__Client]
                                       (MGraph-AI)
                                             |
                                    [Memory-FS Backend]
                                    (IN_MEMORY / S3)
```

### 1.2 Lambda Deployment Topology

```
AWS Account
|
+-- Lambda: sgraph-ai-app-send-user (Public)
|   +-- Lambda Function URL (no API Gateway)
|   +-- Runtime: Python 3.12 / arm64
|   +-- Handler: Mangum(FastAPI)
|   +-- Env vars:
|   |   +-- SGRAPH_SEND__ADMIN__BASE_URL
|   |   +-- SGRAPH_SEND__ADMIN__API_KEY__NAME
|   |   +-- SGRAPH_SEND__ADMIN__API_KEY__VALUE
|   |   +-- SGRAPH_SEND__ACCESS_TOKEN
|   +-- Dependencies: httpx, memory-fs, osbot-fast-api-serverless
|   +-- Storage: Storage_FS (S3 backend for transfers)
|
+-- Lambda: sgraph-ai-app-send-admin (Authenticated)
    +-- Lambda Function URL (no API Gateway)
    +-- Runtime: Python 3.12 / arm64
    +-- Handler: Mangum(FastAPI)
    +-- Env vars:
    |   +-- FAST_API__AUTH__API_KEY__NAME
    |   +-- FAST_API__AUTH__API_KEY__VALUE
    |   +-- CACHE__SERVICE__BUCKET_NAME
    +-- Dependencies: httpx, memory-fs, osbot-fast-api-serverless
    +-- Storage: Send__Cache__Client (Memory-FS / S3 for cache)
    +-- Middleware: Middleware__Analytics (per-request event recording)
```

---

## 2. Inter-Lambda Communication Flow

### 2.1 Service Registry Architecture

The Service Registry pattern enables code-agnostic deployment. The same `Admin__Service__Client` code runs identically in:
- **Unit tests:** IN_MEMORY mode (admin FastAPI app instantiated in-process)
- **Production:** REMOTE mode (HTTP calls to admin Lambda URL)

```
User Lambda Process                              Admin Lambda Process
+-------------------------------------------+    +-------------------------------------------+
|                                           |    |                                           |
|  Routes__Transfers                        |    |  Middleware__Analytics                     |
|       |                                   |    |       | (intercepts ALL requests)          |
|       v                                   |    |       v                                   |
|  Admin__Service__Client                   |    |  Routes__Tokens                           |
|       |                                   |    |       |                                   |
|       v                                   |    |       v                                   |
|  Admin__Service__Client__Requests         |    |  Service__Tokens                          |
|       |                                   |    |       |                                   |
|       v                                   |    |       v                                   |
|  Fast_API__Service__Registry              |    |  Send__Cache__Client                      |
|       |                                   |    |       |                                   |
|       +-- [IN_MEMORY] --> TestClient ---->+    |       v                                   |
|       |                                   |    |  Cache__Service__Client                   |
|       +-- [REMOTE] ----> httpx ---------> |===>|       |                                   |
|                          (HTTPS)          |    |       v                                   |
+-------------------------------------------+    |  Memory-FS (S3 backend)                   |
                                                 +-------------------------------------------+
```

### 2.2 Token Validation Flow (User Lambda -> Admin Lambda)

```
Browser                    User Lambda                     Admin Lambda
  |                            |                                |
  |-- GET /t/{token}/{id}#key->|                                |
  |                            |-- token_lookup(token_name) --->|
  |                            |   [via Service Registry]       |
  |                            |                                |-- token__lookup(name)
  |                            |                                |   [Send__Cache__Client]
  |                            |                                |   [hash lookup in tokens NS]
  |                            |<-- {status, usage_count} ------|
  |                            |                                |
  |                            |-- [if active] serve page ----->|
  |<-- download.html ---------|                                |
  |                            |                                |
  |-- POST /transfers/         |                                |
  |   validate-token/{name} -->|                                |
  |                            |-- token_use(name, ip_hash) --->|
  |                            |   [via Service Registry]       |
  |                            |                                |-- token__use(name, event)
  |                            |                                |   [increment usage_count]
  |                            |                                |   [record usage_event]
  |                            |<-- {success, remaining} -------|
  |<-- {success, remaining} ---|                                |
  |                            |                                |
  |-- GET /transfers/          |                                |
  |   download/{id} --------->|                                |
  |                            |-- [Storage_FS fetch] -------->|
  |<-- encrypted ciphertext ---|                                |
  |                            |                                |
  |-- [browser decrypts with   |                                |
  |    key from #fragment]     |                                |
```

### 2.3 Transfer Create Flow (with Token Creation)

```
Browser                    User Lambda                     Admin Lambda
  |                            |                                |
  |-- POST /transfers/create ->|                                |
  |   {file_size, content_type}|                                |
  |   [x-access-token header]  |                                |
  |                            |-- check_access_token() ------->|
  |                            |   [token_lookup via registry]  |
  |                            |<-- {status: 'active'} ---------|
  |                            |                                |
  |                            |-- Transfer__Service.create() ->|
  |                            |   [Storage_FS allocate]        |
  |<-- {transfer_id, upload_url}|                               |
  |                            |                                |
  |-- POST /transfers/upload ->|                                |
  |   [encrypted payload]      |                                |
  |                            |-- Storage_FS.write() -------->|
  |<-- {status: 'uploaded'} ---|                                |
  |                            |                                |
  |-- POST /transfers/complete>|                                |
  |                            |-- Transfer__Service.complete()->|
  |<-- {transfer_id,           |                                |
  |     token_name} -----------|                                |
  |                            |                                |
  |-- [JS builds share URL:    |                                |
  |    /t/{token}/{id}#key]    |                                |
```

---

## 3. Admin UI Data Flow

### 3.1 Browser -> Admin Lambda Endpoints -> Cache -> Memory-FS

```
Admin Browser (v0.1.0)
|
+-- [Token Management Panel]
|   |
|   +-- POST /tokens/create
|   |   Body: {token_name, usage_limit, created_by, metadata}
|   |   -> Routes__Tokens.create()
|   |      -> Service__Tokens.create()
|   |         -> Send__Cache__Client.token__create()
|   |            -> Cache__Service__Client.store().store__json__cache_key()
|   |               -> Memory-FS write: tokens/key_based/{hash}/{file}.json
|   |   <- {cache_id, token_name}
|   |
|   +-- GET /tokens/list
|   |   -> Routes__Tokens.list()
|   |      -> Service__Tokens.list_tokens()
|   |         -> Send__Cache__Client.token__list_all()
|   |            -> Cache__Service__Client.admin_storage().files__all__path()
|   |               -> Memory-FS list: tokens/**
|   |   <- {files: [...]}
|   |
|   +-- GET /tokens/lookup/{name}
|   |   -> Routes__Tokens.lookup__token_name()
|   |      -> Service__Tokens.lookup()
|   |         -> Send__Cache__Client.token__lookup()
|   |            -> Cache__Service__Client.retrieve().retrieve__hash__cache_hash__cache_id()
|   |            -> Cache__Service__Client.retrieve().retrieve__cache_id__json()
|   |               -> Memory-FS read: tokens/key_based/{hash}/{cache_id}.json
|   |   <- {token_name, usage_limit, usage_count, status, created_by, metadata}
|   |
|   +-- POST /tokens/revoke/{name}
|   |   -> Routes__Tokens.revoke__token_name()
|   |      -> Service__Tokens.revoke()
|   |         -> Send__Cache__Client.token__revoke()
|   |            -> token__lookup_cache_id() -> hash lookup
|   |            -> Cache__Service__Client.update().update__json()
|   |               -> Memory-FS update: tokens/key_based/{hash}/{cache_id}.json
|   |               -> set status='revoked'
|   |   <- {status: 'revoked', token_name}
|   |
|   +-- POST /tokens/use/{name}
|       Body: {ip_hash, action, transfer_id}
|       -> Routes__Tokens.use__token_name()
|          -> Service__Tokens.use()
|             -> Send__Cache__Client.token__lookup() [read current]
|             -> Send__Cache__Client.token__update() [increment count]
|             -> Send__Cache__Client.token__use()    [record event]
|                -> Cache__Service__Client.data_store().data__store_json__with__id_and_key()
|                   -> Memory-FS write: tokens/key_based/{hash}/{cache_id}/usage_events/{event_id}.json
|       <- {success, usage_count, remaining}
|
+-- [Analytics Dashboard]
|   |
|   +-- GET /health/pulse?window_minutes=5
|       -> compute_pulse()
|          -> Send__Cache__Client.analytics__list_recent_files()
|             -> Cache__Service__Client.admin_storage().files__all__path()
|                -> Memory-FS list: analytics/data/temporal/{YYYY}/{MM}/{DD}/{HH}/**
|          -> [for each .json file in window]:
|             -> Send__Cache__Client.analytics__retrieve_event()
|                -> Cache__Service__Client.retrieve().retrieve__cache_id__json()
|          -> aggregate: count requests, unique ip_hashes, transfer events
|       <- {window_minutes, active_requests, active_visitors, active_transfers}
|
+-- [System Health]
    |
    +-- GET /info
        -> Routes__Info (from osbot-fast-api)
        <- {name, version, description, ...}
```

### 3.2 Analytics Event Recording (Middleware)

Every HTTP request to the admin Lambda is recorded by `Middleware__Analytics`:

```
Any HTTP Request to Admin Lambda
        |
        v
  Middleware__Analytics.dispatch()
        |
        +-- call_next(request) --> [actual route handler] --> response
        |
        +-- Extract: client_ip, user_agent, path, method, status_code, duration
        |
        +-- hash_ip(client_ip) --> SHA-256 hash
        |
        +-- normalise_user_agent(user_agent) --> browser family
        |
        +-- classify_event_type(path, method):
        |   '/transfers/upload'   -> 'file_upload'
        |   '/transfers/download' -> 'file_download'
        |   '/transfers/*'        -> 'api_call'
        |   GET *                 -> 'page_view'
        |   else                  -> 'api_call'
        |
        +-- Send__Cache__Client.analytics__record_event(event_data)
        |   -> Cache__Service__Client.store().store__json()
        |      strategy='temporal'
        |      -> Memory-FS write: analytics/data/temporal/{YYYY}/{MM}/{DD}/{HH}/{cache_id}.json
        |
        +-- [try/except: analytics failures never crash user requests]
        |
        v
  Return response (unmodified)
```

---

## 4. Component Topology Map for Admin UI

### 4.1 Proposed Web Component Architecture

```
<admin-console>                          -- Root component (page shell)
|
+-- <admin-nav>                          -- Navigation sidebar/tabs
|   |
|   +-- [Tokens] tab
|   +-- [Analytics] tab
|   +-- [System] tab
|
+-- <admin-content>                      -- Content area (switches on active tab)
    |
    +-- <token-manager>                  -- Token management panel
    |   |
    |   +-- <token-create-form>          -- Create form (name, limit, metadata)
    |   |   +-- <input> token_name
    |   |   +-- <input> usage_limit (default: 50)
    |   |   +-- <input> created_by
    |   |   +-- <button> Create Token
    |   |
    |   +-- <token-list>                 -- Token list/table
    |   |   +-- [token-row] x N
    |   |       +-- name | status | usage_count/usage_limit | actions
    |   |       +-- <button> Revoke (if active)
    |   |       +-- <button> View Details
    |   |
    |   +-- <token-detail>               -- Token detail view (shown on click)
    |       +-- Full metadata display
    |       +-- Usage event history
    |       +-- Revoke action
    |
    +-- <analytics-dashboard>            -- Analytics display
    |   |
    |   +-- <pulse-widget>               -- Real-time pulse metrics
    |   |   +-- active_requests counter
    |   |   +-- active_visitors counter
    |   |   +-- active_transfers counter
    |   |   +-- window_minutes selector
    |   |   +-- auto-refresh timer
    |   |
    |   +-- <event-browser>              -- Raw event list (future)
    |       +-- Scrollable event table
    |       +-- Filter by event_type
    |
    +-- <system-health>                  -- System status
        +-- Service name + version
        +-- Cache health indicator
        +-- Uptime / last-checked timestamp
```

### 4.2 Component Communication Pattern

```
                    Events (bubbling up)
                    =====================

<token-create-form>  --[token-create]--->  <token-manager>  --[token-changed]--->  <admin-console>
<token-list>         --[token-select]--->  <token-manager>
<token-detail>       --[token-revoke]--->  <token-manager>  --[token-changed]--->  <admin-console>

                    Properties (passing down)
                    =========================

<admin-console>  --[activeTab]--------->  <admin-nav>
<admin-console>  --[activeTab]--------->  <admin-content>
<token-manager>  --[tokens]------------>  <token-list>
<token-manager>  --[selectedToken]----->  <token-detail>
<analytics-dashboard>  --[pulseData]--->  <pulse-widget>
```

### 4.3 Data Store Pattern (No State Management Library)

```
<admin-console>
    |
    +-- adminApiClient (shared instance)
    |   |
    |   +-- baseUrl: '' (same origin)
    |   +-- headers: {x-api-key: from cookie}
    |   +-- createToken(name, limit) -> POST /tokens/create
    |   +-- listTokens()             -> GET  /tokens/list
    |   +-- lookupToken(name)        -> GET  /tokens/lookup/{name}
    |   +-- revokeToken(name)        -> POST /tokens/revoke/{name}
    |   +-- getPulse(window)         -> GET  /health/pulse
    |   +-- getInfo()                -> GET  /info
    |
    +-- Passed to child components via property injection
```

---

## 5. Updated Dependency Graph

### 5.1 Python Package Dependencies

```
sgraph_ai_app_send (v0.3.0)
|
+-- osbot-fast-api-serverless (v1.33.0)
|   +-- osbot-fast-api
|   |   +-- FastAPI
|   |   +-- Starlette
|   |   +-- Uvicorn
|   +-- Mangum (Lambda adapter)
|
+-- memory-fs (v0.40.0)
|   +-- osbot-utils
|       +-- Type_Safe
|       +-- Safe_Str__Id, Safe_UInt, etc.
|
+-- httpx (v0.28.1)
|   (used by Admin__Service__Client__Requests in REMOTE mode)
|
+-- mgraph-ai-service-cache-client
|   +-- Cache__Service__Client
|   +-- Cache__Hash__Generator
```

### 5.2 Internal Module Dependencies

```
lambda__admin/
|
+-- fast_api/
|   +-- Fast_API__SGraph__App__Send__Admin
|   |   +-- depends on: admin__config, Send__Cache__Client, Service__Tokens
|   |   +-- mounts: Routes__Tokens, Routes__Info, Routes__Set_Cookie
|   |   +-- registers: /health/pulse direct route
|   |   +-- mounts: StaticFiles for admin UI
|   |
|   +-- routes/
|       +-- Routes__Tokens
|       |   +-- depends on: Service__Tokens, Schema__Token__Create__Request, Schema__Token__Use__Request
|       +-- Routes__Analytics
|           +-- depends on: Send__Cache__Client, compute_pulse
|
+-- service/
|   +-- Service__Tokens
|   |   +-- depends on: Send__Cache__Client
|   +-- Service__Analytics__Pulse (compute_pulse function)
|   |   +-- depends on: Send__Cache__Client
|   +-- Send__Cache__Client
|   |   +-- depends on: Cache__Service__Client, Cache__Hash__Generator
|   +-- Send__Cache__Setup
|   |   +-- depends on: Send__Cache__Client (factory)
|   +-- Middleware__Analytics
|       +-- depends on: Send__Cache__Client
|
+-- schemas/
|   +-- Schema__Token__Create__Request (Type_Safe)
|   +-- Schema__Token__Use__Request (Type_Safe)
|   +-- Schema__Token__Metadata (Type_Safe)
|   +-- Schema__Token__Usage_Event (Type_Safe)
|   +-- Schema__Analytics__Raw_Event (Type_Safe)
|   +-- Schema__Analytics__Pulse (Type_Safe)
|
+-- lambda_function/
    +-- lambda_handler__admin (Mangum entry point)

lambda__user/
|
+-- fast_api/
|   +-- Fast_API__SGraph__App__Send__User
|   +-- routes/
|       +-- Routes__Transfers
|           +-- depends on: Transfer__Service, Admin__Service__Client (optional)
|
+-- service/
|   +-- Transfer__Service
|   |   +-- depends on: Storage_FS
|   +-- Admin__Service__Client
|   |   +-- depends on: Admin__Service__Client__Requests
|   +-- Admin__Service__Client__Requests
|   |   +-- extends: Fast_API__Client__Requests
|   +-- Admin__Service__Client__Setup
|       +-- depends on: Fast_API__Service__Registry, Admin__Service__Client
|
+-- storage/
    +-- Storage_FS__S3
    +-- Send__Config
    +-- Enum__Storage__Mode
```

### 5.3 Cross-Lambda Dependency (Runtime)

```
User Lambda -----[HTTPS/IN_MEMORY]-----> Admin Lambda
     |                                         |
     |  Admin__Service__Client                 |  Receives at:
     |    .token_lookup(name)       ---------> |    GET /tokens/lookup/{name}
     |    .token_use(name, ...)     ---------> |    POST /tokens/use/{name}
     |    .token_create(name, ...)  ---------> |    POST /tokens/create
     |                                         |
     |  Transport: Service Registry            |
     |    IN_MEMORY: TestClient (same proc)    |
     |    REMOTE: httpx + API key header       |
```

---

## 6. Storage Namespace Map

```
Memory-FS Root (S3 bucket or in-memory)
|
+-- analytics/                           -- NS_ANALYTICS
|   +-- data/
|       +-- temporal/                    -- TEMPORAL strategy (auto-partitioned)
|           +-- {YYYY}/{MM}/{DD}/{HH}/
|               +-- {cache_id}.json      -- Schema__Analytics__Raw_Event
|               +-- {cache_id}.config    -- Cache metadata
|               +-- {cache_id}.metadata  -- Cache metadata
|
+-- tokens/                              -- NS_TOKENS
|   +-- key_based/                       -- KEY_BASED strategy (hash-indexed)
|       +-- {hash_prefix}/
|           +-- {cache_id}.json          -- Token data {token_name, usage_limit, usage_count, status, ...}
|           +-- {cache_id}.config
|           +-- {cache_id}.metadata
|           +-- {cache_id}/
|               +-- usage_events/        -- Child data (per-use events)
|                   +-- {event_id}.json  -- Schema__Token__Usage_Event
|
+-- transfers/                           -- NS_TRANSFERS (future)
|   +-- (per-transfer analytics summaries)
|
+-- costs/                               -- NS_COSTS (future)
    +-- (AWS cost data)
```

---

## 7. Security Boundary Map

```
+====================================================================+
| TRUST BOUNDARY: Public Internet                                     |
|                                                                     |
|  Browser (User)              Browser (Admin)                        |
|  +------------------+        +------------------+                   |
|  | Web Crypto API   |        | Admin Console    |                   |
|  | AES-256-GCM      |        | (no encryption)  |                   |
|  | Key in #fragment  |        | API key in cookie|                   |
|  +--------+---------+        +--------+---------+                   |
|           |                           |                             |
+===========|===========================|=============================+
            |                           |
    [Lambda Function URL]       [Lambda Function URL]
    (no auth on URL)            (API key required)
            |                           |
+===========|===========================|=============================+
| TRUST BOUNDARY: AWS Lambda                                          |
|           |                           |                             |
|  +--------v---------+        +--------v---------+                   |
|  | User Lambda      |        | Admin Lambda     |                   |
|  | - No API key     |        | - API key auth   |                   |
|  | - Access token   |        | - Full CRUD      |                   |
|  |   header check   |        | - Analytics      |                   |
|  | - Ciphertext only|        | - No plaintext   |                   |
|  +--------+---------+        +--------+---------+                   |
|           |                           |                             |
|           +------[Service Registry]---+                             |
|           |      (HTTPS + API key)                                  |
|           |                           |                             |
|  +--------v---------+        +--------v---------+                   |
|  | Storage_FS (S3)  |        | Send__Cache__Client                 |
|  | Transfer bucket  |        | Cache bucket      |                  |
|  | Encrypted only   |        | Tokens + analytics |                 |
|  +------------------+        +-------------------+                  |
|                                                                     |
| KEY INVARIANTS:                                                     |
| - Server NEVER sees plaintext (encrypted in browser)                |
| - Server NEVER sees file names (not transmitted)                    |
| - Server NEVER sees decryption keys (#fragment stays in browser)    |
| - IP addresses are SHA-256 hashed before storage                    |
| - Admin API key required for all token/analytics operations         |
| - Analytics failures never crash user requests (try/except)         |
+=====================================================================+
```

---

## 8. Changes from Previous Map (v0.2.24)

| Area | v0.2.24 State | v0.3.0 State |
|------|---------------|--------------|
| Inter-Lambda communication | Planned (in dev brief) | **Implemented** -- Admin__Service__Client + Service Registry |
| Token validation in user Lambda | Not connected | **Wired** -- Routes__Transfers.check_access_token() calls admin |
| Admin Lambda endpoints | 5 token + 1 pulse (implemented) | Same (no new endpoints) |
| Admin UI | Placeholder | **Still placeholder** -- v0.1.0 build is Priority 1 |
| Analytics middleware | Planned | **Implemented** -- Middleware__Analytics on admin Lambda |
| Cache namespaces | 2 defined (analytics, tokens) | 4 defined (analytics, tokens, transfers, costs) -- 2 active |
| Schemas | 6 Type_Safe schemas | Same 6 -- all migrated to domain-specific primitives |
| Storage namespace map | Not documented | **New** -- full path structure documented above |
| UI versions shipped | v0.1.3 (user) | v0.1.4 (user), v0.1.0 placeholder (admin) |

---

*All diagrams reflect implemented, tested code as of v0.3.0. The admin UI component topology (Section 4) is proposed architecture -- it will be confirmed when the Architect and Dev produce the admin UI v0.1.0 implementation.*
