name: CI Pipeline (Base)

on:
  workflow_call:
    inputs:
      git_branch:
        required: true
        type: string
      release_type:
        required: false
        type: string
        default: ""
      should_increment_tag:
        required: false
        type: boolean
        default: false
      should_publish_pypi:
        required: false
        type: boolean
        default: false
      target_deploy:
        required: true
        type: string
    secrets:
      AWS_SECRET_ACCESS_KEY:
        required: false
      AWS_DEFAULT_REGION:
        required: false
      AWS_ACCOUNT_ID:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      FAST_API__AUTH__API_KEY__NAME:
        required: false
      FAST_API__AUTH__API_KEY__VALUE:
        required: false
      CACHE__SERVICE__BUCKET_NAME:
        required: false
      SGRAPH_SEND__ADMIN__BASE_URL:
        required: false
      SGRAPH_SEND__ADMIN__API_KEY__NAME:
        required: false
      SGRAPH_SEND__ADMIN__API_KEY__VALUE:
        required: false

env:
  PACKAGE_NAME: 'sgraph_ai_app_send'

jobs:
  run-tests:
    name: "Run Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "run-tests"
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/pytest__run-tests@dev
        with:
          test_target: "tests/unit"

  increment-tag:
    name: Increment Tag
    runs-on: ubuntu-latest
    needs: [run-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Increment Tag
        if: inputs.should_increment_tag
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/git__increment-tag@dev
        with:
          release_type: ${{ inputs.release_type }}

  publish-to-pypi:
    if: inputs.should_publish_pypi && needs.increment-tag.result == 'success'
    name: "Publish to: PYPI"
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    needs: [increment-tag]
    steps:
      - uses: actions/checkout@v4
      - name: Git Update Current Branch
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/git__update_branch@dev
      - name: publish-to-pypi
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/pypi__publish@dev

  check-aws-credentials:
    name: Check AWS Credentials
    runs-on: ubuntu-latest
    needs:
      - run-tests
    outputs:
      has-credentials: ${{ steps.check.outputs.has-credentials }}
    steps:
      - name: Check if AWS credentials are configured
        id: check
        run: |
          if [[ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]] && \
             [[ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]] && \
             [[ -n "${{ secrets.AWS_DEFAULT_REGION }}" ]] && \
             [[ -n "${{ secrets.AWS_ACCOUNT_ID }}" ]]; then
            echo "has-credentials=true" >> $GITHUB_OUTPUT
            echo "✅ AWS credentials are configured"
          else
            echo "has-credentials=false" >> $GITHUB_OUTPUT
            echo "⚠️  AWS credentials are not configured - deployment will be skipped"
          fi

  aws-deploy-lambda__admin:
    if: needs.check-aws-credentials.outputs.has-credentials == 'true'
    name: Admin - Deploy AWS Lambda
    runs-on: ubuntu-latest
    needs: [check-aws-credentials, increment-tag]  # Now this works because increment-tag always runs
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Service Lambda function
        uses: ./.github/actions/aws__deploy__lambda
        env:
          AWS_SECRET_ACCESS_KEY                        : ${{ secrets.AWS_SECRET_ACCESS_KEY                        }}
          AWS_DEFAULT_REGION                           : ${{ secrets.AWS_DEFAULT_REGION                           }}
          AWS_ACCOUNT_ID                               : ${{ secrets.AWS_ACCOUNT_ID                               }}
          AWS_ACCESS_KEY_ID                            : ${{ secrets.AWS_ACCESS_KEY_ID                            }}
          FAST_API__AUTH__API_KEY__NAME                : ${{ secrets.FAST_API__AUTH__API_KEY__NAME                }}
          FAST_API__AUTH__API_KEY__VALUE               : ${{ secrets.FAST_API__AUTH__API_KEY__VALUE               }}
          URL__TARGET_SERVER__CACHE_SERVICE            : ${{ secrets.AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL }}
          CACHE__SERVICE__BUCKET_NAME                  : ${{ secrets.CACHE__SERVICE__BUCKET_NAME                  }}
        with:
          target      : ${{ inputs.target_deploy }}
          lambda_type : 'Admin'

  aws-deploy-lambda__user:
    if: needs.check-aws-credentials.outputs.has-credentials == 'true'
    name: User - Deploy AWS Lambda
    runs-on: ubuntu-latest
    needs: [ check-aws-credentials, increment-tag ]  # Now this works because increment-tag always runs
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Service Lambda function
        uses: ./.github/actions/aws__deploy__lambda
        env:
          AWS_SECRET_ACCESS_KEY                        : ${{ secrets.AWS_SECRET_ACCESS_KEY                        }}
          AWS_DEFAULT_REGION                           : ${{ secrets.AWS_DEFAULT_REGION                           }}
          AWS_ACCOUNT_ID                               : ${{ secrets.AWS_ACCOUNT_ID                               }}
          AWS_ACCESS_KEY_ID                            : ${{ secrets.AWS_ACCESS_KEY_ID                            }}
          FAST_API__AUTH__API_KEY__NAME                : ${{ secrets.FAST_API__AUTH__API_KEY__NAME                }}
          FAST_API__AUTH__API_KEY__VALUE               : ${{ secrets.FAST_API__AUTH__API_KEY__VALUE               }}
          URL__TARGET_SERVER__CACHE_SERVICE            : ${{ secrets.AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL }}
          SGRAPH_SEND__ADMIN__BASE_URL                 : ${{ secrets.SGRAPH_SEND__ADMIN__BASE_URL                 }}
          SGRAPH_SEND__ADMIN__API_KEY__NAME            : ${{ secrets.SGRAPH_SEND__ADMIN__API_KEY__NAME            }}
          SGRAPH_SEND__ADMIN__API_KEY__VALUE           : ${{ secrets.SGRAPH_SEND__ADMIN__API_KEY__VALUE           }}
        with:
          target     : ${{ inputs.target_deploy }}
          lambda_type: 'User'