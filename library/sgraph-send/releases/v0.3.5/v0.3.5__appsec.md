# SGraph Send v0.3.5 — AppSec

**Role:** Application security — threat model, STRIDE analysis, risk register, zero-knowledge verification.

> For system topology and trust boundaries see [Cartographer](v0.3.5__cartographer.md). For architecture decisions see [Architect](v0.3.5__architect.md). For test coverage see [QA](v0.3.5__qa.md).

---

## Zero-Knowledge Architecture

SGraph Send is **zero-knowledge by design**: the server cannot decrypt files even if fully compromised. This is achieved through four properties:

| Property | Implementation | Verification |
|----------|---------------|--------------|
| **Server never sees plaintext** | AES-256-GCM encryption in browser before upload | No decrypt operations in server code |
| **No file names on server** | Original file name never transmitted | No filename field in API contracts or storage |
| **No decryption keys on server** | Key in URL hash-fragment (RFC 3986: not sent to server) | No key parameters in any API endpoint |
| **IP addresses hashed** | SHA-256 of IP before storage | `hash_ip()` called before any persistence |

**All backend data is non-sensitive by construction.** A complete S3 dump reveals only: encrypted ciphertext, IP hashes, file sizes, timestamps, and download counts. No file contents, names, or keys.

---

## Encryption Flow

```
SENDER BROWSER                          SERVER                    RECEIVER BROWSER
──────────────                          ──────                    ────────────────
1. Generate AES-256-GCM key
   (crypto.subtle.generateKey)
2. Generate random IV (12 bytes)
3. Encrypt file → ciphertext
   (crypto.subtle.encrypt)
4. POST /transfers/create ──────────▶ Create transfer_id
                                     Save meta.json
5. POST /transfers/upload/{id} ─────▶ Save ciphertext
   [encrypted bytes only]            (cannot decrypt)
6. POST /transfers/complete/{id} ───▶ Mark completed
7. Export key as base64url
8. Build URL: ...#id={id}&key={key}
9. Share URL out-of-band
   (email, chat, etc.)
                                                                 10. Extract id + key from #fragment
                                                                 11. GET /transfers/download/{id}
                                                                     ◀── [encrypted bytes]
                                                                 12. Import key (base64url → CryptoKey)
                                                                 13. Decrypt ciphertext → plaintext
                                                                     (crypto.subtle.decrypt)
```

**Critical security property:** Steps 1-3 and 10-13 happen exclusively in the browser. The server handles steps 4-6 and 11 — it only ever touches encrypted bytes.

---

## Threat Model (STRIDE)

### Trust Boundaries

1. **Browser ↔ Internet** — TLS, no key in URL path
2. **Internet ↔ User Lambda** — Function URL (HTTPS), no API Gateway
3. **User Lambda ↔ Admin Lambda** — HTTP with API key auth
4. **Lambda ↔ S3** — IAM role, encrypted at rest

### STRIDE Analysis

| Threat | Category | Attack | Mitigation | Status |
|--------|----------|--------|------------|--------|
| T1 | Spoofing | Impersonate sender | Token auth required for upload | Mitigated |
| T2 | Spoofing | Impersonate admin | API key auth on admin Lambda | Mitigated |
| T3 | Tampering | Modify ciphertext in transit | TLS (HTTPS) | Mitigated |
| T4 | Tampering | Modify ciphertext at rest | AES-GCM auth tag detects tampering | Mitigated |
| T5 | Repudiation | Deny upload | IP hash + event logging | Partial |
| T6 | Info Disclosure | Server reads plaintext | Zero-knowledge design (impossible) | Mitigated |
| T7 | Info Disclosure | Key leaks via URL | Hash-fragment not sent to server | Mitigated |
| T8 | Info Disclosure | Key leaks via Referrer | Referrer-Policy header needed | **Open (P0)** |
| T9 | Info Disclosure | Admin API key in browser JS | Cookie-based auth recommended | **Open (P1)** |
| T10 | DoS | Flood upload endpoint | No rate limiting | **Open (P0)** |
| T11 | DoS | Large file upload | No size enforcement | **Open (P1)** |
| T12 | Elevation | Access admin from public | Separate Lambda, separate auth | Mitigated |
| T13 | Info Disclosure | Transfer ID guessable | Cryptographic random (12 chars) | Mitigated |
| T14 | Info Disclosure | IP hash reversible | SHA-256 but unsalted | **Open (P1)** |

---

## Risk Register

### P0 — Critical

| ID | Risk | Description | Status |
|----|------|-------------|--------|
| RF-08 | No rate limiting | API endpoints accept unlimited requests; abuse and cost spike risk | Open |
| RF-09 | CORS not locked down | Lambda Function URLs may have permissive defaults | Open |
| RF-29 | Admin UI API key exposure | API key could be visible in browser JS/network tab | Open |
| T8 | Referrer-Policy missing | Key in hash-fragment could leak via Referrer header without policy | Open |

### P1 — Important

| ID | Risk | Description | Status |
|----|------|-------------|--------|
| RF-05 | IP hash unsalted | SHA-256 without daily salt; IPs are reversible via rainbow table | Open |
| RF-11 | No upload size limits | No enforcement of file size; large uploads could exhaust storage | Open |
| RF-14 | Dependency versions | Not pinned to exact versions in Lambda layers | Open |
| RF-30 | No QUnit CI | Admin UI JavaScript tests not in CI pipeline | Open |
| T9 | Admin API key in browser | Admin console sends API key in headers visible to network inspector | Open |

### P2 — Moderate

| ID | Risk | Description | Status |
|----|------|-------------|--------|
| RF-15 | No structured logging | Logs are unstructured; hard to query for security events | Open |
| RF-16 | No WAF | No Web Application Firewall on Lambda Function URLs | Open |
| RF-20 | IFD independence | CSS cascade between versions could cause visual bugs | Accepted |

### Mitigated

| ID | Risk | Original Concern | Mitigation |
|----|------|-----------------|------------|
| RF-01 | Zero-knowledge | Server could see plaintext | Verified: no decrypt in server code |
| RF-02 | Key transmission | Key sent in URL path | Key in hash-fragment (RFC 3986) |
| RF-03 | Cross-origin | CORS misconfiguration | Handled by osbot-fast-api framework |
| RF-10 | Admin isolation | Admin accessible from public | Separate Lambda with API key auth |
| RF-25 | Cache bucket | Shared S3 with prefix isolation | Verified: prefix provides namespace isolation |

---

## Attack Scenarios

### Scenario 1: Total AWS Compromise

**Impact:** Attacker gains access to all S3 data and Lambda functions.
**What they get:** Encrypted ciphertext, IP hashes, file sizes, timestamps.
**What they DON'T get:** Plaintext files, file names, decryption keys.
**Result:** Zero-knowledge design means data breach exposure is minimal.

A tabletop exercise for this scenario is documented in `team/roles/appsec/reviews/26-02-13/v0.2.24__tabletop-exercise__total-aws-compromise.md`.

### Scenario 2: XSS on Download Page

**Impact:** Attacker injects script that exfiltrates decryption key from hash-fragment.
**Mitigation:** Content Security Policy (planned), input sanitisation, no user-generated content rendered.
**Status:** Partial — CSP headers not yet implemented.

### Scenario 3: Transfer ID Enumeration

**Impact:** Attacker guesses transfer IDs to download encrypted files.
**Mitigation:** Transfer IDs are cryptographic random (12 chars = 48 bits entropy). Files are encrypted — downloading without the key yields only ciphertext.
**Status:** Mitigated (by design).

---

## Security Decisions for Explorer Track

### Unencrypted Mode (Conditional Approval)

If Explorer implements optional unencrypted mode, 8 mandatory conditions apply:

| ID | Condition |
|----|-----------|
| UC-1 | Encrypted-by-default (opt-in to unencrypted, not opt-out) |
| UC-2 | Explicit user confirmation before unencrypted upload |
| UC-3 | Visual indicator on download page showing unencrypted status |
| UC-4 | Server-side validation rejects unencrypted uploads without flag |
| UC-5 | Separate storage path for unencrypted files |
| UC-6 | No mixing of encrypted/unencrypted in same transfer |
| UC-7 | Admin can disable unencrypted mode globally |
| UC-8 | All security documentation updated to reflect dual mode |

### Large File Transfer Security

| ID | Requirement |
|----|------------|
| LF-1 | Chunk integrity verification (per-chunk hash) |
| LF-2 | Chunk ordering enforcement (server validates sequence) |
| LF-3 | Orphaned chunk cleanup (TTL on incomplete uploads) |
| LF-4 | Resume token security (token bound to transfer_id + IP hash) |
| LF-5 | Chunk size limits (server-enforced maximum) |
| LF-6 | Total transfer size limits (across all chunks) |
| LF-7 | Encryption applied per-chunk, not per-file |

---

## Incident Response

When a security incident is detected:

1. **Assess zero-knowledge** — Verify no plaintext was exposed (by construction, this should always hold)
2. **Check trust boundaries** — Identify which boundary was crossed
3. **Preserve evidence** — Capture logs, S3 state, Lambda configuration before remediation
4. **Simulate fix** — Test remediation on non-production target
5. **Apply and verify** — Deploy fix, run smoke tests (health, auth, CORS, no-plaintext)
6. **Post-incident review** — What detection gaps exist? What smoke tests should be added?

All roles are security sensors. Any role that detects anomalous behaviour should escalate to AppSec immediately.

---

## Compliance Notes

- **GDPR:** IP hashing provides pseudonymisation. GA removed (zero cookies). Privacy policy needed (identified as debt).
- **No PII stored:** By zero-knowledge design, no personal data is stored on server (encrypted file contents are not PII to the server).
- **Data retention:** No S3 lifecycle rules yet — transfer objects persist indefinitely (P1 gap).

---

## Document Lineage

This document consolidates content from:
- `team/roles/appsec/reviews/26-02-12/v0.2.15__threat-model__sgraph-send.md`
- `team/roles/appsec/reviews/26-02-13/v0.2.24__response-to-daily-brief__13-feb.md`
- `team/roles/appsec/reviews/26-02-13/v0.2.24__status-report__post-launch.md`
- `team/roles/appsec/reviews/26-02-14/v0.3.0__response-to-daily-brief__14-feb.md`
- `team/roles/appsec/reviews/26-02-14/v0.3.2__action-plan__explorer-next-steps.md`
- `team/roles/appsec/reviews/26-02-13/v0.2.24__tabletop-exercise__total-aws-compromise.md`
