# SGraph Send v0.3.5 — Dev

**Role:** Codebase structure, implementation patterns, code conventions, tech debt.

> For API contracts see [Architect](v0.3.5__architect.md). For test structure see [QA](v0.3.5__qa.md). For deployment see [DevOps](v0.3.5__devops.md).

---

## Codebase Structure

```
sgraph_ai_app_send/                          # Application code (1,628 lines)
├── version                                  # Current version file
├── utils/
│   └── Version.py                           # Version reader
│
├── lambda__user/                            # User Lambda
│   ├── user__config.py                      # Service name, dependencies, UI routing
│   ├── Fast_API__SGraph__App__Send__User.py # FastAPI app class
│   ├── fast_api/
│   │   ├── routes/
│   │   │   └── Routes__Transfers.py         # 7 transfer endpoints
│   │   └── middleware/
│   │       └── Middleware__Analytics.py      # Request event recording
│   ├── service/
│   │   ├── Transfer__Service.py             # Transfer lifecycle
│   │   ├── Admin__Service__Client.py        # Inter-Lambda HTTP client
│   │   └── Admin__Service__Client__Requests.py
│   ├── schemas/                             # Type_Safe data classes
│   │   └── Schema__Transfer.py
│   ├── storage/
│   │   ├── Send__Config.py                  # Storage backend factory
│   │   └── Storage_FS__S3.py                # S3 backend implementation
│   └── lambda_function/
│       ├── lambda_handler__user.py           # Lambda entry point
│       └── deploy/
│           └── Deploy__Service.py            # Deployment class
│
├── lambda__admin/                           # Admin Lambda
│   ├── admin__config.py                     # Service name, dependencies, UI routing
│   ├── Fast_API__SGraph__App__Send__Admin.py # FastAPI app class
│   ├── fast_api/
│   │   └── routes/
│   │       ├── Routes__Tokens.py            # 6 token endpoints
│   │       └── Routes__Analytics.py         # Pulse endpoint
│   ├── service/
│   │   ├── Service__Tokens.py               # Token lifecycle
│   │   ├── Send__Cache__Client.py           # Cache service wrapper
│   │   └── Service__Analytics__Pulse.py     # Traffic pulse
│   ├── schemas/
│   │   └── Schema__Token.py                 # Token schemas
│   └── lambda_function/
│       ├── lambda_handler__admin.py          # Lambda entry point
│       └── deploy/
│           └── Deploy__Service.py            # Deployment class
│
sgraph_ai_app_send__ui__user/                # User UI static assets
└── v0/v0.1/
    ├── v0.1.0/                              # Base version (all components)
    ├── v0.1.1/ → v0.1.4/                   # IFD surgical overrides
    └── (latest: v0.1.4)
        ├── index.html                       # Upload page
        ├── download.html                    # Download page
        ├── js/i18n.js                       # Internationalisation
        └── components/
            ├── send-upload/send-upload.js
            └── send-download/send-download.js

sgraph_ai_app_send__ui__admin/               # Admin UI static assets
└── v0/v0.1/v0.1.0/
    ├── index.html                           # Admin console
    ├── admin-shell.js                       # Root Web Component
    ├── js/admin-api.js                      # API client
    ├── css/admin.css                        # Styles
    └── components/
        ├── analytics-dashboard/
        ├── token-manager/
        └── system-info/
```

---

## Implementation Patterns

### Class Inheritance

All application classes follow consistent patterns:

| Pattern | Base Class | Source |
|---------|-----------|--------|
| Services | `Type_Safe` | `osbot-utils` |
| Routes | `Fast_API__Routes` | `osbot-fast-api` |
| FastAPI apps | `Serverless__Fast_API` | `osbot-fast-api-serverless` |
| Schemas | `Type_Safe` | `osbot-utils` |
| Enums | `(str, Enum)` | Python stdlib |
| Storage | `Storage_FS` | `memory-fs` |
| Config | `Type_Safe` | `osbot-utils` |

### Naming Conventions

| Type | Convention | Example |
|------|-----------|---------|
| Service class | `Service__*` or `*__Service` | `Transfer__Service`, `Service__Tokens` |
| Schema/DTO | `Schema__*` | `Schema__Transfer__Create` |
| Enum | `Enum__*` | `Enum__Transfer__Status` |
| Config | `*__Config` or `Send__Config` | `Send__Config` |
| Client | `*__Client` or `*__Service__Client` | `Admin__Service__Client` |
| Middleware | `Middleware__*` | `Middleware__Analytics` |
| Routes | `Routes__*` | `Routes__Transfers` |

### Method Naming

| Pattern | Semantics | Example |
|---------|-----------|---------|
| `create_*` | Create new entity | `create_transfer()` |
| `get_*` | Read entity | `get_transfer_info()` |
| `has_*` | Boolean check | `has_transfer()`, `has_payload()` |
| `save_*` | Persist to storage | `save_meta()` |
| `load_*` | Read from storage | `load_meta()` |
| `hash_*` | Hash operation | `hash_ip()` |
| `setup_*` | Initialise component | `setup_admin_service_client__remote()` |

### Route Auto-Registration

Routes are auto-registered by `osbot-fast-api` based on method names:

```python
class Routes__Transfers(Fast_API__Routes):
    def create(self):              # → POST /transfers/create
    def upload__transfer_id(self): # → POST /transfers/upload/{transfer_id}
    def info__transfer_id(self):   # → GET  /transfers/info/{transfer_id}
```

Double-underscore in method name becomes path parameter: `upload__transfer_id` → `/upload/{transfer_id}`.

### Storage Interface

All file operations use `Storage_FS` methods (see [Architect](v0.3.5__architect.md) for backend details):

```python
storage.file__save(path, data)     # Write
storage.file__bytes(path)          # Read bytes
storage.file__json(path)           # Read JSON
storage.file__exists(path)         # Check
storage.file__delete(path)         # Delete
storage.files__paths()             # List
```

### Service Registry Pattern

Inter-service communication uses the osbot-fast-api Service Registry:

```python
# Production (REMOTE mode) — HTTP calls
setup_admin_service_client__remote()
# → reads env vars, registers with service_registry in REMOTE mode

# Tests (IN_MEMORY mode) — direct function calls
setup_admin_service_client__in_memory(admin_fast_api)
# → registers with admin FastAPI instance, no HTTP
```

### IFD Frontend Pattern

Each UI version is a folder with surgical overrides:

```
v0/v0.1/v0.1.0/     # Base: all components, all CSS, all JS
v0/v0.1/v0.1.1/     # Override: only changed files
v0/v0.1/v0.1.2/     # Override: only changed files
v0/v0.1/v0.1.3/     # Override: only changed files
v0/v0.1/v0.1.4/     # Override: only changed files (latest)
```

Web Components are registered with `customElements.define()`. No Shadow DOM — CSS cascade applies.

---

## Dependencies

### Core (always loaded)

| Package | Purpose |
|---------|---------|
| `osbot-fast-api-serverless` | Lambda adapter for FastAPI |
| `osbot-utils` | Type_Safe, safe primitives, utilities |
| `memory-fs` | Storage_FS abstraction (Memory + S3) |
| `osbot-aws` | AWS operations (never boto3 directly) |
| `httpx` | HTTP client (inter-Lambda communication) |
| `mgraph-ai-service-cache` | MGraph-AI cache service |
| `mgraph-ai-service-cache-client` | Cache client |

### Constraints

- **Never use Pydantic** — `Type_Safe` replaces it everywhere
- **Never use boto3 directly** — `osbot-aws` wraps all AWS operations
- **Never use direct S3/filesystem calls** — `Storage_FS` abstracts storage
- **Never use external JS frameworks** — vanilla JS + Web Components only

---

## Known Tech Debt

### High Priority

| Issue | Location | Impact |
|-------|----------|--------|
| Raw `dict` returns instead of Type_Safe schemas | `Transfer__Service`, `Service__Tokens` | Type safety, validation |
| Hardcoded upload URL pattern | `Transfer__Service.create_transfer()` | Route/service coupling |
| No centralised env var reading | Multiple `os.environ.get()` calls | Configuration scattered |
| Raw `Transfer_Id` as string | `create_transfer()` | Should use `Transfer_Id` class |
| Timestamps use mixed formats | Various | Should standardise on `Timestamp_Now()` |

### Medium Priority

| Issue | Location | Impact |
|-------|----------|--------|
| Static route setup in main app class | `Fast_API__SGraph__App__Send__User` | Should be separate class |
| Analytics pulse duplicates cache logic | `Service__Analytics__Pulse` | Code duplication |
| IP hashing in service | `Transfer__Service.hash_ip()` | Should use `Cache__Hash__Generator` |
| Routes use raw primitives | `Routes__Transfers` | Should use Safe_Str types |

---

## Build Order Reference

The original build order for Phase 1 (now complete):

```
Infrastructure → Tokens → Upload → Download → Transparency → Status/UX → Security
```

Current state: all Phase 1 features implemented. Explorer track now working on Genesis-stage features (large file transfer, bots, design). Villager track hardens existing Custom-Built features.

---

## Document Lineage

This document consolidates content from:
- `team/roles/dev/ROLE.md`
- `team/roles/dev/reviews/26-02-10/v0.2.1__response-to-infrastructure-brief.md`
- `team/roles/dev/reviews/26-02-14/v0.3.2__action-plan__explorer-next-steps.md`
- Direct codebase analysis of `sgraph_ai_app_send/` modules
