# SGraph Send v0.3.5 — DevOps

**Role:** CI/CD pipelines, Lambda deployment, infrastructure, environment configuration.

> For architecture decisions see [Architect](v0.3.5__architect.md). For system topology see [Cartographer](v0.3.5__cartographer.md). For security gaps see [AppSec](v0.3.5__appsec.md).

---

## CI/CD Pipeline Architecture

The pipeline uses a three-file pattern:

```
ci-pipeline__dev.yml    ─┐
                         ├──▶ ci-pipeline.yml (shared base)
ci-pipeline__main.yml   ─┘
```

### Dev Pipeline (push to `dev`)

```
1. Run Unit Tests (20s)     ─────────────────────────────────────┐
2. Increment Tag — minor (8s)  [after tests]                     │
3. Check AWS Credentials (3s)  [after tests, parallel with tag]  │
4. Deploy Admin Lambda (49s)   [after tag + creds]               │
5. Deploy User Lambda (41s)    [parallel with admin]             │
                                                     Total: ~90s ┘
```

### Main Pipeline (push to `main`)

```
1. Run Unit Tests (20s)
2. Increment Tag — major (8s)
3. Publish to PyPI  [after tag]
4. Check AWS Credentials (3s)
5. Deploy Admin Lambda to QA (49s)
6. Deploy User Lambda to QA (41s)
                              Total: ~95s
```

### Production Pipeline

Test classes exist (`test_Deploy__*__Service__to__prod.py`) but **no CI trigger**. Production deployment requires manual execution or a new workflow.

---

## Pytest-Driven Deployment

Deployments are executed as pytest test methods. Each method performs one deployment step with assertions:

```python
class test_Deploy__Admin__Service__base:
    def test_1__check_stages(self):      # Verify stage name
    def test_2__upload_dependencies(self): # Upload Lambda layers to S3
    def test_4_create__lambda_function(self): # Create/update Lambda
    def test_5__update_lambda_runtime__to_3_13(self): # Set Python 3.13
    def test_6__invoke(self):            # Invoke Lambda, verify FastAPI
    def test_7__invoke__function_url(self): # Hit Function URL, verify health
```

Environment-specific subclasses override only the `stage` variable:

| Class | Stage | Trigger |
|-------|-------|---------|
| `test_Deploy__Admin__Service__to__dev` | `admin-dev` | CI on push to `dev` |
| `test_Deploy__Admin__Service__to__qa` | `admin-qa` | CI on push to `main` |
| `test_Deploy__Admin__Service__to__prod` | `admin-prod` | Manual only |

Same pattern for User Lambda (`user-dev`, `user-qa`, `user-prod`).

The composite GitHub Action (`.github/actions/aws__deploy__lambda/action.yml`) runs:
```bash
pytest -rs ./tests/deploy/{lambda_type}__Lambda/deploy_aws/test_Deploy__{lambda_type}__Service__to__{target}.py
```

---

## Lambda Functions

| Property | User Lambda | Admin Lambda |
|----------|-------------|--------------|
| Stage (dev) | `user-dev` | `admin-dev` |
| Stage (qa) | `user-qa` | `admin-qa` |
| Stage (prod) | `user-prod` | `admin-prod` |
| Runtime | Python 3.13 | Python 3.13 |
| Handler | Mangum adapter | Mangum adapter |
| Endpoint | Lambda Function URL | Lambda Function URL |
| Auth | None (global) | API key (global) |

**Function URL format:** `https://{id}.lambda-url.{region}.on.aws`

### Lambda Dependencies (uploaded as layers)

```
httpx==0.28.1
memory-fs==v0.40.0
mgraph-ai-service-cache-client==v0.33.0
mgraph-ai-service-cache==v0.14.0
osbot-fast-api-serverless==v1.33.0
```

---

## Environment Configuration

### GitHub Actions Secrets (11 total)

| Secret | Purpose | Used By |
|--------|---------|---------|
| `AWS_ACCESS_KEY_ID` | AWS auth | Deploy action |
| `AWS_SECRET_ACCESS_KEY` | AWS auth | Deploy action |
| `AWS_DEFAULT_REGION` | AWS region | Deploy action |
| `AWS_ACCOUNT_ID` | Account ID | Deploy action |
| `FAST_API__AUTH__API_KEY__NAME` | Admin API auth header name | Both Lambdas |
| `FAST_API__AUTH__API_KEY__VALUE` | Admin API auth header value | Both Lambdas |
| `AUTH__TARGET_SERVER__CACHE_SERVICE__BASE_URL` | Cache service URL | Both Lambdas |
| `CACHE__SERVICE__BUCKET_NAME` | S3 bucket for cache | Admin Lambda |
| `SGRAPH_SEND__ADMIN__BASE_URL` | Admin Lambda Function URL | User Lambda |
| `SGRAPH_SEND__ADMIN__API_KEY__NAME` | Admin auth header name | User Lambda |
| `SGRAPH_SEND__ADMIN__API_KEY__VALUE` | Admin auth header value | User Lambda |

### Environment Variable Mapping

The CI pipeline maps secrets to Lambda env vars during deployment. Both Lambdas receive `FAST_API__AUTH__API_KEY__NAME`, `FAST_API__AUTH__API_KEY__VALUE`, and `URL__TARGET_SERVER__CACHE_SERVICE`. The Admin Lambda additionally receives `CACHE__SERVICE__BUCKET_NAME`. The User Lambda additionally receives the three `SGRAPH_SEND__ADMIN__*` vars for inter-Lambda communication.

---

## AWS Resources

### Currently Provisioned

| Resource | Purpose | Status |
|----------|---------|--------|
| 2 Lambda functions (dev) | User + Admin | Live |
| 2 Lambda functions (qa) | User + Admin | Ready |
| 2 Lambda functions (prod) | User + Admin | Ready (no CI trigger) |
| S3 bucket (transfers) | `{account_id}--sgraph-send-transfers--{region}` | Active |
| S3 bucket (dependencies) | Lambda layer ZIPs | Active |
| S3 bucket (cache) | MGraph-AI cache service | Active |
| IAM roles | Lambda execution | Pre-existing |
| CloudWatch Logs | Auto-created per Lambda | Active (no retention policy) |

### Not Yet Provisioned

| Resource | Priority | Notes |
|----------|----------|-------|
| CloudWatch Alarms | P0 | Errors > 0, throttles > 0 |
| CloudFront distribution | P2 | CDN, WAF, caching |
| S3 lifecycle rules | P1 | TTL for transfer objects |
| WAF | P2 | Rate limiting, bot detection |
| Docker image / ECR | P2 | Container deployment target |

---

## Operational Status

### Working (GREEN)

- Automated CI/CD (test → tag → deploy) on every push
- Both Lambda functions deployed and serving traffic
- S3 storage backend operational
- Static UI assets served by both Lambdas
- Parallel Lambda deployments in CI
- Version tagging (minor on dev, major on main)
- PyPI publishing on main branch
- Graceful degradation when AWS creds absent

### Gaps (AMBER/RED)

| Priority | Gap | Risk |
|----------|-----|------|
| **P0** | No rate limiting | Abuse / cost spike |
| **P0** | CORS not locked down | Cross-origin abuse |
| **P0** | No CloudWatch alarms | Silent failures |
| **P1** | No S3 lifecycle rules | Unbounded storage growth |
| **P1** | No post-deploy smoke tests in CI | Broken deploys undetected |
| **P1** | No production CI trigger | Manual prod deployment |
| **P1** | No structured JSON logging | Hard to query logs |
| **P2** | No Dockerfile | Container targets blocked |
| **P2** | No LocalStack in CI | S3 integration untested |
| **P2** | No external uptime monitoring | Outages undetected |

---

## Deployment Targets (7 patterns, 4 groups)

| Group | Target | Status | Entry Point |
|-------|--------|--------|-------------|
| Lambda | AWS Lambda + Function URL | **Live** | Mangum adapter |
| Container | Docker | Planned (WS-11) | uvicorn |
| Container | ECS Fargate | Planned | Same Docker image |
| Container | GCP Cloud Run | Planned | Same Docker image |
| Server | EC2 | Planned | uvicorn + systemd |
| Server | AMI | Planned | Baked EC2 image |
| CLI | Command line | Planned | Direct Python entry |

**Principle:** Same artifact, many targets. Docker image is built once and reused for container/server targets. Lambda package is built once for all Lambda environments.

---

## Additional CI Pipelines

| Pipeline | Trigger | Purpose |
|----------|---------|---------|
| `jekyll-pages.yml` | Push to `dev` (path: `team/roles/journalist/site/**`) | Deploy Jekyll docs site to GitHub Pages |

---

## Document Lineage

This document consolidates content from:
- `team/roles/devops/reviews/26-02-12/v0.2.15__aws-deployment-documentation.md`
- `team/roles/devops/reviews/26-02-13/v0.2.24__status-report__post-launch.md`
- `team/roles/devops/reviews/26-02-14/v0.3.0__response-to-daily-brief__14-feb.md`
- `team/roles/devops/reviews/26-02-14/v0.2.41__fix__lambda-env-vars-for-deploy.md`
- `.github/workflows/ci-pipeline.yml`, `ci-pipeline__dev.yml`, `ci-pipeline__main.yml`
- `.github/actions/aws__deploy__lambda/action.yml`
