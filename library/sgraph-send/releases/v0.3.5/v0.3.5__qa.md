# SGraph Send v0.3.5 — QA

**Role:** Test strategy, coverage metrics, gap analysis, test patterns.

> For codebase structure and test file locations see [Dev](v0.3.5__dev.md). For deployment testing see [DevOps](v0.3.5__devops.md). For security test requirements see [AppSec](v0.3.5__appsec.md).

---

## Test Philosophy

**No mocks, no patches.** Every test uses real implementations with in-memory backends. The full stack starts in ~100ms.

| Principle | Implementation |
|-----------|---------------|
| Real implementations only | `Storage_FS__Memory` replaces S3, `IN_MEMORY` cache replaces remote |
| Same code path | Tests exercise production code, not stubs |
| LocalStack for S3 | The only acceptable "fake" (for integration tests) |
| Playwright for E2E | Browser tests with real encryption |
| Fast feedback | Full unit suite runs in seconds |

---

## Current Coverage (v0.3.5)

### Metrics

| Metric | Value |
|--------|-------|
| Backend unit tests | 111+ |
| Core transfer tests | 56 |
| Integration smoke tests | 11 |
| Admin UI tests (planned) | 46 |
| E2E browser tests | 0 |
| Overall QA score | **5.4/10** |

### Coverage by Area

| Area | Tests | Status |
|------|-------|--------|
| Transfer lifecycle (create → upload → complete → download) | 20+ | Strong |
| Transfer schemas (Type_Safe validation) | 10+ | Strong |
| Storage abstraction (Memory-FS) | 8+ | Good |
| Token management (create, lookup, use, revoke) | 10+ | Good |
| Analytics (middleware, pulse, cache) | 6+ | Good |
| Auth (happy path) | 4 | Partial |
| Static pages (user + admin) | 6+ | Good |
| Lambda handler | 2 | Basic |
| Version | 1 | Basic |
| Auth edge cases | 0 | **Gap** |
| S3 integration | 0 | **Gap** |
| Error paths | 2 | **Gap** |
| Concurrent operations | 0 | **Gap** |
| Browser E2E | 0 | **Gap** |
| Upload size limits | 0 | **Gap** |

---

## Test Structure

```
tests/
├── unit/                               # No mocks, in-memory stack
│   ├── lambda__user/
│   │   ├── service/
│   │   │   ├── test_Transfer__Service.py
│   │   │   └── test_Admin__Service__Client.py
│   │   ├── fast_api/
│   │   │   ├── test_Fast_API__SGraph__App__Send__User.py
│   │   │   └── routes/
│   │   │       ├── test_Routes__Transfers.py
│   │   │       └── test_Routes__Transfers__with_tokens.py
│   │   ├── schemas/
│   │   │   └── test_Schema__Transfer.py
│   │   ├── storage/
│   │   │   └── test_Send__Config.py
│   │   ├── lambda_function/
│   │   │   └── test_lambda_handler__user.py
│   │   └── static__user/
│   │       └── test__App_Send__UI__User__static_pages.py
│   │
│   ├── lambda__admin/
│   │   ├── service/
│   │   │   ├── test_Send__Cache__Client.py
│   │   │   ├── test_Service__Tokens.py
│   │   │   └── test_Service__Analytics__Pulse.py
│   │   ├── fast_api/
│   │   │   ├── test_Fast_API__SGraph__App__Send__Admin.py
│   │   │   └── routes/
│   │   │       ├── test_Routes__Tokens.py
│   │   │       └── test_Routes__Analytics.py
│   │   ├── lambda_function/
│   │   │   └── test_lambda_handler__admin.py
│   │   └── static__admin/
│   │       └── test__App_Send__UI__Admin__static_pages.py
│   │
│   └── utils/
│       └── test_Version.py
│
└── deploy/                             # Pytest-driven deployment
    ├── Admin__Lambda/deploy_aws/       # Admin Lambda deploy tests
    └── User__Lambda/deploy_aws/        # User Lambda deploy tests
```

### Test Fixtures

Both Lambdas have test fixture classes that set up the full in-memory stack:

- `Fast_API__Test_Objs__SGraph__App__Send__User` — User Lambda test context
- `Fast_API__Test_Objs__SGraph__App__Send__Admin` — Admin Lambda test context

These fixtures create real `Serverless__Fast_API` instances with `Storage_FS__Memory`, `Send__Cache__Client` (IN_MEMORY), and FastAPI `TestClient`.

---

## Test Matrix

### Storage Modes x Test Levels

| Test Level | Memory | S3 (LocalStack) | S3 (Real) |
|------------|--------|-----------------|-----------|
| Unit | **111+ tests** | — | — |
| Integration | — | 0 (planned) | — |
| Smoke | — | — | 11 (post-deploy) |
| E2E | — | — | 0 (planned) |

### Deployment Targets x Test Levels

| Target | Unit | Deploy | Smoke | E2E |
|--------|------|--------|-------|-----|
| Lambda (dev) | Passing | Passing | Partial | — |
| Lambda (qa) | Passing | Passing | — | — |
| Lambda (prod) | Passing | No CI | — | — |
| Docker | — | — | — | — |
| CLI | — | — | — | — |

---

## Critical Coverage Gaps

### P0 — Must Fix

| Gap | Tests Needed | Risk |
|-----|-------------|------|
| **Auth edge cases** | Wrong token, missing token, empty token, expired token, revoked token | Unauthorised uploads |
| **Error response consistency** | 404 variants, 400 validation, 500 handling | Inconsistent API behaviour |
| **Upload size enforcement** | File exceeding limit, zero-byte file | Storage exhaustion |

### P1 — Should Fix

| Gap | Tests Needed | Risk |
|-----|-------------|------|
| **S3 integration** | LocalStack: create/upload/download/delete with S3 backend | S3-specific bugs undetected |
| **Full transfer cycle** | Token create → transfer create → upload → complete → download (end-to-end) | Integration bugs |
| **Concurrent operations** | Parallel uploads to same transfer_id, parallel downloads | Race conditions |
| **Admin UI (QUnit)** | 29 unit tests, 4 integration tests for Web Components | Frontend regressions |

### P2 — Nice to Have

| Gap | Tests Needed | Risk |
|-----|-------------|------|
| **Browser E2E (Playwright)** | Encryption → upload → share URL → download → decrypt | Browser-specific bugs |
| **Smoke tests in CI** | Post-deploy health/auth/CORS/no-plaintext | Broken deploys |
| **Performance baseline** | Response time under load | Latency regressions |

---

## Admin UI Test Plan (v0.3.0)

46 new tests planned:

| Component | QUnit Unit | QUnit Integration | Smoke (pytest) | E2E (Playwright) |
|-----------|-----------|-------------------|----------------|-------------------|
| Token Manager | 12 | 3 | — | — |
| Analytics Dashboard | 6 | — | 2 | — |
| System Info | 4 | 1 | — | — |
| API Client | 7 | — | — | — |
| Admin Shell | — | — | — | 3 |
| Per-deploy | — | — | 10 | — |

### IFD Compliance Checklist

| Category | Check | Items |
|----------|-------|-------|
| Structure | Versioned paths, index.html entry, Web Components, no framework | 8 |
| Testing | QUnit unit, integration, smoke, E2E | 8 |
| Security | API key handling, XSS prevention, CORS, CSP | 5 |

---

## Smoke Test Specification

Post-deployment smoke tests (to be implemented in CI):

| Test | Endpoint | Expected |
|------|----------|----------|
| Health | `GET /info/health` | `{"status": "ok"}` |
| Auth enforced | `GET /tokens/list` (no auth) | 401 |
| Auth works | `GET /tokens/list` (with auth) | 200 |
| CORS headers | `OPTIONS /transfers/create` | Access-Control-* present |
| No plaintext | Upload encrypted → Download → Verify still encrypted | Pass |
| Static UI (user) | `GET /send` | 200 + redirect |
| Static UI (admin) | `GET /admin` | 200 + redirect |

---

## Document Lineage

This document consolidates content from:
- `team/roles/qa/ROLE.md`
- `team/roles/qa/reviews/26-02-13/v0.2.24__status-report__post-launch.md`
- `team/roles/qa/reviews/26-02-14/v0.3.0__response-to-daily-brief__14-feb.md`
- `team/roles/qa/reviews/26-02-10/v0.2.1__response-to-infrastructure-brief.md`
