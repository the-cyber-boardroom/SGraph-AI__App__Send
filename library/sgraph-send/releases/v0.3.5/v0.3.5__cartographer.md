# SGraph Send v0.3.5 — Cartographer

**Role:** System topology, data flows, component maps, Wardley evolution mapping.

> For API contracts and schemas see [Architect](v0.3.5__architect.md). For deployment infrastructure see [DevOps](v0.3.5__devops.md). For security boundaries see [AppSec](v0.3.5__appsec.md).

---

## System Topology

```
                    ┌──────────────────────────────────────────────────────────┐
                    │                        AWS                              │
                    │                                                          │
  Internet          │   ┌─────────────────────────────────────┐               │
  ─────────────────▶│   │  User Lambda (Function URL)         │               │
  (HTTPS)           │   │                                     │               │
                    │   │  FastAPI (Serverless__Fast_API)      │               │
                    │   │  ├─ Routes__Transfers (7 endpoints)  │               │
                    │   │  ├─ Routes__Info (/info/health)      │               │
                    │   │  ├─ Middleware__Analytics             │               │
                    │   │  ├─ Static UI (/send → v0.1.4)       │               │
                    │   │  │                                   │               │
                    │   │  │  Services:                        │               │
                    │   │  │  ├─ Transfer__Service             │               │
                    │   │  │  ├─ Send__Cache__Client           │               │
                    │   │  │  └─ Admin__Service__Client ──HTTP──┼──┐           │
                    │   │  │                                   │  │           │
                    │   │  └─ Storage_FS ──────────────────────┼──┼──▶ S3    │
                    │   └─────────────────────────────────────┘  │           │
                    │                                            │           │
                    │   ┌─────────────────────────────────────┐  │           │
                    │   │  Admin Lambda (Function URL)         │◀─┘           │
                    │   │                                     │               │
                    │   │  FastAPI (Serverless__Fast_API)      │               │
                    │   │  ├─ Routes__Tokens (6 endpoints)     │               │
                    │   │  ├─ Routes__Info (/info/health)      │               │
                    │   │  ├─ /health/pulse                    │               │
                    │   │  ├─ Static UI (/admin → v0.1.0)      │               │
                    │   │  │                                   │               │
                    │   │  │  Services:                        │               │
                    │   │  │  ├─ Service__Tokens               │               │
                    │   │  │  └─ Send__Cache__Client ──────────┼──▶ S3 Cache │
                    │   │  │                                   │               │
                    │   └─────────────────────────────────────┘               │
                    │                                                          │
                    └──────────────────────────────────────────────────────────┘
```

---

## Data Flows

### Upload Flow (Sender)

```
1. Browser: Generate AES-256-GCM key (Web Crypto API)
2. Browser: Encrypt file → ciphertext
3. Browser: POST /transfers/create {file_size_bytes, content_type_hint}
   └─ User Lambda: Validate token → Create transfer_id → Save meta.json → Return upload_url
4. Browser: POST /transfers/upload/{transfer_id} [encrypted bytes]
   └─ User Lambda: Save payload to Storage_FS
5. Browser: POST /transfers/complete/{transfer_id}
   └─ User Lambda: Update meta.json status → Return download_url + transparency
6. Browser: Construct share URL with key in hash-fragment
   └─ https://send.sgraph.ai/.../download.html#id={transfer_id}&key={base64url_key}
```

### Download Flow (Receiver)

```
1. Browser: Extract transfer_id and key from URL hash-fragment
2. Browser: GET /transfers/info/{transfer_id}
   └─ User Lambda: Return metadata (status, file_size, download_count)
3. Browser: GET /transfers/download/{transfer_id}
   └─ User Lambda: Read payload from Storage_FS → Return encrypted bytes
   └─ User Lambda: Increment download_count, log download event
4. Browser: Decrypt ciphertext using key (Web Crypto API)
5. Browser: Present decrypted file to user
```

### Token Validation Flow (Inter-Lambda)

```
1. User Lambda receives request with token
2. User Lambda: POST {admin_base_url}/tokens/use/{token_name}
   └─ Headers: {api_key_name: api_key_value}
3. Admin Lambda: Lookup token → Check status/limits → Record usage → Return result
4. User Lambda: Proceed or reject based on token validity
```

### Analytics Flow

```
1. Every HTTP request → Middleware__Analytics
2. Middleware extracts: path, method, status, duration, ip_hash, user_agent
3. Middleware classifies: file_upload | file_download | api_call | page_view
4. Middleware writes raw event to Cache Service (TEMPORAL strategy)
5. /health/pulse reads recent events → Computes active_requests, visitors, transfers
```

---

## Component Map

### User Lambda Components

```
Fast_API__SGraph__App__Send__User
├── Routes__Transfers          # 7 transfer endpoints
├── Routes__Info               # Health check (from osbot-fast-api)
├── Routes__Set_Cookie         # Cookie management (from osbot-fast-api)
├── Middleware__Analytics       # Request event recording
├── Transfer__Service          # Transfer lifecycle
│   └── Storage_FS             # Pluggable storage (Memory / S3)
├── Send__Cache__Client        # Analytics recording
│   └── Cache__Service__Client # MGraph-AI cache (IN_MEMORY)
├── Admin__Service__Client     # Token validation (HTTP to Admin Lambda)
├── Send__Config               # Storage backend factory
└── Static UI (/send)          # User workflow pages (IFD v0.1.4)
    ├── index.html             # Upload page
    ├── download.html          # Download page
    ├── js/i18n.js             # Internationalisation
    └── components/            # Web Components (send-upload, send-download)
```

### Admin Lambda Components

```
Fast_API__SGraph__App__Send__Admin
├── Routes__Tokens             # 6 token endpoints
├── Routes__Info               # Health check
├── Routes__Set_Cookie         # Cookie management
├── Service__Tokens            # Token lifecycle
│   └── Send__Cache__Client    # Token storage (KEY_BASED)
├── Service__Analytics__Pulse  # Traffic pulse computation
└── Static UI (/admin)         # Admin console (IFD v0.1.0)
    ├── index.html             # Main page
    ├── admin-shell.js         # Root component
    ├── js/admin-api.js        # API client
    └── components/            # Web Components (token-manager, analytics-dashboard)
```

---

## Storage Namespace Map

```
S3 Bucket: {account_id}--sgraph-send-transfers--{region}
│
├── transfers/
│   └── {transfer_id}/
│       ├── meta.json          # Transfer metadata
│       └── payload            # Encrypted file bytes
│
└── (Cache Service Bucket — separate)
    ├── analytics/
    │   └── data/temporal/{year}/{month}/{day}/{hour}/{event_id}.json
    ├── tokens/
    │   └── data/key_based/{token_hash}/metadata.json
    └── costs/                 # Planned
```

---

## Security Boundary Map

```
┌─────────────────────────────────────────────────────────────────────┐
│  CLIENT-ONLY ZONE (never leaves browser)                           │
│  ├── AES-256-GCM key generation                                    │
│  ├── File encryption / decryption                                  │
│  ├── Key export (base64url)                                        │
│  └── Hash-fragment parsing (key extraction)                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  PUBLIC ZONE (no auth required)                                    │
│  ├── GET /transfers/info/{id}         # Metadata only              │
│  ├── GET /transfers/download/{id}     # Encrypted bytes only       │
│  ├── GET /transfers/check-token/{name}                             │
│  ├── GET /info/health                                              │
│  └── Static UI pages                                               │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  SENDER ZONE (token auth required)                                 │
│  ├── POST /transfers/create                                        │
│  ├── POST /transfers/upload/{id}                                   │
│  ├── POST /transfers/complete/{id}                                 │
│  └── POST /transfers/validate-token/{name}                         │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  ADMIN ZONE (API key auth — separate Lambda)                       │
│  ├── POST /tokens/create                                           │
│  ├── GET  /tokens/lookup/{name}                                    │
│  ├── POST /tokens/use/{name}                                       │
│  ├── POST /tokens/revoke/{name}                                    │
│  ├── GET  /tokens/list                                             │
│  └── GET  /health/pulse                                            │
└─────────────────────────────────────────────────────────────────────┘
```

For threat analysis per boundary, see [AppSec](v0.3.5__appsec.md).

---

## Environment Separation

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│   DEV    │     │    QA    │     │   PROD   │
├──────────┤     ├──────────┤     ├──────────┤
│ user-dev │     │ user-qa  │     │ user-prod│
│ admin-dev│     │ admin-qa │     │admin-prod│
├──────────┤     ├──────────┤     ├──────────┤
│ Auto on  │     │ Auto on  │     │ Manual   │
│ dev push │     │ main push│     │ only     │
└──────────┘     └──────────┘     └──────────┘
```

Each environment has independent Lambda functions, Function URLs, and storage. No shared state between environments.

---

## Wardley Evolution Map

21 components mapped across the evolution axis:

```
Genesis          Custom-Built       Product         Commodity
   │                 │                 │                │
   │  Large file     │                 │                │
   │  transfer       │                 │                │
   │  ──────         │                 │                │
   │  Slack bot      │                 │                │
   │  ──────         │                 │                │
   │  Claude bot     │                 │                │
   │  ──────         │                 │                │
   │  Design agency  │                 │                │
   │  brief          │                 │                │
   │                 │                 │                │
   │                 │  Browser        │                │
   │                 │  encryption ────┼──▶ Handover    │
   │                 │  File transfer  │    to          │
   │                 │  flow ──────────┼──▶ Villager    │
   │                 │  S3 backend ────┼──▶             │
   │                 │  Token system ──┼──▶             │
   │                 │  Link sharing ──┼──▶             │
   │                 │                 │                │
   │                 │                 │  FastAPI       │
   │                 │                 │  osbot-utils   │
   │                 │                 │  Memory-FS     │
   │                 │                 │                │
   │                 │                 │                │  AWS Lambda
   │                 │                 │                │  S3
   │                 │                 │                │  Web Crypto
   │                 │                 │                │  Python
```

**Handover pipeline:** 5 Custom-Built components identified as ready for Villager team productisation. These components have working implementations, tests, and documentation but need hardening, monitoring, and operational maturity.

---

## Topology Drift from v0.1.2

| Change | v0.1.2 Design | v0.3.5 Actual |
|--------|--------------|---------------|
| API Gateway | Planned | Replaced by Lambda Function URLs |
| CloudFront | Planned | Not yet deployed |
| Pre-signed URLs | Planned for S3 | Server-proxy pattern instead |
| Admin UI | Not planned | Shipped (v0.1.0) |
| Inter-Lambda comm | Not planned | Implemented (Service Registry) |
| Cache Service | Custom design | MGraph-AI Cache Service adopted |
| Analytics | Not planned | Middleware + Cache Service |

---

## Document Lineage

This document consolidates content from:
- `team/roles/cartographer/v0.1.2/v0.1.2__system-landscape-map-revised.md`
- `team/roles/cartographer/reviews/26-02-14/v0.3.0__response-to-daily-brief__14-feb.md`
- `team/roles/cartographer/reviews/26-02-14/v0.3.2__action-plan__explorer-next-steps.md`
- `team/roles/cartographer/reviews/26-02-13/v0.2.24__status-report__post-launch.md`
