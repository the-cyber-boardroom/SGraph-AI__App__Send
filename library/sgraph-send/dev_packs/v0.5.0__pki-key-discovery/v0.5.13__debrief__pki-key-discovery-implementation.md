# Debrief: PKI Key Discovery — Dev Pack to Implementation

**Version:** v0.5.0 → v0.5.13
**Date range:** 21 February 2026 (build) — 22 February 2026 (documentation)
**Team:** Explorer (design + build), Villager (performance + hardening)
**Dev pack:** `library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/`

---

## Executive Summary

The PKI key discovery dev pack defined a **5-phase build plan** for browser-based public key management. **Phases 1-3 were fully implemented** in a single build session (21 Feb), delivering: a refactored admin console shell (IFD architecture), PKI component decomposition, 5 backend API endpoints, 4 key discovery UI components, and 10 new backend tests. Phases 4-5 (storage browser, QR codes) remain open.

**29 commits** across the full PKI arc (research → planning → implementation → fixes). 183 unit tests passing.

---

## The Dev Pack (Planning Phase)

**Location:** [`library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/)

| File | Purpose |
|------|---------|
| [`BRIEF.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/BRIEF.md) | Objective, constraints, 5-phase plan, files to read, human decisions, API contracts |
| [`architecture.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/architecture.md) | Shell layout, component inventory, event catalogue, data models |
| [`code-context.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/code-context.md) | Backend patterns (Routes, Service, Cache), frontend patterns |
| [`addenda/appsec.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/addenda/appsec.md) | 3 security items for the build |
| [`addenda/architect.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/addenda/architect.md) | Relevant architectural decisions |
| [`reference/ifd-architecture-summary.md`](../../../../../../library/sgraph-send/dev_packs/v0.5.0__pki-key-discovery/reference/ifd-architecture-summary.md) | IFD Issues-FS component pattern reference |

The pack was created as a **self-contained briefing for a fresh Claude Code session** — designed to be the single read before starting implementation. 10 human decisions were pre-resolved (case-insensitive codes, admin-only registry, no challenge-response, IFD architecture, v0.1.3 versioning, etc.).

---

## What Was Built (Implementation Phase)

### Phase 1: IFD Foundation (commit `d5b898e`)

Admin console v0.1.3 — full IFD architecture rewrite:

| Component | Description |
|-----------|-------------|
| `admin-shell` | Light DOM shell with Router, left-nav, EventBus |
| `EventBus` | Global event system for component communication |
| `Router` | Hash-based navigation with `navigated` events |
| `messages-panel` | Debug panel: UI messages stream |
| `events-viewer` | Debug panel: EventBus event log |
| `api-logger` | Debug panel: API call/response inspector |

Migration of 5 existing components (token-manager, system-info, cache-browser, analytics-dashboard, metrics-dashboard) from Shadow DOM to Light DOM with lazy loading.

### Phase 2: PKI Component Refactor (commit `eb17638`)

Split the **1,831-line monolithic `pki-manager.js`** into 4 focused modules:

| Module | Lines | Responsibility |
|--------|-------|----------------|
| `pki-common.js` | Shared | IndexedDB singleton, Web Crypto helpers, PEM import/export, fingerprint, hybrid encrypt/decrypt, base64, CSS, toast mixin |
| `pki-keys.js` | Component | Key generation, list, delete, copy public key |
| `pki-encrypt.js` | Component | Encrypt & sign, decrypt & verify, round-trip test |
| `pki-contacts.js` | Component | Contact import, list, view key, delete |

Architecture: Light DOM, IIFE pattern, lazy loading, `PKIDatabase` singleton shared across components with `onChange` notifications.

### Phase 3: Key Discovery API + UI (commit `f32dd03`)

**Backend (5 endpoints on Admin Lambda):**

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/keys/publish` | POST | Publish public key, get `XX-XXXX` lookup code |
| `/keys/lookup/{code}` | GET | Case-insensitive key lookup |
| `/keys/unpublish/{code}` | DELETE | Soft-delete with transparency log entry |
| `/keys/list` | GET | List all active published keys |
| `/keys/log` | GET | Append-only transparency log with hash chain |

**Implementation files:**
- [`Service__Keys`](../../../../../../sgraph_ai_app_send/lambda__admin/service/Service__Keys.py) — key registry business logic
- [`Routes__Keys`](../../../../../../sgraph_ai_app_send/lambda__admin/fast_api/routes/Routes__Keys.py) — FastAPI route handlers
- [`Schema__Key__Publish__Request`](../../../../../../sgraph_ai_app_send/lambda__admin/schemas/Schema__Key__Publish__Request.py) — request schema (Type_Safe)
- `Send__Cache__Client` extended with `key_registry` namespace

**Frontend (4 new key discovery components):**

| Component | UI Function |
|-----------|-------------|
| `<key-publish>` | Select local key pair, publish to registry |
| `<key-lookup>` | Enter code, fetch key, import to contacts |
| `<key-registry>` | Browse all published keys, unpublish action |
| `<key-log>` | View transparency log with chain verification |

**10 new tests** for `Service__Keys`: publish, duplicate rejection, lookup, case-insensitive lookup, lookup not found, unpublish, unpublish not found, list keys, transparency log, empty PEM rejection.

### Post-build fix (commit `bfa5cdd`)

Fixed missing `exportSigningKeyPEM` in `pki-common.js` — the key-publish component called a function that hadn't been extracted during the refactor.

---

## Phase Status

| Phase | Description | Status | Commit(s) |
|-------|-------------|--------|-----------|
| Phase 1 | IFD Foundation (v0.1.3 shell + EventBus + debug panels) | **Done** | `d5b898e` |
| Phase 2 | PKI Component Refactor (split 1831-line monolith) | **Done** | `eb17638` |
| Phase 3 | Backend API + Key Discovery Components | **Done** | `f32dd03`, `bfa5cdd` |
| Phase 4 | Storage Browser | **Open** | — |
| Phase 5 | QR Codes + Polish | **Open** | — |

---

## Full File Inventory

### Backend (Python)

| File | Type |
|------|------|
| `sgraph_ai_app_send/lambda__admin/service/Service__Keys.py` | Service |
| `sgraph_ai_app_send/lambda__admin/fast_api/routes/Routes__Keys.py` | Routes |
| `sgraph_ai_app_send/lambda__admin/schemas/Schema__Key__Publish__Request.py` | Schema |
| `tests/unit/lambda__admin/service/test_Service__Keys.py` | Tests (10) |

### Frontend (JavaScript — all in `sgraph_ai_app_send__ui__admin/v0/v0.1/`)

| File | Version | Purpose |
|------|---------|---------|
| `v0.1.3/index.html` | v0.1.3 | Shell entry point |
| `v0.1.3/js/pki-common.js` | v0.1.3 | Shared PKI utilities |
| `v0.1.3/js/admin-api-keys.js` | v0.1.3 | Keys API client |
| `v0.1.3/components/pki-keys/pki-keys.js` | v0.1.3 | Key management |
| `v0.1.3/components/pki-encrypt/pki-encrypt.js` | v0.1.3 | Encrypt/decrypt |
| `v0.1.3/components/pki-contacts/pki-contacts.js` | v0.1.3 | Contact management |
| `v0.1.3/components/key-publish/key-publish.js` | v0.1.3 | Publish key to registry |
| `v0.1.3/components/key-lookup/key-lookup.js` | v0.1.3 | Look up key by code |
| `v0.1.3/components/key-registry/key-registry.js` | v0.1.3 | Browse published keys |
| `v0.1.3/components/key-log/key-log.js` | v0.1.3 | Transparency log viewer |

### Previous PKI work (v0.1.2 — the monolith that was refactored)

| File | Version | Status |
|------|---------|--------|
| `v0.1.2/pki.html` | v0.1.2 | Standalone page (superseded by shell integration) |
| `v0.1.2/components/pki-manager/pki-manager.js` | v0.1.2 | 1831-line monolith (superseded by 3 components) |

---

## Security Decisions Applied

From the AppSec addendum and revised review:

| Item | Resolution |
|------|-----------|
| Case-insensitive lookup codes | Normalised to lowercase at API boundary, displayed uppercase |
| Rate limiting on publish | Deferred — admin-only access mitigates flood risk |
| Transparency log integrity | Phase 1: append-only with hash chain. Future: external witness |
| Challenge-response for publish | Not for now — high-trust MVP stage |
| Registry access | Admin-only (behind cookie auth) |

---

## Prior Art — The PKI Journey

The key discovery build was the third phase of a broader PKI arc:

| Date | Milestone | Key Commits |
|------|-----------|-------------|
| 20 Feb | PKI research + LLM integration | `3ad5806` |
| 20 Feb | PKI messaging MVP — admin page v0.1.2, monolithic `pki-manager.js` | `3e63e2d`, `6cafc67`, `c4d17c7`, `1e07934` |
| 20 Feb | Architecture briefing + milestone documentation | `6605665`, `cbddb91`, `5992cb7` |
| 21 Feb | Brief processing — key discovery, chain of trust, secure pod | `91f2c21` |
| 21 Feb | Dev pack creation | `4dea4a5` |
| 21 Feb | Phase 1: IFD foundation (v0.1.3 admin shell) | `d5b898e` |
| 21 Feb | Phase 2: PKI component refactor | `eb17638` |
| 21 Feb | Phase 3: Key discovery API + UI | `f32dd03`, `bfa5cdd` |

**Related debriefs:**
- [PKI and LLM Integration Research](../../../debriefs/02/20/v0.4.17__debrief__pki-and-llm-integration-research.md)
- [PKI Messaging MVP](../../../debriefs/02/20/v0.4.25__debrief__pki-messaging-mvp.md)
- [Briefs 21 Feb — PKI Architecture](../../../debriefs/02/21/v0.5.0__debrief__briefs-21-feb-pki-architecture.md)
- [Revised Plans — Human Decisions](../../../debriefs/02/21/v0.5.0__debrief__revised-plans-21-feb.md)

**Related role reviews:**
- [Dev Implementation Plan (Revised)](../../../../../../team/roles/dev/reviews/26-02-21/v0.5.0__implementation-plan__key-discovery-and-registry-revised.md)
- [AppSec Read Now](../../../../../../team/roles/appsec/reviews/26-02-21/v0.5.0__appsec__read-now.md)
- [AppSec Revised Review](../../../../../../team/roles/appsec/reviews/26-02-21/v0.5.0__review__pki-architecture-security-revised.md)
- [Architect Briefing: PKI Messaging](../../../../../../team/roles/architect/reviews/26-02-20/v0.4.25__briefing__pki-messaging-architecture.md)

---

## What Remains Open

| Item | Phase | Owner | Notes |
|------|-------|-------|-------|
| Storage browser (Memory-FS content browser) | Phase 4 | Explorer | 3 API endpoints + UI component |
| QR code generation for lookup codes | Phase 5 | Explorer | Navigation polish |
| Equivocation detection (external witness) | Future | Architect + AppSec | AD-25 |
| Challenge-response for publish | Future | AppSec | Triggered when auth model widens |
| Chain of Trust graph service | Future | Architect | AD-28, AD-29 |
| Secure Pod | Future | Architect | Client-side pod rejected for investor use; server pod scoped at ~6-7 days |

---

## Test Coverage

- **10 tests** for `Service__Keys` (publish, duplicate, lookup, case-insensitive, not found, unpublish, list, log, empty PEM)
- **183 total unit tests** passing (full suite as of v0.5.13)
- **No E2E tests yet** for the key discovery UI flow (Playwright)

---

*Debrief complete. PKI key discovery: dev pack designed (21 Feb), Phases 1-3 implemented (21 Feb), Phases 4-5 open. All links are relative.*
